<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>Landed Cost Calculator & Pricing</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- GSAP Animation Library - Liquid Glass Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/CustomEase.min.js"></script>
    <!-- Three.js for WebGL Glass Effects (optional) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Lottie for Vector Animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <!-- Jspreadsheet CE (jExcel) for Excel-like spreadsheet -->
    <script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
    <script src="https://jsuites.net/v4/jsuites.js"></script>
    <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
    <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <!-- SheetJS for XLSX parsing (AI Upload) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#1e293b' }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-app: #fafaf9;
            --bg-card: #fdfdfc;
            --border: #e7e5e4;
            --text-primary: #1c1917;
            --text-secondary: #78716c;
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.12);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 4px 6px rgba(0, 0, 0, 0.02), 0 12px 24px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 20px rgba(0, 0, 0, 0.04), 0 24px 48px rgba(0, 0, 0, 0.06);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.06), 0 20px 40px rgba(0, 0, 0, 0.08), 0 40px 80px rgba(0, 0, 0, 0.04);
            --gradient-shine: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0) 50%);
        }

        .dark {
            --bg-app: #0f172a;
            --bg-card: #1e293b;
            --border: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #60a5fa;
            --accent-glow: rgba(96, 165, 250, 0.2);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.3), 0 8px 16px rgba(0, 0, 0, 0.2), 0 16px 32px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.4), 0 16px 32px rgba(0, 0, 0, 0.3), 0 32px 64px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.5), 0 24px 48px rgba(0, 0, 0, 0.4), 0 48px 96px rgba(0, 0, 0, 0.2);
            --gradient-shine: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0) 50%);
        }

        /* Mobile Stability & Touch Fixes */
        html,
        body {
            overflow-x: hidden;
            position: relative;
            width: 100%;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
        }

        /* Prevent iOS zoom & improve tap areas */
        input,
        select,
        textarea {
            font-size: 16px !important;
            min-height: 44px;
        }

        /* Remove tap highlight on mobile */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        @keyframes aurora {
            0% {
                transform: translate(0, 0) rotate(0deg);
                opacity: 0.4;
            }

            33% {
                transform: translate(2%, 2%) rotate(1deg);
                opacity: 0.6;
            }

            66% {
                transform: translate(-2%, 1%) rotate(-1deg);
                opacity: 0.5;
            }

            100% {
                transform: translate(0, 0) rotate(0deg);
                opacity: 0.4;
            }
        }

        body {
            background-color: var(--bg-app);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
            overflow-x: hidden;
        }

        /* iOS 25 Aurora Background "Living Light" */
        body::before {
            content: '';
            position: fixed;
            inset: -40%;
            z-index: -1;
            background:
                radial-gradient(circle at 15% 15%, rgba(99, 102, 241, 0.12), transparent 40%),
                radial-gradient(circle at 85% 15%, rgba(168, 85, 247, 0.12), transparent 40%),
                radial-gradient(circle at 85% 85%, rgba(59, 130, 246, 0.12), transparent 40%),
                radial-gradient(circle at 15% 85%, rgba(244, 63, 94, 0.08), transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.06), transparent 50%);
            filter: blur(80px);
            animation: aurora 20s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            will-change: transform, opacity;
            transform: translateZ(0);
            /* Hardware accelerate */
        }

        .glass-card {
            /* Apple VisionOS "Platter" Material - Premium 3D */
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.92) 0%, rgba(248, 250, 252, 0.85) 100%);
            /* Physical border containment: Lighter top border for "catch light" */
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow:
                /* Deep shadow for lift */
                0 16px 40px -8px rgba(0, 0, 0, 0.08),
                /* THE "EDGE STROKE": Bright Top Catch-Light */
                inset 0 1px 0 0 rgba(255, 255, 255, 1),
                /* Subtle inner bevel */
                inset 0 0 0 1px rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            backdrop-filter: blur(60px) saturate(200%);
            -webkit-backdrop-filter: blur(60px) saturate(200%);
            /* Removed overflow:hidden to allow tooltips/popups to overflow card boundaries */
        }

        .dark .glass-card {
            /* "OLED Pro" Material - Deep & Crisp */
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
            /* Ultra-thin crisp border */
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow:
                /* Deep ambient depth */
                0 20px 48px -12px rgba(0, 0, 0, 0.8),
                /* SHARP Top Highlight (The "Shine") */
                inset 0 1px 0 0 rgba(255, 255, 255, 0.12),
                /* Subtle inner gloss */
                inset 0 0 0 1px rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
        }

        /* Top shine overlay for extra glass effect - Toned Down */
        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(180deg,
                    rgba(255, 255, 255, 0.15) 0%,
                    rgba(255, 255, 255, 0.02) 100%);
            border-radius: inherit;
            pointer-events: none;
            z-index: 1;
        }

        /* Input Cursor Fix - Lift inputs above glass-card overlay */
        input,
        textarea,
        select {
            position: relative;
            z-index: 10;
            /* Above glass-card::before which has z-index:1 */
            vertical-align: middle;
            text-align: left;
        }

        /* Mobile input sizing */
        @media screen and (max-width: 768px) {

            input,
            select,
            textarea {
                font-size: 16px !important;
                /* Prevent zoom */
            }
        }

        .dark .glass-card::before {
            background: linear-gradient(180deg,
                    rgba(255, 255, 255, 0.06) 0%,
                    rgba(255, 255, 255, 0.02) 50%,
                    transparent 100%);
        }

        .glass-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(125deg, rgba(255, 255, 255, 0.3) 0%, transparent 40%, transparent 100%);
            z-index: 10;
            pointer-events: none;
        }

        .dark .glass-card::before {
            background: linear-gradient(125deg, rgba(255, 255, 255, 0.03) 0%, transparent 40%, transparent 100%);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 245, 245, 0.9) 100%);
            box-shadow:
                0 20px 48px -12px rgba(0, 0, 0, 0.12),
                inset 0 1px 0 0 rgba(255, 255, 255, 1),
                inset 0 2px 4px 0 rgba(255, 255, 255, 0.4);
        }

        .dark .glass-card:hover {
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
            box-shadow:
                0 8px 32px -4px rgba(0, 0, 0, 0.5),
                0 20px 64px -8px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.22),
                inset 0 2px 8px 0 rgba(255, 255, 255, 0.08);
        }

        .glass-card-static {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.75) 100%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: var(--shadow);
            backdrop-filter: blur(16px) saturate(150%);
            -webkit-backdrop-filter: blur(16px) saturate(150%);
        }

        .dark .glass-card-static {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(30, 41, 59, 0.65) 100%);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .glass-input {
            /* Unified Premium Input - Light Mode */
            background: linear-gradient(145deg, rgba(241, 245, 249, 0.95) 0%, rgba(226, 232, 240, 0.85) 100%);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                inset 0 1px 3px rgba(0, 0, 0, 0.06),
                0 1px 0 rgba(255, 255, 255, 0.7);
            /* Removed backdrop-filter to prevent iOS selection handle displacement artifacts */
            border-radius: 0.75rem;
            font-weight: 600;
        }

        .dark .glass-input {
            /* Unified Premium Input - Dark Mode */
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow:
                inset 0 2px 4px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            color: white;
        }

        .glass-input:hover {
            border-color: rgba(99, 102, 241, 0.4);
            box-shadow:
                inset 0 1px 2px rgba(0, 0, 0, 0.04),
                0 0 0 3px rgba(99, 102, 241, 0.08),
                0 4px 12px rgba(99, 102, 241, 0.06);
        }

        .dark .glass-input:hover {
            border-color: rgba(129, 140, 248, 0.4);
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 1) 100%);
            box-shadow:
                inset 0 1px 2px rgba(0, 0, 0, 0.3),
                0 0 0 3px rgba(129, 140, 248, 0.15),
                0 4px 12px rgba(129, 140, 248, 0.1);
        }

        .glass-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow:
                inset 0 1px 2px rgba(0, 0, 0, 0.04),
                0 0 0 4px var(--accent-glow),
                0 0 20px rgba(99, 102, 241, 0.1);
        }

        .dark .glass-input:focus {
            box-shadow:
                inset 0 1px 2px rgba(0, 0, 0, 0.3),
                0 0 0 4px rgba(129, 140, 248, 0.25),
                0 0 24px rgba(129, 140, 248, 0.15);
        }

        .glass-input::placeholder {
            color: rgba(107, 114, 128, 0.6);
            font-weight: 500;
        }

        .dark .glass-input::placeholder {
            color: rgba(156, 163, 175, 0.5);
        }

        .btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--gradient-shine);
            pointer-events: none;
        }

        .btn:hover {
            transform: translateY(-1px);
            filter: brightness(1.05);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0) scale(0.98);
        }

        .btn:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .btn:active {
            transform: translateY(0);
        }

        .metric-row {
            transition: all 0.2s ease;
        }

        .tab-button {
            transition: all 0.2s ease;
        }

        .tab-button:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .safe-area-bottom {
            padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
        }

        .mobile-sticky-bar {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            box-shadow: 0 -4px 24px -6px rgba(0, 0, 0, 0.1);
        }

        .dark .mobile-sticky-bar {
            background: rgba(15, 23, 42, 0.98);
            box-shadow: 0 -4px 24px -6px rgba(0, 0, 0, 0.4);
        }

        /* Mobile touch targets */
        @media (max-width: 767px) {
            .glass-input {
                min-height: 44px;
                font-size: 16px !important;
                /* Prevent iOS zoom */
            }

            .btn {
                min-height: 44px;
                min-width: 44px;
            }

            .glass-card {
                border-radius: 1rem;
            }

            /* Hero input styling for mobile */
            .mobile-hero-input {
                font-size: 1.25rem !important;
                font-weight: 700 !important;
                padding: 1rem !important;
            }
        }

        @media (min-width: 768px) {
            .mobile-only {
                display: none !important;
            }
        }

        /* Mobile Polish - Apple/Google Style */
        @media (max-width: 767px) {
            body {
                background: var(--bg-app);
                /* Cleaner background on mobile */
            }

            .glass-card {
                border-radius: 1.25rem;
                /* Softer corners */
                box-shadow: 0 4px 20px -8px rgba(0, 0, 0, 0.05);
                /* Softer shadow */
                border: 1px solid rgba(0, 0, 0, 0.03);
                /* Subtler border */
            }

            .dark .glass-card {
                border: 1px solid rgba(255, 255, 255, 0.05);
                background: #1e293b;
                /* Solid card bg for better contrast */
            }

            /* Hero Input for Mobile */
            .mobile-hero-input input {
                font-size: 1.25rem !important;
                padding: 0.75rem !important;
                text-align: center;
                font-weight: 800 !important;
                letter-spacing: -0.02em;
            }

            /* Better spacing */
            .space-y-5> :not([hidden])~ :not([hidden]) {
                margin-top: 1rem;
            }

            /* Mobile Sticky Bar Polish */
            .mobile-sticky-bar {
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(16px) saturate(180%);
                border-top: 1px solid rgba(0, 0, 0, 0.05);
            }

            .dark .mobile-sticky-bar {
                background: rgba(15, 23, 42, 0.9);
                border-top: 1px solid rgba(255, 255, 255, 0.05);
            }
        }

        /* Premium Desktop Shadows */
        @media (min-width: 768px) {
            .glass-card {
                box-shadow:
                    0 1px 2px rgba(0, 0, 0, 0.05),
                    0 4px 12px rgba(0, 0, 0, 0.08),
                    0 24px 48px rgba(0, 0, 0, 0.03);
            }

            .dark .glass-card {
                box-shadow:
                    0 1px 2px rgba(0, 0, 0, 0.2),
                    0 4px 12px rgba(0, 0, 0, 0.3),
                    0 24px 48px rgba(0, 0, 0, 0.1);
            }
        }

        /* ========== JSPREADSHEET PREMIUM STYLING ========== */
        .jexcel-custom {
            --jexcel-border: #e5e7eb;
            --jexcel-bg: #ffffff;
            --jexcel-header-bg: linear-gradient(180deg, #f9fafb 0%, #f3f4f6 100%);
            --jexcel-row-odd: #fafafa;
            --jexcel-row-even: #ffffff;
            --jexcel-hover: rgba(99, 102, 241, 0.08);
            --jexcel-select: rgba(99, 102, 241, 0.15);
            --jexcel-accent: #6366f1;
            --jexcel-dim-accent: #06b6d4;
        }

        .dark .jexcel-custom {
            --jexcel-border: #374151;
            --jexcel-bg: #111827;
            --jexcel-header-bg: linear-gradient(180deg, #1f2937 0%, #111827 100%);
            --jexcel-row-odd: #1f2937;
            --jexcel-row-even: #111827;
            --jexcel-hover: rgba(99, 102, 241, 0.15);
            --jexcel-select: rgba(99, 102, 241, 0.25);
        }

        /* Custom Thin Scrollbar */
        .jexcel-custom-scroll::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        .jexcel-custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .jexcel-custom-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.3);
            border-radius: 6px;
            border: 3px solid transparent;
            /* Creates padding effect */
            background-clip: content-box;
        }

        .dark .jexcel-custom-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .jexcel-custom-scroll::-webkit-scrollbar-thumb:hover {
            background-color: rgba(156, 163, 175, 0.5);
        }

        .jexcel-custom-scroll::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* Apple-style Scrollbar for Results */
        .apple-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .apple-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .apple-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.4);
            border-radius: 100px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .apple-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: rgba(156, 163, 175, 0.6);
        }

        .dark .apple-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .dark .apple-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }

        .jexcel-custom .jexcel_container {
            font-family: 'Inter', sans-serif !important;
            border-radius: 0 !important;
            /* Let parent handle radius */
            overflow: hidden !important;
            border: none !important;
        }

        .jexcel_about {
            display: none !important;
        }

        /* Remove branding/globe */

        .jexcel-custom .jexcel {
            font-family: 'Inter', sans-serif !important;
            font-size: 12px !important;
            border-radius: 16px !important;
            border: none !important;
            background: var(--jexcel-bg) !important;
        }

        /* Header cells - more premium, STICKY with solid bg */
        .jexcel-custom .jexcel thead td {
            background: #f3f4f6 !important;
            font-weight: 800 !important;
            font-size: 10px !important;
            text-transform: uppercase !important;
            letter-spacing: 0.08em !important;
            color: #6b7280 !important;
            padding: 14px 10px !important;
            border: none !important;
            border-bottom: 1px solid var(--jexcel-border) !important;
            border-right: 1px solid rgba(0, 0, 0, 0.03) !important;
            position: sticky !important;
            top: 0 !important;
            z-index: 10 !important;
        }

        .dark .jexcel-custom .jexcel thead td {
            background: #1f2937 !important;
            color: #9ca3af !important;
            border-right-color: rgba(255, 255, 255, 0.03) !important;
        }

        /* Body cells */
        .jexcel-custom .jexcel tbody td {
            padding: 10px 10px !important;
            border: none !important;
            border-bottom: 1px solid var(--jexcel-border) !important;
            border-right: 1px solid rgba(0, 0, 0, 0.02) !important;
            font-weight: 500 !important;
            font-size: 13px !important;
            transition: background 0.15s ease, color 0.15s ease !important;
        }

        .dark .jexcel-custom .jexcel tbody td {
            color: #e5e7eb !important;
            border-right-color: rgba(255, 255, 255, 0.02) !important;
        }

        /* Alternating rows */
        .jexcel-custom .jexcel tbody tr:nth-child(odd) td {
            background: var(--jexcel-row-odd) !important;
        }

        .jexcel-custom .jexcel tbody tr:nth-child(even) td {
            background: var(--jexcel-row-even) !important;
        }

        /* Hover row */
        .jexcel-custom .jexcel tbody tr:hover td {
            background: var(--jexcel-hover) !important;
        }

        /* Selected cells */
        .jexcel-custom .jexcel tbody td.highlight {
            background: var(--jexcel-select) !important;
            box-shadow: inset 0 0 0 2px var(--jexcel-accent) !important;
            border-radius: 4px !important;
        }

        /* Row numbers */
        .jexcel-custom .jexcel tbody td:first-child {
            background: linear-gradient(90deg, #f3f4f6, #f9fafb) !important;
            color: #9ca3af !important;
            font-weight: 700 !important;
            font-size: 10px !important;
            text-align: center !important;
            border-right: 1px solid var(--jexcel-border) !important;
            width: 36px !important;
            min-width: 36px !important;
        }

        .dark .jexcel-custom .jexcel tbody td:first-child {
            background: linear-gradient(90deg, #1f2937, #111827) !important;
            color: #6b7280 !important;
        }

        /* Price column (A) - Indigo accent */
        .jexcel-custom .jexcel tbody td[data-x="0"] {
            font-weight: 700 !important;
            color: #4f46e5 !important;
            font-size: 14px !important;
        }

        .dark .jexcel-custom .jexcel tbody td[data-x="0"] {
            color: #a5b4fc !important;
        }

        /* Dimension columns (B, C, D = L, W, H) - Cyan accent */
        .jexcel-custom .jexcel thead td[data-x="1"],
        .jexcel-custom .jexcel thead td[data-x="2"],
        .jexcel-custom .jexcel thead td[data-x="3"] {
            color: #0891b2 !important;
            background: linear-gradient(180deg, #ecfeff 0%, #cffafe 100%) !important;
        }

        .dark .jexcel-custom .jexcel thead td[data-x="1"],
        .dark .jexcel-custom .jexcel thead td[data-x="2"],
        .dark .jexcel-custom .jexcel thead td[data-x="3"] {
            color: #22d3ee !important;
            background: linear-gradient(180deg, rgba(34, 211, 238, 0.15) 0%, rgba(8, 145, 178, 0.2) 100%) !important;
        }

        .jexcel-custom .jexcel tbody td[data-x="1"],
        .jexcel-custom .jexcel tbody td[data-x="2"],
        .jexcel-custom .jexcel tbody td[data-x="3"] {
            color: #0e7490 !important;
            font-weight: 600 !important;
            background: rgba(6, 182, 212, 0.03) !important;
        }

        .dark .jexcel-custom .jexcel tbody td[data-x="1"],
        .dark .jexcel-custom .jexcel tbody td[data-x="2"],
        .dark .jexcel-custom .jexcel tbody td[data-x="3"] {
            color: #67e8f9 !important;
            background: rgba(6, 182, 212, 0.08) !important;
        }

        /* Fill handle - larger and more visible */
        .jexcel-custom .jexcel_corner {
            background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
            border: 2px solid white !important;
            border-radius: 3px !important;
            width: 10px !important;
            height: 10px !important;
            cursor: crosshair !important;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4) !important;
        }

        /* Editor input - more polished */
        .jexcel-custom .jexcel_editor {
            font-family: 'Inter', sans-serif !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            padding: 8px 10px !important;
            border: none !important;
            border-radius: 8px !important;
            outline: none !important;
            box-shadow: 0 0 0 3px var(--jexcel-accent), 0 4px 20px rgba(99, 102, 241, 0.25) !important;
            background: white !important;
        }

        .dark .jexcel-custom .jexcel_editor {
            background: #1f2937 !important;
            color: #f3f4f6 !important;
        }

        /* Context menu - Apple style */
        .jexcel-custom .jcontextmenu {
            font-family: 'Inter', sans-serif !important;
            border-radius: 12px !important;
            padding: 6px !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(0, 0, 0, 0.05) !important;
            border: none !important;
            backdrop-filter: blur(20px) !important;
            background: rgba(255, 255, 255, 0.95) !important;
        }

        .jexcel-custom .jcontextmenu>div {
            padding: 8px 14px !important;
            border-radius: 6px !important;
            font-size: 13px !important;
            font-weight: 500 !important;
        }

        .jexcel-custom .jcontextmenu>div:hover {
            background: var(--jexcel-accent) !important;
            color: white !important;
        }

        .dark .jexcel-custom .jcontextmenu {
            background: rgba(31, 41, 55, 0.95) !important;
            color: #f3f4f6 !important;
        }

        /* Scrollbar - sleek */
        .jexcel-custom .jexcel_content::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .jexcel-custom .jexcel_content::-webkit-scrollbar-track {
            background: transparent;
        }

        .jexcel-custom .jexcel_content::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .jexcel-custom .jexcel_content::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .dark .jexcel-custom .jexcel_content::-webkit-scrollbar-thumb {
            background: #374151;
        }

        .dark .jexcel-custom .jexcel_content::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
    </style>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback, memo } = React;

        // ========== UTILITIES ==========
        const CONTAINER_CBM = { "40HQ": 76, "40GP": 67.5, "20GP": 33.2 };
        const VAT_RATE = 0.20;
        const VOL_DIVISOR = 5000;
        const DX_SURCHARGE_THRESHOLD = 24.99;

        const DEFAULT_COURIER_RULES = [
            { id: 'evri_packet', name: 'Evri / Packet', maxL: 120, maxGirth: 225, maxWeight: 2, maxVol: 40, price: 1.85, days: '2-3', logo: 'Logos/evri_logo_png.png' },
            { id: 'evri_packet_large', name: 'Evri / Packet over 40L', maxL: 120, maxGirth: 225, maxWeight: 2, minVol: 40, price: 2.25, days: '2-3', logo: 'Logos/evri_logo_png.png' },
            { id: 'evri_parcel', name: 'Evri / Parcel', maxL: 120, maxGirth: 225, maxWeight: 15, price: 2.33, days: '2-3', logo: 'Logos/evri_logo_png.png' },
            { id: 'yodel_express', name: 'Yodel / Express', maxL: 90, maxVolCm3: 110000, maxWeight: 17, price: 2.30, days: '1-2', logo: 'Logos/Yodel_logo.png' },
            { id: 'dpd_48', name: 'DPD / 48 Hour', maxL: 120, maxW: 70, maxH: 60, maxWeight: 30, price: 4.51, days: '1-2', logo: 'Logos/DPD_logo(red)2015.png' },
            { id: 'pf_48', name: 'Parcelforce / 48 Hour', maxL: 150, maxGirth: 300, maxWeight: 30, price: 5.40, extraPerParcel: 2.70, type: 'multi', days: '1-2', logo: 'Logos/Parcel Force Logo.png' },
            { id: 'evri_ll', name: 'Evri / L&L', maxL: 180, maxGirth: 380, maxWeight: 30, price: 8.00, days: '3-5', logo: 'Logos/evri_logo_png.png' },
            { id: 'dx_std', name: 'DX / Standard', maxL: 150, maxWeight: 30, price: 5.40, extraPerParcel: 3.30, type: 'dx_std', days: '2-3', logo: 'Logos/DX Standard Lengths.png' },
            { id: 'dx_len', name: 'DX / Lengths', maxL: 200, maxWeight: 30, price: 12.21, type: 'dx_len', days: '2-3', logo: 'Logos/DX Standard Lengths.png' }
        ];

        const num = (n) => { const x = typeof n === "string" ? parseFloat(n) : n; return Number.isFinite(x) ? x : 0; };
        const fmt = (n, dp = 2) => Number(n || 0).toLocaleString("en-GB", { minimumFractionDigits: dp, maximumFractionDigits: dp });
        const round2 = (x) => Math.round((x + Number.EPSILON) * 100) / 100;
        const cbm = (L, W, H) => (num(L) / 100) * (num(W) / 100) * (num(H) / 100);

        const vatComponent = (sellIncVat, vatRate = VAT_RATE) => sellIncVat - sellIncVat / (1 + vatRate);

        const requiredSellForMargin = (targetMarginPct, purchaseInc, commissionPct, ppCost, ppCharged, vatRate = VAT_RATE) => {
            const M = Math.max(0, Math.min(0.99, targetMarginPct / 100));
            const comm = Math.max(0, commissionPct) / 100;
            const numer = purchaseInc + Math.max(0, ppCost) - Math.max(0, ppCharged);
            const denom = 1 - M - comm - (vatRate / (1 + vatRate));
            if (denom <= 0) return NaN;
            return numer / denom;
        };

        const maxPurchaseForMargin = (targetMarginPct, sellIncVat, commissionPct, ppCost, ppCharged, vatRate = VAT_RATE) => {
            const M = Math.max(0, Math.min(0.99, targetMarginPct / 100));
            const comm = Math.max(0, commissionPct) / 100;
            const factor = 1 - M - comm - (vatRate / (1 + vatRate));
            return sellIncVat * factor - Math.max(0, ppCost) + Math.max(0, ppCharged);
        };

        const computeProfit = (sellIncVat, purchaseInc, commissionPct, ppCost, ppCharged, vatRate = VAT_RATE) => {
            const comm = Math.max(0, commissionPct) / 100;
            const commission = sellIncVat * comm;
            const totalCost = purchaseInc + vatComponent(sellIncVat, vatRate) + commission + Math.max(0, ppCost) - Math.max(0, ppCharged);
            return sellIncVat - totalCost;
        };

        function chooseCourier(l, w, h, weightKg, rules = DEFAULT_COURIER_RULES) {
            // Auto-sort dimensions so L is always longest, H is always shortest
            const dims = [Math.max(0, l | 0), Math.max(0, w | 0), Math.max(0, h | 0)].sort((a, b) => b - a);
            const L = dims[0], W = dims[1], H = dims[2];
            const weight = Math.max(0, Number(weightKg || 0));
            const volumeCm3 = L * W * H;
            const volumeL = volumeCm3 / 1000;
            const girth = L + 2 * (W + H);
            const volKg = volumeCm3 / VOL_DIVISOR;

            const fits = [];
            for (const r of rules) {
                let ok = true;
                let reasons = [];
                if (r.maxL && L > r.maxL) ok = false;
                if (r.maxW && W > r.maxW) ok = false;
                if (r.maxH && H > r.maxH) ok = false;
                if (r.maxGirth && girth > r.maxGirth) ok = false;
                if (r.maxWeight && weight > r.maxWeight) ok = false;
                if (r.maxVol && volumeL > r.maxVol) ok = false;
                if (r.minVol && volumeL <= r.minVol) ok = false;
                if (r.maxVolCm3 && volumeCm3 > r.maxVolCm3) ok = false;

                if (ok) {
                    if (weight > 0 && r.maxWeight && weight <= r.maxWeight) reasons.push(`Under ${r.maxWeight}kg`);
                    if (r.maxVol && volumeL <= r.maxVol) reasons.push(`Under ${r.maxVol}L`);

                    let cost = r.price;
                    let parcels = 1;

                    if (r.type === 'multi') {
                        parcels = Math.max(1, Math.ceil(Math.max(weight, 0) / 30));
                        cost = r.price + Math.max(0, parcels - 1) * (r.extraPerParcel || 0);
                    } else if (r.type === 'dx_std') {
                        parcels = Math.max(1, Math.ceil(Math.max(weight, volKg) / 30));
                        const surcharge = (weight > DX_SURCHARGE_THRESHOLD || volKg > DX_SURCHARGE_THRESHOLD) ? 1.75 * parcels : 0;
                        cost = r.price + (parcels - 1) * (r.extraPerParcel || 0) + surcharge;
                    } else if (r.type === 'dx_len') {
                        parcels = Math.max(1, Math.ceil(Math.max(weight, volKg) / 30));
                        cost = r.price * parcels;
                    }

                    fits.push({
                        carrier: r.name.split('/')[0].trim(),
                        service: r.name.split('/')[1].trim(),
                        cost: cost,
                        parcels: parcels,
                        logo: r.logo,
                        id: r.id,
                        days: r.days || '2-3',
                        reason: reasons.slice(0, 2).join(', ')
                    });
                }
            }
            if (fits.length === 0) return null;
            fits.sort((a, b) => a.cost - b.cost);
            return fits[0];
        }

        function getAllCouriers(l, w, h, weightKg, rules = DEFAULT_COURIER_RULES) {
            // Auto-sort dimensions so L is always longest, H is always shortest
            const dims = [Math.max(0, l | 0), Math.max(0, w | 0), Math.max(0, h | 0)].sort((a, b) => b - a);
            const L = dims[0], W = dims[1], H = dims[2];
            const weight = Math.max(0, Number(weightKg || 0));
            const volumeCm3 = L * W * H;
            const volumeL = volumeCm3 / 1000;
            const girth = L + 2 * (W + H);
            const volKg = volumeCm3 / VOL_DIVISOR;

            const fits = [];
            for (const r of rules) {
                let ok = true;
                let reasons = [];
                if (r.maxL && L > r.maxL) ok = false;
                if (r.maxW && W > r.maxW) ok = false;
                if (r.maxH && H > r.maxH) ok = false;
                if (r.maxGirth && girth > r.maxGirth) ok = false;
                if (r.maxWeight && weight > r.maxWeight) ok = false;
                if (r.maxVol && volumeL > r.maxVol) ok = false;
                if (r.minVol && volumeL <= r.minVol) ok = false;
                if (r.maxVolCm3 && volumeCm3 > r.maxVolCm3) ok = false;

                if (ok) {
                    if (weight > 0 && r.maxWeight && weight <= r.maxWeight) reasons.push(`Under ${r.maxWeight}kg`);
                    if (r.maxVol && volumeL <= r.maxVol) reasons.push(`Under ${r.maxVol}L`);

                    let cost = r.price;
                    let parcels = 1;

                    if (r.type === 'multi') {
                        parcels = Math.max(1, Math.ceil(Math.max(weight, 0) / 30));
                        cost = r.price + Math.max(0, parcels - 1) * (r.extraPerParcel || 0);
                    } else if (r.type === 'dx_std') {
                        parcels = Math.max(1, Math.ceil(Math.max(weight, volKg) / 30));
                        const surcharge = (weight > DX_SURCHARGE_THRESHOLD || volKg > DX_SURCHARGE_THRESHOLD) ? 1.75 * parcels : 0;
                        cost = r.price + (parcels - 1) * (r.extraPerParcel || 0) + surcharge;
                    } else if (r.type === 'dx_len') {
                        parcels = Math.max(1, Math.ceil(Math.max(weight, volKg) / 30));
                        cost = r.price * parcels;
                    }

                    fits.push({
                        carrier: r.name.split('/')[0].trim(),
                        service: r.name.split('/')[1].trim(),
                        cost: cost,
                        parcels: parcels,
                        logo: r.logo,
                        id: r.id,
                        days: r.days || '2-3',
                        reason: reasons.slice(0, 2).join(', ')
                    });
                }
            }
            fits.sort((a, b) => a.cost - b.cost);
            return fits;
        }

        function nudgeToFit(l, w, h, weight) {
            // Auto-sort dimensions so L is always longest, H is always shortest
            const dims = [l | 0, w | 0, h | 0].sort((a, b) => b - a);
            const L = dims[0], W = dims[1], H = dims[2], wt = Number(weight || 0);
            const volumeCm3 = L * W * H; const volumeL = volumeCm3 / 1000; const girth = L + 2 * (W + H);
            const issues = [];

            if (L > 200) issues.push(`Too long! Max length is 200cm (DX Lengths). Reduce by ${L - 200}cm.`);
            else if (L > 180) issues.push(`Too long for Evri L&L (Max 180cm). Reduce by ${L - 180}cm.`);
            else if (L > 150) issues.push(`Too long for Parcelforce (Max 150cm). Reduce by ${L - 150}cm.`);

            if (girth > 380) {
                const excess = girth - 380;
                const reduceEach = Math.ceil(excess / 4);
                issues.push(`Reduce width by ${reduceEach}cm OR height by ${reduceEach}cm to fit Evri L&L. (Girth = L + 2W + 2H = ${girth}cm, max 380cm)`);
            }
            else if (girth > 300) {
                const excess = girth - 300;
                const reduceEach = Math.ceil(excess / 4);
                issues.push(`Reduce width by ${reduceEach}cm OR height by ${reduceEach}cm to fit Parcelforce. (Girth = L + 2W + 2H = ${girth}cm, max 300cm)`);
            }

            if (volumeL > 40 && wt <= 2 && L <= 120 && girth <= 225) issues.push(`Too bulky for cheap Packet rate. Reduce volume by ${(volumeL - 40).toFixed(1)}L.`);
            if (wt > 30) issues.push(`Too heavy! (${wt}kg). Max courier weight is 30kg. Use a pallet.`);

            return issues;
        }

        const Icons = {
            Box: (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>,
            Truck: (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" /></svg>,
            Money: (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Ruler: (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>,
            Reset: (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
            Settings: (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            Sun: (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            Moon: (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>,
            Package: (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
        };

        function ProductRow({ product, index, currencyConversion, convertCurrency }) {
            const [gbpPrice, setGbpPrice] = useState(null);
            
            // Convert currency if enabled
            useEffect(() => {
                if (currencyConversion.enabled && product.unitPrice) {
                    convertCurrency(product.unitPrice, 'USD', currencyConversion.targetCurrency)
                        .then(converted => setGbpPrice(converted));
                }
            }, [product.unitPrice, currencyConversion.enabled]);
            
            return (
                <tr className="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                    <td className="px-3 py-2 text-gray-400">{index + 1}</td>
                    <td className="px-3 py-2 font-medium text-gray-900 dark:text-white truncate max-w-[120px]" title={product.sku}>{product.sku || '—'}</td>
                    <td className="px-3 py-2 text-gray-700 dark:text-gray-300 truncate max-w-[200px]" title={product.title}>{product.title || '—'}</td>
                    <td className="px-3 py-2 font-bold text-indigo-600 dark:text-indigo-400">${product.unitPrice?.toFixed(2) || '0.00'}</td>
                    <td className="px-3 py-2 font-medium text-emerald-600 dark:text-emerald-400">
                        {currencyConversion.enabled && gbpPrice ? `£${gbpPrice}` : '—'}
                    </td>
                    <td className="px-3 py-2 text-gray-500">{product.cartonLength || product.productLength || 0}×{product.cartonWidth || product.productWidth || 0}×{product.cartonHeight || product.productHeight || 0}</td>
                    <td className="px-3 py-2 text-gray-500">{product.pack || 1}</td>
                    <td className="px-3 py-2 text-gray-500">{product.grossWeight ? `${product.grossWeight}kg` : '—'}</td>
                    <td className="px-3 py-2 text-gray-500">{product.supplierCBM ? `${product.supplierCBM}m³` : '—'}</td>
                </tr>
            );
        }

        function CourierCard({ courier, allCouriers, showAlternatives = true }) {
            const [expanded, setExpanded] = useState(false);
            const money = (n) => `\u00a3${Number(n || 0).toFixed(2)}`;

            if (!courier) return (
                <div className="glass-card rounded-2xl p-4 border-l-4 border-l-gray-300">
                    <div className="text-sm text-gray-500">Enter dimensions to see shipping options</div>
                </div>
            );

            const alternatives = allCouriers?.slice(1, 4) || [];

            return (
                <div className="glass-card rounded-2xl overflow-hidden border border-gray-100 dark:border-gray-800 hover:shadow-lg transition-all">
                    {/* Main Recommendation */}
                    <div className="p-4 bg-gradient-to-r from-emerald-50/50 to-transparent dark:from-emerald-900/20">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                                <span className="px-2 py-0.5 text-[10px] font-black uppercase tracking-wide bg-emerald-500 text-white rounded-full">Recommended</span>
                                <span className="text-[10px] font-medium text-gray-400">{courier.days} days</span>
                            </div>
                            {courier.reason && <span className="text-[10px] text-gray-400 italic">{courier.reason}</span>}
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 rounded-xl bg-white dark:bg-gray-800 shadow-sm flex items-center justify-center p-2 overflow-hidden">
                                {courier.logo ? <img src={courier.logo} alt={courier.carrier} className="w-full h-full object-contain" onError={(e) => { e.target.style.display = 'none'; }} /> : <span className="text-lg font-black text-gray-400">{courier.carrier[0]}</span>}
                            </div>
                            <div className="flex-1">
                                <div className="text-lg font-black text-gray-900 dark:text-white">{courier.carrier}</div>
                                <div className="text-sm text-gray-500">{courier.service}</div>
                            </div>
                            <div className="text-right">
                                <div className="text-2xl font-black text-emerald-600">{money(courier.cost)}</div>
                                {courier.parcels > 1 && <div className="text-[10px] text-gray-400">{courier.parcels} parcels</div>}
                            </div>
                        </div>
                    </div>

                    {/* Alternatives Toggle */}
                    {showAlternatives && alternatives.length > 0 && (
                        <>
                            <button onClick={() => setExpanded(!expanded)} className="w-full flex items-center justify-between px-4 py-2 bg-gray-50 dark:bg-gray-800/50 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors border-t border-gray-100 dark:border-gray-800">
                                <span className="text-xs font-bold text-gray-500">{alternatives.length} alternative{alternatives.length > 1 ? 's' : ''} available</span>
                                <span className={`transition-transform duration-200 ${expanded ? 'rotate-180' : ''}`}>
                                    <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                </span>
                            </button>
                            <div className={`overflow-hidden transition-all duration-300 ${expanded ? 'max-h-80' : 'max-h-0'}`}>
                                <div className="p-3 space-y-2 bg-gray-50/50 dark:bg-gray-900/30">
                                    {alternatives.map((alt, i) => (
                                        <div key={alt.id || i} className="flex items-center gap-3 p-3 rounded-xl bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700">
                                            <div className="w-8 h-8 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center p-1.5 overflow-hidden">
                                                {alt.logo ? <img src={alt.logo} alt={alt.carrier} className="w-full h-full object-contain" onError={(e) => { e.target.style.display = 'none'; }} /> : <span className="text-xs font-bold text-gray-400">{alt.carrier[0]}</span>}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="text-sm font-bold text-gray-700 dark:text-gray-200 truncate">{alt.carrier} / {alt.service}</div>
                                                <div className="text-[10px] text-gray-400">{alt.days} days</div>
                                            </div>
                                            <div className="text-sm font-black text-gray-600 dark:text-gray-300">{money(alt.cost)}</div>
                                            <div className="text-[10px] text-red-400">+{money(alt.cost - courier.cost)}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        }

        function CollapsibleSection({ title, icon, defaultOpen = false, children }) {
            const [open, setOpen] = useState(defaultOpen);
            return (
                <div className="glass-card rounded-2xl overflow-hidden">
                    <button onClick={() => setOpen(o => !o)} className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                        <div className="flex items-center gap-2 font-bold text-sm">
                            {icon && <span>{icon}</span>}
                            <span>{title}</span>
                        </div>
                        <span className={`transition-transform ${open ? 'rotate-180' : ''}`}>▼</span>
                    </button>
                    {open && <div className="p-4 pt-0 border-t border-gray-100 dark:border-gray-800">{children}</div>}
                </div>
            );
        }

        const StableInput = memo(function StableInput({ value, onValue, className, ...rest }) {
            const ref = useRef(null);
            const focusedRef = useRef(false);
            useEffect(() => { if (!focusedRef.current && ref.current && ref.current.value !== (value ?? "")) { ref.current.value = value ?? ""; } }, [value]);
            return <input {...rest} ref={ref} defaultValue={value} type={rest.type || "text"} inputMode={rest.inputMode || "decimal"} autoComplete="off" className={`glass-input w-full rounded-xl placeholder:text-gray-400 dark:placeholder:text-gray-500 px-4 py-3 text-base md:text-sm font-medium transition-all duration-200 border-transparent focus:border-blue-500/50 focus:ring-4 focus:ring-blue-500/20 dark:focus:ring-blue-400/20 ${className || ""}`}
                onFocus={(e) => {
                    focusedRef.current = true;
                    e.target.select(); // Auto-select content on focus
                }}
                onBlur={(e) => {
                    focusedRef.current = false;
                    onValue(e.currentTarget.value);
                }}
            />;
        });
        function useStableSetter(setState) { const mapRef = useRef({}); return useCallback((key) => { if (!mapRef.current[key]) { mapRef.current[key] = (v) => setState(prev => ({ ...prev, [key]: v })); } return mapRef.current[key]; }, [setState]); }

        const ThemeContext = React.createContext();
        const useTheme = () => React.useContext(ThemeContext);
        function ThemeProvider({ children }) {
            const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'dark');
            useEffect(() => { document.documentElement.classList.toggle('dark', theme === 'dark'); localStorage.setItem('theme', theme); }, [theme]);
            return <ThemeContext.Provider value={{ theme, toggle: () => setTheme(t => t === 'light' ? 'dark' : 'light') }}>{children}</ThemeContext.Provider>;
        }

        function PriceRulesPanel({ rules, setRules }) {
            const [open, setOpen] = useState(false);
            const ref = useRef(null);
            useEffect(() => { const onDoc = (e) => { if (ref.current && !ref.current.contains(e.target)) setOpen(false); }; document.addEventListener('mousedown', onDoc); return () => document.removeEventListener('mousedown', onDoc); }, []);
            return (
                <div className="relative z-[9999]" ref={ref}>
                    <button className={`btn px-4 py-2 rounded-xl border text-sm font-medium ${rules.enabled ? 'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-300 dark:border-emerald-700 text-emerald-700 dark:text-emerald-300' : 'glass-card'}`} onClick={() => setOpen(o => !o)}>Price Endings {rules.enabled && '✓'}</button>
                    {open && (
                        <div className="absolute right-0 mt-2 w-80 glass-card bg-white/90 dark:bg-gray-800/90 backdrop-blur-3xl rounded-xl p-4 space-y-3 z-[9999] shadow-2xl ring-1 ring-black/5 dark:ring-white/10">
                            <label className="flex items-center gap-2 text-sm font-medium"><input type="checkbox" checked={rules.enabled} onChange={(e) => setRules(prev => ({ ...prev, enabled: e.target.checked }))} className="rounded" /> Enable globally</label>
                            <div><div className="text-xs text-gray-600 dark:text-gray-400 mb-1">Endings (e.g. 0.99)</div><input className="glass-input w-full rounded-lg px-3 py-2 text-sm" value={rules.endingsText} onChange={(e) => setRules(prev => ({ ...prev, endingsText: e.target.value }))} /></div>
                            <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={rules.allowDown} onChange={(e) => setRules(prev => ({ ...prev, allowDown: e.target.checked }))} className="rounded" /> Allow rounding down</label>
                            <div><div className="text-xs text-gray-600 dark:text-gray-400 mb-1">Tolerance (%)</div><input className="glass-input w-full rounded-lg px-3 py-2 text-sm" value={rules.tolerancePct} onChange={(e) => setRules(prev => ({ ...prev, tolerancePct: e.target.value }))} /></div>
                        </div>
                    )}
                </div>
            );
        }

        function applyPriceRule(base, rules) {
            if (!rules.enabled || !rules.endingsText) return base;
            const tolerancePct = parseFloat(rules.tolerancePct) || 0;
            const tolAbs = Math.max(0, tolerancePct) / 100 * base;
            const endings = rules.endingsText.split(/[^0-9.]+/).filter(Boolean).map(p => {
                const x = parseFloat(p);
                return Number.isFinite(x) ? (x < 1 ? x : x / 100) : NaN;
            }).filter(v => !Number.isNaN(v));
            if (!endings.length) endings.push(0.49, 0.99);

            const pounds = Math.floor(base);
            const candidates = [];
            for (let p = pounds - 1; p <= pounds + 2; p++) {
                if (p < 0) continue;
                for (const e of endings) { candidates.push(p + e); candidates.push(p + 1 + e); }
            }

            let best = base, bestDiff = Infinity;
            for (const c of candidates) {
                const diff = Math.abs(c - base);
                if (c < base && !rules.allowDown) continue;
                if (c < base && (base - c) > tolAbs) continue;
                if (diff < bestDiff) { best = c; bestDiff = diff; }
            }
            return best;
        }

        function SimpleView({ g, setG, priceRules, setPriceRules, courierRules, active, setSettingsOpen }) {
            const [s, setS] = useState({ unitUSD: '10.00', unitsPerCarton: '', knowUnits: false, unitsPer40HQ: '', L: '40', W: '30', H: '30', L2: '', W2: '', H2: '', hasCarton2: false, targetMarginPct: '25', manualTarget: '', ppCostGBP: '2.50', commissionPct: '15.3', vatPct: '20', weightKg: '5', weight2: '', ppSurcharge: '0.50', ppChargedGBP: '0', orderQty: '', orderMode: 'cartons' });
            const [showCompare, setShowCompare] = useState(false);
            const [tooltipOpen, setTooltipOpen] = useState(false);
            const [ratesOpen, setRatesOpen] = useState(false);
            const [stickyVisible, setStickyVisible] = useState(false);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [priceRulesOpen, setPriceRulesOpen] = useState(false);
            const [editingTarget, setEditingTarget] = useState(false);

            useEffect(() => {
                const observer = new IntersectionObserver(
                    ([entry]) => {
                        // Show when element IS NOT intersecting AND is above the viewport
                        setStickyVisible(!entry.isIntersecting && entry.boundingClientRect.top < 0);
                    },
                    { threshold: 0, rootMargin: "-24px 0px 0px 0px" } // 24px buffer for the sticky header height/padding
                );
                const el = document.getElementById('main-price-display');
                if (el) observer.observe(el);
                return () => observer.disconnect();
            }, []);
            const setSField = useStableSetter(setS);

            const cont = CONTAINER_CBM[g.containerType] || 76;
            const effCBM = cont * (num(g.utilisationPct) / 100);
            const fx = num(g.fxGbpToUsd);
            const sea = num(g.seaFreightGBP);

            const vol1 = cbm(s.L, s.W, s.H);
            const hasCarton2Dims = s.hasCarton2 && num(s.L2) > 0 && num(s.W2) > 0 && num(s.H2) > 0;
            const vol2 = hasCarton2Dims ? cbm(s.L2, s.W2, s.H2) : 0;
            const setVol = vol1 + vol2;
            const pack = Math.max(1, Math.floor(num(s.unitsPerCarton)) || 1);
            const hasPack = pack > 1;

            let units = 0, cartonsCount = 0;
            if (s.knowUnits && num(s.unitsPer40HQ) > 0) { units = Math.floor(num(s.unitsPer40HQ)); cartonsCount = hasPack ? Math.floor(units / pack) : NaN; }
            else if (setVol > 0) { cartonsCount = Math.floor(effCBM / setVol); units = cartonsCount * pack; }

            const unitGBP = fx > 0 ? num(s.unitUSD) / fx : 0;
            const perUnitFreight = units > 0 ? sea / units : 0;
            const landedUnit = round2(unitGBP + perUnitFreight);
            const landedPack = round2(landedUnit * pack);
            const purchaseInc = hasPack ? landedPack : landedUnit;

            const vatRate = num(s.vatPct) / 100;
            const requiredSell = requiredSellForMargin(num(s.targetMarginPct), purchaseInc, num(s.commissionPct), num(s.ppCostGBP), num(s.ppChargedGBP), vatRate);

            const ends = useMemo(() => {
                if (!priceRules.endingsText) return [0.49, 0.99];
                const parts = priceRules.endingsText.split(/[^0-9.]+/).filter(Boolean);
                const vals = parts.map(p => { const x = parseFloat(p); return Number.isFinite(x) ? (x < 1 ? x : x / 100) : NaN; }).filter(v => !Number.isNaN(v));
                return vals.length ? vals : [0.49, 0.99];
            }, [priceRules.endingsText]);

            const finalSell = useMemo(() => {
                if (!Number.isFinite(requiredSell)) return requiredSell;
                if (!priceRules.enabled) return requiredSell;
                return (function nearest(base, endings, allowDown, tolerancePct) {
                    const tolAbs = Math.max(0, tolerancePct || 0) / 100 * base;
                    const pounds = Math.floor(base);
                    const candidates = [];
                    for (let p = pounds - 1; p <= pounds + 2; p++) {
                        if (p < 0) continue;
                        for (const e of endings) { candidates.push(p + e); candidates.push(p + 1 + e); }
                    }
                    let best = base, bestDiff = Infinity;
                    for (const c of candidates) {
                        const diff = Math.abs(c - base);
                        if (c < base && !allowDown) continue;
                        if (c < base && (base - c) > tolAbs) continue;
                        if (diff < bestDiff) { best = c; bestDiff = diff; }
                    }
                    return best;
                })(requiredSell, ends, priceRules.allowDown, parseFloat(priceRules.tolerancePct) || 0);
            }, [requiredSell, priceRules, ends]);

            const sell = num(s.manualTarget || finalSell);
            const profit = sell > 0 ? computeProfit(sell, purchaseInc, num(s.commissionPct), num(s.ppCostGBP), num(s.ppChargedGBP), vatRate) : NaN;
            const marginPct = Number.isFinite(profit) && sell > 0 ? (profit / sell) * 100 : NaN;

            useEffect(() => {
                if (!s.manualTarget) return;
                const target = num(s.manualTarget);
                if (target <= 0) return;
                const maxPurchase = maxPurchaseForMargin(num(s.targetMarginPct), target, num(s.commissionPct), num(s.ppCostGBP), num(s.ppChargedGBP), vatRate);
                if (Number.isFinite(maxPurchase)) {
                    const targetLanded = hasPack ? maxPurchase : maxPurchase;
                    const targetUnitGBP = (hasPack ? targetLanded / pack : targetLanded) - perUnitFreight;
                    const targetUnitUSD = targetUnitGBP * fx;
                    if (targetUnitUSD > 0) setS(prev => ({ ...prev, unitUSD: targetUnitUSD.toFixed(4) }));
                }
            }, [s.manualTarget]);

            const courier = useMemo(() => {
                const c1 = chooseCourier(num(s.L), num(s.W), num(s.H), num(s.weightKg), courierRules);
                if (!s.hasCarton2) return c1;

                // Only calculate carton 2 if dimensions are entered
                const hasCarton2Dims = num(s.L2) > 0 && num(s.W2) > 0 && num(s.H2) > 0;
                if (!hasCarton2Dims) return c1; // Treat as single carton if no dims

                const c2 = chooseCourier(num(s.L2), num(s.W2), num(s.H2), num(s.weight2), courierRules);

                const strapL = Math.max(num(s.L), num(s.L2));
                const strapW = Math.max(num(s.W), num(s.W2));
                const strapH = num(s.H) + num(s.H2);
                const strapWeight = num(s.weightKg) + num(s.weight2);
                const cStrapped = chooseCourier(strapL, strapW, strapH, strapWeight, courierRules);

                const costSeparate = (c1 ? c1.cost : Infinity) + (c2 ? c2.cost : Infinity);
                const costStrapped = cStrapped ? cStrapped.cost : Infinity;

                if (costSeparate === Infinity && costStrapped === Infinity) return null;

                if (costStrapped < costSeparate) {
                    return { ...cStrapped, strategy: 'strapped', savings: costSeparate - costStrapped };
                } else {
                    return {
                        cost: costSeparate,
                        carrier: 'Split Shipment',
                        service: `${c1?.carrier || '?'} + ${c2?.carrier || '?'}`,
                        strategy: 'separate',
                        details: [c1, c2]
                    };
                }
            }, [s.L, s.W, s.H, s.weightKg, s.L2, s.W2, s.H2, s.weight2, s.hasCarton2, courierRules]);

            const allCouriers = useMemo(() => {
                if (s.hasCarton2) return []; // Complex case, skip alternatives
                return getAllCouriers(num(s.L), num(s.W), num(s.H), num(s.weightKg), courierRules);
            }, [s.L, s.W, s.H, s.weightKg, s.hasCarton2, courierRules]);

            const nudges = useMemo(() => {
                const n1 = nudgeToFit(num(s.L), num(s.W), num(s.H), num(s.weightKg));
                if (!s.hasCarton2) return n1;
                const n2 = nudgeToFit(num(s.L2), num(s.W2), num(s.H2), num(s.weight2));
                return [...n1.map(n => `Carton 1: ${n}`), ...n2.map(n => `Carton 2: ${n}`)];
            }, [s.L, s.W, s.H, s.weightKg, s.L2, s.W2, s.H2, s.weight2, s.hasCarton2]);
            const money = (n) => `£${fmt(n, 2)}`;
            const Field = ({ label, right, children }) => (
                <div className="space-y-1.5">
                    <div className="flex justify-between items-center h-5">
                        <label className="block text-xs font-medium text-gray-500 dark:text-gray-400">{label}</label>
                        {right}
                    </div>
                    {children}
                </div>
            );

            return (
                <>
                    <div className="fixed inset-0 -z-10 pointer-events-none h-full w-full opacity-60 dark:opacity-40" style={{
                        background: 'radial-gradient(circle at 15% 15%, rgba(99, 102, 241, 0.15), transparent 40%), radial-gradient(circle at 85% 15%, rgba(168, 85, 247, 0.15), transparent 40%), radial-gradient(circle at 85% 85%, rgba(59, 130, 246, 0.15), transparent 40%), radial-gradient(circle at 15% 85%, rgba(244, 63, 94, 0.15), transparent 40%)',
                        filter: 'blur(80px)',
                        animation: 'aurora 20s ease infinite alternate'
                    }}></div>
                    <div className={`relative z-10 grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6 lg:items-start ${active ? '' : 'hidden'}`}>
                        <div className="lg:col-span-7 flex flex-col gap-4 overflow-visible">
                            <div className="glass-card rounded-3xl md:rounded-2xl p-4 md:p-6 space-y-4 shadow-lg hover:shadow-2xl hover:scale-[1.005] transition-all duration-300 ease-out bg-gradient-to-br from-white/80 to-gray-50/50 dark:from-gray-800/80 dark:to-gray-900/50">
                                <div className="flex items-center gap-2 mb-4">
                                    <div className="flex items-center gap-3 mb-4">
                                        <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 dark:from-transparent dark:to-transparent dark:bg-black shadow-lg shadow-blue-500/30 dark:shadow-none ring-1 ring-white/20 dark:ring-white/10 flex items-center justify-center relative overflow-hidden group">
                                            <div className="absolute inset-0 bg-gradient-to-br from-white/25 to-transparent opacity-100"></div>
                                            <svg className="w-6 h-6 text-white dark:text-blue-500 relative z-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
                                        </div>
                                        <h3 className="text-2xl font-bold tracking-tight text-gray-900 dark:text-white">Item Details</h3>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="md:col-span-1">
                                        <div className="relative">
                                            <div className="absolute -inset-1 bg-gradient-to-r from-blue-400/15 to-sky-400/15 dark:from-indigo-500/20 dark:to-purple-500/20 rounded-xl blur-sm"></div>
                                            <div className="relative space-y-1.5 bg-white dark:bg-gray-900 rounded-xl p-3 ring-2 ring-blue-300/60 dark:ring-indigo-400/50 mobile-hero-input">
                                                <label className="flex items-center gap-2 text-xs font-semibold text-blue-600 dark:text-blue-300">
                                                    Unit Price (USD)
                                                </label>
                                                <StableInput value={s.unitUSD} onValue={setSField('unitUSD')} placeholder="2.35" className="!text-xl !font-bold !py-3 !bg-blue-50/80 dark:!bg-indigo-900/30 !border-blue-200 dark:!border-indigo-600" />
                                                {num(s.unitUSD) <= 0 && <div className="text-xs text-red-500 font-medium">Enter a price to calculate</div>}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="md:col-span-2 grid grid-cols-2 gap-4 items-start">
                                        <div className="space-y-1.5 w-full">
                                            <div className="flex items-center h-[26px]">
                                                <label className="block text-xs font-bold text-gray-700 dark:text-white">Items per Carton</label>
                                            </div>
                                            <StableInput value={s.unitsPerCarton} onValue={setSField('unitsPerCarton')} placeholder="1" className="w-full" />
                                        </div>
                                        <div className="space-y-1.5 w-full">
                                            <div className="flex justify-between items-center h-[26px]">
                                                <label className="block text-xs font-bold text-gray-700 dark:text-white">Order Qty</label>
                                                <div className="inline-flex p-0.5 bg-gradient-to-br from-white/80 to-gray-100/90 dark:from-gray-800/90 dark:to-gray-900/80 backdrop-blur-xl rounded-lg border border-white/60 dark:border-gray-600/40 shadow-sm">
                                                    <button onClick={() => setS(prev => ({ ...prev, orderMode: 'units' }))} className={`px-3 py-1 rounded-md text-[10px] font-bold transition-all ${s.orderMode !== 'cartons' ? 'bg-gradient-to-br from-white to-gray-50 dark:from-gray-700 dark:to-gray-800 text-gray-900 dark:text-white shadow-sm ring-1 ring-indigo-500/20 dark:ring-indigo-400/30' : 'text-gray-500 dark:text-gray-400 hover:bg-white/50 dark:hover:bg-gray-700/50'}`}>Units</button>
                                                    <button onClick={() => setS(prev => ({ ...prev, orderMode: 'cartons' }))} className={`px-3 py-1 rounded-md text-[10px] font-bold transition-all ${s.orderMode === 'cartons' ? 'bg-gradient-to-br from-white to-gray-50 dark:from-gray-700 dark:to-gray-800 text-gray-900 dark:text-white shadow-sm ring-1 ring-indigo-500/20 dark:ring-indigo-400/30' : 'text-gray-500 dark:text-gray-400 hover:bg-white/50 dark:hover:bg-gray-700/50'}`}>Cartons</button>
                                                </div>
                                            </div>
                                            <div className="flex flex-col w-full">
                                                <StableInput value={s.orderQty} onValue={setSField('orderQty')} placeholder={s.orderMode === 'cartons' ? "e.g. 50" : "e.g. 500"} className="w-full" />
                                                {num(s.orderQty) > 0 && (num(s.unitsPerCarton) || 1) > 1 && (
                                                    <div className="text-[10px] text-right font-medium text-indigo-600 dark:text-blue-400 mt-1">
                                                        {s.orderMode === 'cartons'
                                                            ? `= ${(num(s.orderQty) * (num(s.unitsPerCarton) || 1)).toLocaleString()} Units`
                                                            : `= ${Math.ceil(num(s.orderQty) / (num(s.unitsPerCarton) || 1)).toLocaleString()} Cartons`}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
                                    <div className="flex justify-between items-center mb-3"><span className="text-xs font-bold text-gray-800 dark:text-white uppercase tracking-wide">Carton Config</span>{!s.hasCarton2 && <button onClick={() => setS(prev => ({ ...prev, hasCarton2: true }))} className="text-xs font-bold text-indigo-600 dark:text-blue-300 hover:text-indigo-700 dark:hover:text-blue-200">+ Add Carton 2</button>}</div>
                                    <div className="space-y-3">
                                        <div className="grid grid-cols-3 gap-2"><StableInput value={s.L} onValue={setSField('L')} placeholder="L" /><StableInput value={s.W} onValue={setSField('W')} placeholder="W" /><StableInput value={s.H} onValue={setSField('H')} placeholder="H" /></div>
                                        {s.hasCarton2 && <div className="grid grid-cols-3 gap-2 pt-3 border-t border-dashed border-gray-300 dark:border-gray-600"><StableInput value={s.L2} onValue={setSField('L2')} placeholder="L" /><StableInput value={s.W2} onValue={setSField('W2')} placeholder="W" /><div className="flex gap-2"><StableInput value={s.H2} onValue={setSField('H2')} placeholder="H" /><button onClick={() => setS(prev => ({ ...prev, hasCarton2: false }))} className="text-red-500 hover:text-red-600 font-bold">✕</button></div></div>}
                                    </div>
                                </div>
                                <div className="flex items-center justify-between mt-4 md:mt-0">
                                    {s.knowUnits ? (
                                        <Field label={<span className="flex items-center gap-1.5"><svg className="w-3.5 h-3.5 text-cyan-600 dark:text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>Units per 40HQ</span>}><StableInput value={s.unitsPer40HQ} onValue={setSField('unitsPer40HQ')} /></Field>
                                    ) : (
                                        <div className="flex items-center gap-3"><input type="checkbox" checked={s.knowUnits} onChange={(e) => setS(prev => ({ ...prev, knowUnits: e.target.checked }))} className="rounded text-indigo-600 focus:ring-indigo-500" /><span className="text-sm font-medium text-gray-600 dark:text-gray-400">I know exact units per 40HQ</span></div>
                                    )}
                                    <button onClick={() => setRatesOpen(!ratesOpen)} className="md:hidden flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 text-xs font-bold text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors">
                                        {ratesOpen ? 'Hide Rates' : 'Edit Rates'}
                                        <svg className={`w-3 h-3 transition-transform ${ratesOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                    </button>
                                </div>

                                <div className={`grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-gray-200 dark:border-gray-700 transition-all duration-300 overflow-hidden ${ratesOpen ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0 md:max-h-none md:opacity-100'}`}>
                                    <Field label={<span className="flex items-center gap-1.5 text-xs font-bold text-gray-700 dark:text-white"><svg className="w-3.5 h-3.5 text-rose-600 dark:text-rose-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>Target Margin %</span>}><StableInput value={s.targetMarginPct} onValue={setSField('targetMarginPct')} /></Field>
                                    <Field label={<span className="flex items-center gap-1.5 text-xs font-bold text-gray-700 dark:text-white"><svg className="w-3.5 h-3.5 text-purple-600 dark:text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>Market Fee %</span>}><StableInput value={s.commissionPct} onValue={setSField('commissionPct')} /></Field>
                                    <Field label={<span className="flex items-center gap-1.5 text-xs font-bold text-gray-700 dark:text-white"><svg className="w-3.5 h-3.5 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>VAT %</span>}><StableInput value={s.vatPct} onValue={setSField('vatPct')} /></Field>
                                    <Field label={<span className="flex items-center gap-1.5 text-xs font-bold text-gray-700 dark:text-white"><svg className="w-3.5 h-3.5 text-amber-600 dark:text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Outbound £</span>}><StableInput value={s.ppCostGBP} onValue={setSField('ppCostGBP')} /></Field>
                                </div>
                            </div>
                            <div style={{ zIndex: tooltipOpen ? 50 : 'auto', position: 'relative' }} className="glass-card rounded-3xl md:rounded-2xl p-4 md:p-6 flex flex-col flex-1 space-y-4 shadow-lg hover:shadow-2xl hover:scale-[1.005] transition-all duration-300 ease-out bg-gradient-to-br from-white/80 to-gray-50/50 dark:from-gray-800/80 dark:to-gray-900/50 overflow-visible">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-orange-600 dark:from-transparent dark:to-transparent dark:bg-black shadow-lg shadow-orange-500/30 dark:shadow-none ring-1 ring-white/20 dark:ring-white/10 flex items-center justify-center relative overflow-hidden group">
                                        <div className="absolute inset-0 bg-gradient-to-br from-white/25 to-transparent opacity-100"></div>
                                        <svg className="w-6 h-6 text-white dark:text-orange-500 relative z-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" /></svg>
                                    </div>
                                    <h3 className="text-2xl font-bold tracking-tight text-gray-800 dark:text-gray-200">Courier Estimator</h3>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="space-y-1.5">
                                        <label className="block text-xs font-bold text-gray-700 dark:text-white">{s.hasCarton2 ? "Weight 1 (kg)" : "Weight (kg)"}</label>
                                        <StableInput value={s.weightKg} onValue={setSField('weightKg')} />
                                    </div>
                                    {s.hasCarton2 ? (
                                        <div className="space-y-1.5">
                                            <label className="block text-xs font-bold text-gray-700 dark:text-white">Weight 2 (kg)</label>
                                            <StableInput value={s.weight2} onValue={setSField('weight2')} />
                                        </div>
                                    ) : (
                                        <div className="space-y-1.5">
                                            <label className="block text-xs font-bold text-gray-700 dark:text-white">Extra Shipping Cost</label>
                                            <StableInput value={s.ppSurcharge} onValue={setSField('ppSurcharge')} />
                                        </div>
                                    )}
                                </div>
                                {s.hasCarton2 && (
                                    <div className="mt-4 space-y-1.5">
                                        <label className="block text-xs font-bold text-gray-700 dark:text-white">Extra Shipping Cost</label>
                                        <StableInput value={s.ppSurcharge} onValue={setSField('ppSurcharge')} />
                                    </div>
                                )}
                                {s.hasCarton2 && courier && (
                                    <div className="px-3 py-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                                        <div className="text-xs font-bold text-blue-700 dark:text-blue-300">📦 This shipment has 2 cartons</div>
                                    </div>
                                )}
                                {courier ? (
                                    <div className="bg-orange-50 dark:bg-orange-900/10 border border-orange-200 dark:border-orange-800 rounded-xl p-4 space-y-3 overflow-visible">
                                        {s.hasCarton2 && num(s.L2) > 0 && num(s.W2) > 0 && num(s.H2) > 0 && (courier.strategy === 'strapped' || courier.strategy === 'separate') ? (
                                            <div className="space-y-2">
                                                <div className="text-xs font-bold text-orange-700 dark:text-orange-200">Shipping Breakdown</div>
                                                <div className="space-y-1.5">
                                                    <div className="flex justify-between items-center p-2 bg-white/50 dark:bg-gray-800/50 rounded-lg">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xs font-bold text-gray-500 dark:text-gray-400">1</span>
                                                            {courier.details?.[0]?.logo ? <img src={courier.details[0].logo} className="h-4" /> : null}
                                                            <span className="text-sm font-medium">{courier.details?.[0]?.carrier || courier.carrier} <span className="text-gray-400 font-normal">{courier.details?.[0]?.service || ""}</span></span>
                                                        </div>
                                                        <span className="font-bold text-sm">{money(courier.details?.[0]?.cost || courier.cost / 2)}</span>
                                                    </div>
                                                    <div className="flex justify-between items-center p-2 bg-white/50 dark:bg-gray-800/50 rounded-lg">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xs font-bold text-gray-500 dark:text-gray-400">2</span>
                                                            {courier.details?.[1]?.logo ? <img src={courier.details[1].logo} className="h-4" /> : null}
                                                            <span className="text-sm font-medium">{courier.details?.[1]?.carrier || courier.carrier} <span className="text-gray-400 font-normal">{courier.details?.[1]?.service || ""}</span></span>
                                                        </div>
                                                        <span className="font-bold text-sm">{money(courier.details?.[1]?.cost || courier.cost / 2)}</span>
                                                    </div>
                                                </div>
                                                <div className="flex justify-between items-center pt-2 border-t border-orange-200 dark:border-orange-700">
                                                    <span className="text-sm font-bold">Total</span>
                                                    <div className="relative group/tooltip">
                                                        <span className="text-xl font-bold text-orange-600 cursor-help border-b border-dotted border-orange-400">{money(courier.cost)}</span>
                                                        <div className="tooltip-adaptive absolute bottom-full mb-2 w-48 p-2 bg-gray-900 dark:bg-white text-white dark:text-gray-900 text-xs rounded-lg shadow-xl opacity-0 invisible group-hover/tooltip:opacity-100 group-hover/tooltip:visible transition-all z-50 pointer-events-none"
                                                            ref={(el) => {
                                                                if (el) {
                                                                    const rect = el.getBoundingClientRect();
                                                                    if (rect.left < 0) { el.style.left = '0'; el.style.right = 'auto'; }
                                                                    else if (rect.right > window.innerWidth) { el.style.right = '0'; el.style.left = 'auto'; }
                                                                    else { el.style.left = '50%'; el.style.transform = 'translateX(-50%)'; }
                                                                }
                                                            }}>
                                                            Includes fuel surcharge & emergency fees
                                                        </div>
                                                    </div>
                                                </div>
                                                {courier.strategy === 'strapped' && <div className="mt-2 px-3 py-2 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg border border-emerald-200 dark:border-emerald-800"><div className="text-xs font-bold text-emerald-700 dark:text-emerald-300">💡 Strapping Recommended</div><div className="text-xs text-emerald-600 dark:text-emerald-400 mt-0.5">Save {money(courier.savings)} by strapping cartons together vs shipping separately</div></div>}
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                {/* Primary Recommendation */}
                                                <div className="flex items-center gap-3">
                                                    <div className="w-12 h-12 rounded-xl bg-white dark:bg-gray-800 shadow-sm flex items-center justify-center p-2 overflow-hidden border border-orange-100 dark:border-orange-900">
                                                        {courier.logo ? <img src={courier.logo} className="w-full h-full object-contain" onError={(e) => { e.target.style.display = 'none'; }} /> : <span className="text-xl font-black text-gray-400">{courier.carrier?.[0]}</span>}
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2">
                                                            <span className="font-black text-gray-900 dark:text-white">{courier.carrier}</span>
                                                            <span onClick={() => setTooltipOpen(!tooltipOpen)} onMouseEnter={() => setTooltipOpen(true)} onMouseLeave={() => setTooltipOpen(false)} className="relative group cursor-help hover:z-[200]">
                                                                <span className="inline-flex items-center gap-1 px-1.5 py-0.5 text-[9px] font-bold bg-emerald-500 text-white rounded-full uppercase">Best Value <svg className="w-3 h-3 opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></span>
                                                                <div style={{ zIndex: 9999 }} className="fixed inset-x-4 bottom-4 md:absolute md:inset-auto md:left-0 md:top-full md:mt-2 md:w-80 p-4 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all">
                                                                    <div className="md:hidden absolute -top-2 left-1/2 -translate-x-1/2 w-8 h-1 bg-gray-300 rounded-full"></div>
                                                                    <div className="text-xs font-bold text-gray-900 dark:text-white mb-3 pb-2 border-b border-gray-100 dark:border-gray-700">Courier Selection Calculation</div>

                                                                    {/* Package Details */}
                                                                    <div className="mb-3 p-2.5 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                                                                        <div className="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Your Package</div>
                                                                        <div className="grid grid-cols-2 gap-2 text-xs text-gray-700 dark:text-gray-300">
                                                                            <div>📏 {num(s.L)}×{num(s.W)}×{num(s.H)} cm</div>
                                                                            <div>⚖️ {num(s.weightKg)} kg actual</div>
                                                                            <div>📦 Vol: {((num(s.L) * num(s.W) * num(s.H)) / 1000000).toFixed(4)} m³</div>
                                                                            <div>🔄 Vol Weight: {((num(s.L) * num(s.W) * num(s.H)) / 5000).toFixed(1)} kg</div>
                                                                        </div>
                                                                    </div>

                                                                    {/* Price Comparison */}
                                                                    <div className="mb-3">
                                                                        <div className="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Price Comparison</div>
                                                                        <div className="space-y-1">
                                                                            {allCouriers.slice(0, 3).map((c, i) => (
                                                                                <div key={c.id || i} className={`flex justify-between items-center text-xs px-2 py-1.5 rounded-lg ${i === 0 ? 'bg-emerald-50 dark:bg-emerald-900/30 font-bold text-emerald-700 dark:text-emerald-300' : 'text-gray-600 dark:text-gray-400'}`}>
                                                                                    <span>{i === 0 ? '✓ ' : ''}{c.carrier}</span>
                                                                                    <span>{money(c.cost)}</span>
                                                                                </div>
                                                                            ))}
                                                                            {allCouriers.length > 3 && (
                                                                                <div className="text-[10px] text-gray-400 text-center mt-1">+{allCouriers.length - 3} more options checked</div>
                                                                            )}
                                                                        </div>
                                                                    </div>

                                                                    {/* Calculation Method - THE MATH */}
                                                                    <div className="mb-3 p-2.5 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
                                                                        <div className="text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase mb-1.5">Calculation Method</div>
                                                                        <div className="text-[11px] text-blue-700 dark:text-blue-300 font-mono space-y-1">
                                                                            <div>Vol Weight = (L×W×H) ÷ 5000</div>
                                                                            <div>= ({num(s.L)}×{num(s.W)}×{num(s.H)}) ÷ 5000</div>
                                                                            <div className="font-bold">= {((num(s.L) * num(s.W) * num(s.H)) / 5000).toFixed(2)} kg</div>
                                                                            <div className="pt-1.5 mt-1.5 border-t border-blue-200 dark:border-blue-700">
                                                                                <span className="text-blue-600 dark:text-blue-400">Billable Weight:</span>
                                                                            </div>
                                                                            <div>max({num(s.weightKg)} kg, {((num(s.L) * num(s.W) * num(s.H)) / 5000).toFixed(1)} kg)</div>
                                                                            <div className="font-bold text-blue-900 dark:text-blue-200">= {Math.max(num(s.weightKg), (num(s.L) * num(s.W) * num(s.H)) / 5000).toFixed(1)} kg</div>
                                                                        </div>
                                                                    </div>

                                                                    {/* Savings */}
                                                                    {allCouriers.length > 1 && (
                                                                        <div className="flex items-center justify-between p-2.5 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-200 dark:border-emerald-800">
                                                                            <span className="text-xs font-bold text-emerald-700 dark:text-emerald-300">Your Savings</span>
                                                                            <span className="text-sm font-black text-emerald-600 dark:text-emerald-400">{money(allCouriers.sort((a, b) => a.cost - b.cost)[1].cost - courier.cost)}</span>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </span>
                                                        </div>
                                                        <div className="text-sm text-gray-500 dark:text-gray-400">{courier.service} • {courier.days || '2-3'} days</div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="text-2xl font-black text-orange-600">{money(courier.cost)}</div>
                                                        {courier.parcels > 1 && <div className="text-[10px] text-gray-400">{courier.parcels} parcels</div>}
                                                    </div>
                                                </div>
                                                {courier.reason && <div className="text-xs text-emerald-600 dark:text-emerald-400 font-medium bg-emerald-50 dark:bg-emerald-900/20 px-3 py-1.5 rounded-lg">✓ {courier.reason}</div>}
                                            </div>
                                        )}
                                        {nudges.length > 0 && <div className="pt-3 border-t border-orange-200/50 space-y-1"><div className="text-xs font-semibold text-orange-700">💡 Suggestions:</div>{nudges.map((n, i) => <div key={i} className="text-xs text-orange-600">{n}</div>)}</div>}
                                        <button onClick={() => setS(prev => ({ ...prev, ppCostGBP: (courier.cost + num(s.ppSurcharge)).toFixed(2) }))} className="w-full btn py-2 bg-white dark:bg-gray-800 rounded-lg text-sm font-semibold border border-orange-200">Apply {money(courier.cost + num(s.ppSurcharge))}</button>
                                    </div>
                                ) : <div className="flex-1 flex flex-col items-center justify-center text-center p-4 min-h-24 bg-gradient-to-br from-gray-50 to-gray-100/50 dark:from-gray-800/50 dark:to-gray-900/30 rounded-xl border border-dashed border-gray-200 dark:border-gray-700">
                                    <div className="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center mb-2">
                                        <Icons.Truck className="w-5 h-5 text-orange-400" />
                                    </div>
                                    <div className="text-xs font-medium text-gray-500 dark:text-gray-400">{nudges.length ? nudges.map((n, i) => <div key={i}>{n}</div>) : "Enter dimensions & weight"}</div>
                                </div>}
                            </div>
                        </div>
                        <div className="lg:col-span-5 flex flex-col gap-4">
                            <div id="target-sell-card" className="glass-card rounded-3xl md:rounded-2xl p-4 md:p-6 relative !overflow-visible ring-1 ring-white/20 dark:ring-white/10 shadow-lg bg-gradient-to-br from-white/80 to-gray-50/50 dark:from-gray-800/80 dark:to-gray-900/50 z-20">
                                <div className="absolute inset-0 rounded-3xl md:rounded-2xl overflow-hidden pointer-events-none">
                                    <div className="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-blue-500/10 to-purple-500/10 rounded-full -mr-16 -mt-16 blur-3xl"></div>
                                </div>
                                <div className="relative z-10 space-y-6">
                                    <div className="space-y-3">
                                        <div className="flex items-center justify-between mb-4">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-indigo-600 dark:from-transparent dark:to-transparent dark:bg-black shadow-lg shadow-indigo-500/30 dark:shadow-none ring-1 ring-white/20 dark:ring-white/10 flex items-center justify-center relative overflow-hidden group">
                                                    <div className="absolute inset-0 bg-gradient-to-br from-white/25 to-transparent opacity-100"></div>
                                                    <svg className="w-6 h-6 text-white dark:text-indigo-500 relative z-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                                </div>
                                                <h3 className="text-2xl font-bold tracking-tight text-gray-900 dark:text-white">Target Sell</h3>
                                            </div>
                                            <button onClick={() => setShowCompare(!showCompare)} className={`px-2.5 py-1 text-xs font-semibold rounded-lg transition-all ${showCompare ? 'bg-blue-600 text-white shadow-md' : 'text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20'}`}>Compare</button>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <div className="relative group/tooltip flex items-center gap-2">
                                                <div id="main-price-display" className="text-4xl md:text-5xl lg:text-6xl font-black tracking-tight bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 dark:from-white dark:via-gray-100 dark:to-white bg-clip-text text-transparent cursor-help">{sell > 0 ? money(sell) : '—'}</div>
                                                {sell > 0 && (
                                                    <div className="relative">
                                                        <svg className="w-5 h-5 text-gray-400 dark:text-gray-500 hover:text-blue-500 dark:hover:text-blue-400 transition-colors cursor-help" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                        </svg>
                                                        <div className="absolute left-1/2 -translate-x-1/2 top-full mt-3 w-80 p-5 bg-white/95 dark:bg-gray-900/95 backdrop-blur-2xl rounded-2xl shadow-2xl border border-gray-200/50 dark:border-gray-700/50 opacity-0 invisible group-hover/tooltip:opacity-100 group-hover/tooltip:visible transition-all duration-200 z-[100] text-left pointer-events-none">
                                                            <div className="absolute -top-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-white/95 dark:bg-gray-900/95 rotate-45 border-t border-l border-gray-200/50 dark:border-gray-700/50"></div>
                                                            <div className="flex items-center justify-between mb-3 border-b border-gray-200 dark:border-gray-700 pb-2">
                                                                <span className="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">Price Composition</span>
                                                                <span className="text-[10px] font-medium text-blue-500 bg-blue-50 dark:bg-blue-900/20 px-2 py-0.5 rounded-full">Reverse Calc</span>
                                                            </div>
                                                            <div className="space-y-2 text-xs">
                                                                <div className="flex justify-between items-center group/item hover:bg-gray-50 dark:hover:bg-gray-800/50 p-1 rounded transition-colors">
                                                                    <div className="flex flex-col">
                                                                        <span className="font-medium text-gray-700 dark:text-gray-200">1. Product Cost</span>
                                                                        <span className="text-[10px] text-gray-400">Purchase + Inbound Freight</span>
                                                                    </div>
                                                                    <span className="font-bold text-gray-900 dark:text-white">{money(purchaseInc)}</span>
                                                                </div>
                                                                <div className="flex justify-between items-center group/item hover:bg-gray-50 dark:hover:bg-gray-800/50 p-1 rounded transition-colors">
                                                                    <div className="flex flex-col">
                                                                        <span className="font-medium text-gray-700 dark:text-gray-200">2. Operational</span>
                                                                        <span className="text-[10px] text-gray-400">Shipping + Surcharges</span>
                                                                    </div>
                                                                    <span className="font-bold text-gray-900 dark:text-white">{money(Math.max(0, num(s.ppCostGBP)))}</span>
                                                                </div>
                                                                <div className="border-t border-dashed border-gray-200 dark:border-gray-700 my-1"></div>
                                                                <div className="flex justify-between items-center group/item hover:bg-gray-50 dark:hover:bg-gray-800/50 p-1 rounded transition-colors">
                                                                    <div className="flex flex-col">
                                                                        <span className="font-medium text-gray-700 dark:text-gray-200">3. Market Fee</span>
                                                                        <span className="text-[10px] text-gray-400">{num(s.commissionPct)}% of Final Price</span>
                                                                    </div>
                                                                    <span className="font-bold text-gray-900 dark:text-white">{money(sell * (Math.max(0, num(s.commissionPct)) / 100))}</span>
                                                                </div>
                                                                <div className="flex justify-between items-center group/item hover:bg-gray-50 dark:hover:bg-gray-800/50 p-1 rounded transition-colors">
                                                                    <div className="flex flex-col">
                                                                        <span className="font-medium text-gray-700 dark:text-gray-200">4. VAT Tax</span>
                                                                        <span className="text-[10px] text-gray-400">{(VAT_RATE * 100).toFixed(0)}% Included</span>
                                                                    </div>
                                                                    <span className="font-bold text-gray-900 dark:text-white">{money(vatComponent(sell))}</span>
                                                                </div>
                                                                <div className="flex justify-between items-center group/item bg-emerald-50/50 dark:bg-emerald-900/10 p-1.5 rounded-lg transition-colors border border-emerald-100 dark:border-emerald-800/30">
                                                                    <div className="flex flex-col">
                                                                        <span className="font-bold text-emerald-700 dark:text-emerald-400">5. Net Margin</span>
                                                                        <span className="text-[10px] text-emerald-600/70 dark:text-emerald-500/70">{num(s.targetMarginPct)}% Target Profit</span>
                                                                    </div>
                                                                    <span className="font-black text-emerald-600 dark:text-emerald-400">{money(computeProfit(sell, purchaseInc, num(s.commissionPct), num(s.ppCostGBP), num(s.ppChargedGBP)))}</span>
                                                                </div>
                                                                <div className="pt-2 text-[10px] text-center text-gray-400 italic">
                                                                    Final Price covers all costs + target margin
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex gap-1.5 bg-gray-100/50 dark:bg-gray-800/50 rounded-xl p-1 items-center ring-1 ring-gray-200 dark:ring-gray-700 backdrop-blur-sm">
                                                {[20, 25].map(m => <button key={m} onClick={() => { setS(prev => ({ ...prev, targetMarginPct: String(m) })); setShowCompare(false); }} className={`px-3.5 py-2 text-xs font-bold rounded-lg transition-all cursor-pointer ${num(s.targetMarginPct) === m ? (m === 25 ? 'bg-emerald-500 text-white shadow-md shadow-emerald-500/20 ring-1 ring-emerald-600/20' : 'bg-amber-500 text-white shadow-md shadow-amber-500/20 ring-1 ring-amber-600/20') : 'text-gray-500 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-white/50 dark:hover:bg-white/5'}`}>{m}%</button>)}
                                            </div>
                                        </div>

                                        {/* Compare Modal */}
                                        {showCompare && sell > 0 && (
                                            <div className="mt-4 p-4 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
                                                <div className="text-xs font-bold text-blue-700 dark:text-blue-300 mb-3 uppercase tracking-wide">Margin Comparison</div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <button onClick={() => { setS(prev => ({ ...prev, targetMarginPct: '20' })); setShowCompare(false); }} className={`bg-white dark:bg-gray-800 rounded-xl p-3 text-center shadow-sm hover:shadow-md transition-all cursor-pointer hover:scale-[1.02] active:scale-[0.98] ${num(s.targetMarginPct) === 20 ? 'ring-2 ring-amber-500' : ''}`}>
                                                        <div className="text-xs text-amber-600 font-bold mb-1">20% Margin</div>
                                                        <div className="text-xl font-black text-gray-900 dark:text-white">{money(applyPriceRule(requiredSellForMargin(20, purchaseInc, num(s.commissionPct), num(s.ppCostGBP), num(s.ppChargedGBP), vatRate), priceRules))}</div>
                                                        <div className="text-xs text-gray-500 mt-1">Profit: {money(applyPriceRule(requiredSellForMargin(20, purchaseInc, num(s.commissionPct), num(s.ppCostGBP), num(s.ppChargedGBP), vatRate), priceRules) - (requiredSellForMargin(20, purchaseInc, num(s.commissionPct), num(s.ppCostGBP), num(s.ppChargedGBP), vatRate) * (1 - 0.20)))}</div>
                                                        <div className="text-[10px] text-amber-500 font-medium mt-2">Tap to select</div>
                                                    </button>
                                                    <button onClick={() => { setS(prev => ({ ...prev, targetMarginPct: '25' })); setShowCompare(false); }} className={`bg-white dark:bg-gray-800 rounded-xl p-3 text-center shadow-sm hover:shadow-md transition-all cursor-pointer hover:scale-[1.02] active:scale-[0.98] ${num(s.targetMarginPct) === 25 ? 'ring-2 ring-emerald-500' : 'ring-1 ring-emerald-500/50 dark:ring-emerald-400/50'}`}>
                                                        <div className="text-xs text-emerald-600 font-bold mb-1">25% Margin ✓</div>
                                                        <div className="text-xl font-black text-gray-900 dark:text-white">{money(applyPriceRule(requiredSellForMargin(25, purchaseInc, num(s.commissionPct), num(s.ppCostGBP), num(s.ppChargedGBP), vatRate), priceRules))}</div>
                                                        <div className="text-xs text-gray-500 mt-1">Profit: {money(applyPriceRule(requiredSellForMargin(25, purchaseInc, num(s.commissionPct), num(s.ppCostGBP), num(s.ppChargedGBP), vatRate), priceRules) - (requiredSellForMargin(25, purchaseInc, num(s.commissionPct), num(s.ppCostGBP), num(s.ppChargedGBP), vatRate) * (1 - 0.25)))}</div>
                                                        <div className="text-[10px] text-emerald-500 font-medium mt-2">Tap to select</div>
                                                    </button>
                                                </div>
                                            </div>
                                        )}

                                        <div className="flex gap-2">
                                            <StableInput value={s.manualTarget || (Number.isFinite(finalSell) ? finalSell.toFixed(2) : '')} onValue={(v) => setS(prev => ({ ...prev, manualTarget: v }))} placeholder="Auto" className="text-lg font-semibold !bg-gray-50 dark:!bg-gray-800 border-2 border-dashed border-gray-300 dark:border-gray-600" />
                                            <button onClick={() => setS(prev => ({ ...prev, manualTarget: '' }))} className="p-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 active:bg-gray-200 dark:active:bg-gray-600 transition-all text-blue-600 dark:text-blue-400 hover:border-blue-400 dark:hover:border-blue-500" title="Reference Price (Auto)"><Icons.Reset className="w-4 h-4" /></button>
                                        </div>
                                        {s.manualTarget && Math.abs(num(s.manualTarget) - requiredSell) > 0.01 && (
                                            <div className="flex items-center gap-2 px-3 py-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                                                <svg className="w-4 h-4 text-blue-600 dark:text-blue-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                                <span className="text-sm font-semibold text-blue-700 dark:text-blue-300">Required @ {s.targetMarginPct}% margin: {money(requiredSell)}</span>
                                            </div>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        {/* Margin Card with Visual Arc */}
                                        <div className="relative p-5 rounded-2xl bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 shadow-sm hover:shadow-lg transition-all group overflow-hidden">
                                            <div className={`absolute inset-0 opacity-10 group-hover:opacity-20 transition-opacity ${marginPct >= 25 ? 'bg-gradient-to-br from-emerald-500 to-teal-500' : marginPct >= 20 ? 'bg-gradient-to-br from-amber-500 to-orange-500' : 'bg-gradient-to-br from-rose-500 to-red-500'}`}></div>
                                            <div className="relative">
                                                <div className="text-sm font-bold text-gray-800 dark:text-gray-200 uppercase tracking-wide mb-2">Margin</div>
                                                <div className="text-3xl font-black ${marginPct >= 25 ? 'bg-gradient-to-r from-emerald-600 to-teal-500 bg-clip-text text-transparent' : marginPct >= 20 ? 'bg-gradient-to-r from-amber-600 to-orange-500 bg-clip-text text-transparent' : 'bg-gradient-to-r from-rose-600 to-red-500 bg-clip-text text-transparent'}">{Number.isFinite(marginPct) ? `${marginPct.toFixed(1)}%` : '—'}</div>
                                            </div>
                                        </div>
                                        {/* Profit Card with Glow */}
                                        <div className="relative p-5 rounded-2xl bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 shadow-sm hover:shadow-lg transition-all group overflow-hidden">
                                            <div className="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-500 opacity-0 group-hover:opacity-10 transition-opacity"></div>
                                            <div className="relative">
                                                <div className="text-sm font-bold text-gray-800 dark:text-gray-200 uppercase tracking-wide mb-2">Profit</div>
                                                <div className="text-3xl font-black bg-gradient-to-r from-gray-900 to-gray-700 dark:from-white dark:to-gray-200 bg-clip-text text-transparent">{Number.isFinite(profit) ? money(profit) : '—'}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="pt-5 border-t border-gray-200 dark:border-gray-700 space-y-2">
                                        {hasPack && (
                                            <div className="flex justify-between items-center">
                                                <span className="text-sm font-bold text-gray-700 dark:text-gray-300">Landed (Pack)</span>
                                                <span className="text-2xl font-black text-indigo-600 dark:text-blue-400">{money(landedPack)}</span>
                                            </div>
                                        )}
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm font-bold text-gray-700 dark:text-gray-300">Landed (Unit)</span>
                                            <span className={hasPack ? "text-lg font-bold text-gray-900 dark:text-white" : "text-2xl font-black text-indigo-600 dark:text-blue-400"}>{money(landedUnit)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="glass-card rounded-3xl md:rounded-2xl p-4 md:p-6 flex flex-col flex-1 ring-1 ring-white/20 dark:ring-white/10 shadow-lg bg-gradient-to-br from-white/80 to-gray-50/50 dark:from-gray-800/80 dark:to-gray-900/50 relative z-10">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 dark:from-transparent dark:to-transparent dark:bg-black shadow-lg shadow-blue-500/30 dark:shadow-none ring-1 ring-white/20 dark:ring-white/10 flex items-center justify-center relative overflow-hidden group">
                                        <div className="absolute inset-0 bg-gradient-to-br from-white/25 to-transparent opacity-100"></div>
                                        <svg className="w-6 h-6 text-white dark:text-blue-500 relative z-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                                    </div>
                                    <h3 className="text-2xl font-bold tracking-tight text-gray-900 dark:text-white">Breakdown</h3>
                                </div>
                                <div className="grid grid-cols-2 gap-2 auto-rows-min">
                                    {/* === CONTAINER SECTION HEADER === */}
                                    <div className="col-span-2 flex items-center gap-2 pb-1.5">
                                        <span className="text-[10px] font-bold text-gray-900 dark:text-white uppercase tracking-wider">Container</span>
                                        <div className="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
                                    </div>
                                    {/* Units */}
                                    <div className="relative group p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-2">
                                                <Icons.Box className="w-4 h-4 text-blue-600 dark:text-blue-400" />
                                                <div>
                                                    <div className="text-xs font-bold text-gray-500 dark:text-gray-400">Units / 40HQ</div>
                                                    <div className="text-lg font-black text-gray-900 dark:text-white tabular-nums">{units.toLocaleString()}</div>
                                                </div>
                                            </div>
                                            <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        </div>
                                        {/* Hover Tooltip */}
                                        <div className="absolute left-0 top-full mt-2 w-72 p-3 bg-white/80 dark:bg-gray-900/80 backdrop-blur-2xl rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-[100]">
                                            <div className="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Calculation:</div>
                                            {s.knowUnits && num(s.unitsPer40HQ) > 0 ? (
                                                <div className="text-xs text-gray-600 dark:text-gray-400">Manual: {num(s.unitsPer40HQ).toLocaleString()} units (you specified)</div>
                                            ) : setVol > 0 ? (
                                                <div className="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                                    <div>• Container: {effCBM.toFixed(2)} m³ usable</div>
                                                    <div>• Carton: {setVol.toFixed(4)} m³ each</div>
                                                    <div>• Cartons fit: {cartonsCount.toLocaleString()}</div>
                                                    <div>• Units per carton: {pack}</div>
                                                    <div className="font-semibold pt-1 text-gray-700 dark:text-gray-300">= {cartonsCount.toLocaleString()} × {pack} = {units.toLocaleString()} units</div>
                                                </div>
                                            ) : (
                                                <div className="text-xs text-amber-600 dark:text-amber-400">Enter dimensions to calculate</div>
                                            )}
                                        </div>
                                    </div>
                                    {/* Cartons */}
                                    <div className="relative group p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-2">
                                                <Icons.Truck className="w-4 h-4 text-orange-600 dark:text-orange-400" />
                                                <div>
                                                    <div className="text-xs font-bold text-gray-500 dark:text-gray-400">Cartons / 40HQ</div>
                                                    <div className="text-lg font-black text-gray-900 dark:text-white tabular-nums">{cartonsCount.toLocaleString()}</div>
                                                </div>
                                            </div>
                                            <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        </div>
                                        <div className="absolute left-0 top-full mt-2 w-72 p-3 bg-white/80 dark:bg-gray-900/80 backdrop-blur-2xl rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-[100]">
                                            <div className="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Calculation:</div>
                                            {setVol > 0 ? (
                                                <div className="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                                    <div>• Container capacity: {effCBM.toFixed(2)} m³</div>
                                                    <div>• Carton volume: {setVol.toFixed(4)} m³</div>
                                                    <div className="font-semibold pt-1 text-gray-700 dark:text-gray-300">= {effCBM.toFixed(2)} ÷ {setVol.toFixed(4)} = {cartonsCount.toLocaleString()} cartons</div>
                                                </div>
                                            ) : (
                                                <div className="text-xs text-amber-600 dark:text-amber-400">Enter carton dimensions to calculate</div>
                                            )}
                                        </div>
                                    </div>
                                    {/* === VOLUME SECTION HEADER === */}
                                    <div className="col-span-2 flex items-center gap-2 pt-2.5 pb-1.5">
                                        <span className="text-[10px] font-bold text-gray-900 dark:text-white uppercase tracking-wider">Volume</span>
                                        <div className="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
                                    </div>
                                    {/* Total CBM */}
                                    <div className="relative group p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-2">
                                                <Icons.Ruler className="w-4 h-4 text-cyan-600 dark:text-cyan-400" />
                                                <div>
                                                    <div className="text-xs font-bold text-gray-500 dark:text-gray-400">CBM / Carton</div>
                                                    <div className="text-lg font-black text-gray-900 dark:text-white tabular-nums">{fmt(setVol, 4)} m³</div>
                                                </div>
                                            </div>
                                            <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        </div>
                                        <div className="absolute left-0 top-full mt-2 w-72 p-3 bg-white/80 dark:bg-gray-900/80 backdrop-blur-2xl rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-[100]">
                                            <div className="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Calculation:</div>
                                            <div className="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                                <div>• Dimensions: {num(s.L)}×{num(s.W)}×{num(s.H)} cm</div>
                                                <div className="font-mono">= ({num(s.L)} × {num(s.W)} × {num(s.H)}) ÷ 1,000,000</div>
                                                <div className="font-semibold pt-1 text-gray-700 dark:text-gray-300">= {setVol.toFixed(6)} m³</div>
                                            </div>
                                        </div>
                                    </div>
                                    {/* CBM Per Unit - only when pack > 1 */}
                                    {hasPack ? (
                                        <div className="relative group p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <Icons.Ruler className="w-4 h-4 text-teal-600 dark:text-teal-400" />
                                                    <div>
                                                        <div className="text-xs font-bold text-gray-500 dark:text-gray-400">CBM / Unit</div>
                                                        <div className="text-lg font-black text-gray-900 dark:text-white tabular-nums">{fmt(setVol / pack, 5)} m³</div>
                                                    </div>
                                                </div>
                                                <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                            </div>
                                            <div className="absolute left-0 top-full mt-2 w-72 p-3 bg-white/80 dark:bg-gray-900/80 backdrop-blur-2xl rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-[100]">
                                                <div className="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Calculation:</div>
                                                <div className="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                                    <div>• Carton CBM: {setVol.toFixed(4)} m³</div>
                                                    <div>• Units per carton: {pack}</div>
                                                    <div className="font-semibold pt-1 text-gray-700 dark:text-gray-300">= {setVol.toFixed(4)} ÷ {pack} = {(setVol / pack).toFixed(6)} m³</div>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        /* Container Utilization when no pack - fills the gap */
                                        <div className="relative group p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <Icons.Ruler className="w-4 h-4 text-violet-600 dark:text-violet-400" />
                                                    <div>
                                                        <div className="text-xs font-bold text-gray-500 dark:text-gray-400">Container Fill</div>
                                                        <div className="text-lg font-black text-gray-900 dark:text-white tabular-nums">{effCBM > 0 && setVol > 0 ? ((setVol * cartonsCount / effCBM) * 100).toFixed(1) : '—'}%</div>
                                                    </div>
                                                </div>
                                                <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                            </div>
                                            <div className="absolute left-0 top-full mt-2 w-72 p-3 bg-white/80 dark:bg-gray-900/80 backdrop-blur-2xl rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-[100]">
                                                <div className="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Calculation:</div>
                                                <div className="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                                    <div>• Used: {(setVol * cartonsCount).toFixed(2)} m³</div>
                                                    <div>• Capacity: {effCBM.toFixed(2)} m³</div>
                                                    <div className="font-semibold pt-1 text-gray-700 dark:text-gray-300">= {effCBM > 0 ? ((setVol * cartonsCount / effCBM) * 100).toFixed(1) : '—'}% utilized</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {/* === COST SECTION HEADER === */}
                                    <div className="col-span-2 flex items-center gap-2 pt-2.5 pb-1.5">
                                        <span className="text-[10px] font-bold text-gray-900 dark:text-white uppercase tracking-wider">Cost</span>
                                        <div className="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
                                    </div>
                                    {/* Purchase Per Unit */}
                                    <div className="relative group p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-2">
                                                <Icons.Money className="w-4 h-4 text-green-600 dark:text-green-400" />
                                                <div>
                                                    <div className="text-xs font-bold text-gray-500 dark:text-gray-400">Purchase / Unit</div>
                                                    <div className="text-lg font-black text-gray-900 dark:text-white tabular-nums">£{num(unitGBP).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                                </div>
                                            </div>
                                            <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        </div>
                                        <div className="absolute left-0 top-full mt-2 w-72 p-3 bg-white/80 dark:bg-gray-900/80 backdrop-blur-2xl rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-[100]">
                                            <div className="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Calculation:</div>
                                            <div className="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                                <div>• Unit price: ${num(s.unitUSD).toFixed(2)} USD</div>
                                                <div>• Exchange rate: 1 GBP = ${fx.toFixed(2)} USD</div>
                                                <div className="font-semibold pt-1 text-gray-700 dark:text-gray-300">= ${num(s.unitUSD).toFixed(2)} ÷ {fx.toFixed(2)} = {money(unitGBP)}</div>
                                            </div>
                                        </div>
                                    </div>
                                    {/* Inbound */}
                                    <div className="relative group p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-2">
                                                <Icons.Money className="w-4 h-4 text-rose-600 dark:text-rose-400" />
                                                <div>
                                                    <div className="text-xs font-bold text-gray-500 dark:text-gray-400">Inbound / Unit</div>
                                                    <div className="text-lg font-black text-gray-900 dark:text-white tabular-nums">{money(perUnitFreight)}</div>
                                                </div>
                                            </div>
                                            <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        </div>
                                        <div className="absolute left-0 top-full mt-2 w-72 p-3 bg-white/80 dark:bg-gray-900/80 backdrop-blur-2xl rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-[100]">
                                            <div className="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Calculation:</div>
                                            {units > 0 ? (
                                                <div className="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                                    <div>• Sea freight: {money(sea)}</div>
                                                    <div>• Total units: {units.toLocaleString()}</div>
                                                    <div className="font-semibold pt-1 text-gray-700 dark:text-gray-300">= {money(sea)} ÷ {units.toLocaleString()} = {money(perUnitFreight)} per unit</div>
                                                    <div className="mt-2 text-gray-500 dark:text-gray-500 italic">This is your shipping cost per unit from factory to warehouse</div>
                                                </div>
                                            ) : (
                                                <div className="text-xs text-amber-600 dark:text-amber-400">Calculate units first</div>
                                            )}
                                        </div>
                                    </div>
                                    {/* Inbound Per Pack - only when pack > 1 */}
                                    {hasPack && (
                                        <div className="col-span-2 relative group p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    <Icons.Box className="w-4 h-4 text-pink-600 dark:text-pink-400" />
                                                    <div>
                                                        <div className="text-xs font-bold text-gray-500 dark:text-gray-400">Inbound / Pack</div>
                                                        <div className="text-lg font-black text-gray-900 dark:text-white tabular-nums">{money(perUnitFreight * pack)}</div>
                                                    </div>
                                                </div>
                                                <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                            </div>
                                            <div className="absolute left-0 top-full mt-2 w-72 p-3 bg-white/80 dark:bg-gray-900/80 backdrop-blur-2xl rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-[100]">
                                                <div className="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Calculation:</div>
                                                <div className="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                                    <div>• Inbound per unit: {money(perUnitFreight)}</div>
                                                    <div>• Units per pack: {pack}</div>
                                                    <div className="font-semibold pt-1 text-gray-700 dark:text-gray-300">= {money(perUnitFreight)} × {pack} = {money(perUnitFreight * pack)}</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                </div>
                            </div>
                            {/* === ORDER FILL CARD (Full Width Layout) === */}
                            {num(s.orderQty) > 0 && setVol > 0 && (
                                <div className="glass-card rounded-2xl p-5 md:p-8 hover:shadow-2xl hover:scale-[1.005] transition-all duration-300 ease-out">
                                    {(() => {
                                        const rawQty = num(s.orderQty);
                                        const isUnits = s.orderMode !== 'cartons';
                                        const orderUnits = isUnits ? rawQty : rawQty * pack;
                                        const orderCartons = isUnits ? Math.ceil(orderUnits / pack) : rawQty;
                                        const orderCBM = orderCartons * setVol;
                                        const fillPct = effCBM > 0 ? (orderCBM / effCBM) * 100 : 0;
                                        const maxCartons = cartonsCount;
                                        const maxUnits = maxCartons * pack;
                                        const unitsToFill = maxUnits - orderUnits;
                                        const containersNeeded = Math.ceil(fillPct / 100);
                                        return (
                                            <div className="space-y-6">
                                                <div className="flex items-center gap-3">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-amber-600 dark:from-transparent dark:to-transparent dark:bg-black shadow-lg shadow-amber-500/30 dark:shadow-none ring-1 ring-white/20 dark:ring-white/10 flex items-center justify-center relative overflow-hidden group">
                                                            <div className="absolute inset-0 bg-gradient-to-br from-white/25 to-transparent opacity-100"></div>
                                                            <svg className="w-6 h-6 text-white dark:text-amber-500 relative z-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                                                        </div>
                                                        <h3 className="text-2xl font-bold tracking-tight text-gray-900 dark:text-white">Order Fill</h3>
                                                        <span className="text-sm font-medium text-gray-500 dark:text-gray-400">({orderUnits.toLocaleString()} units)</span>
                                                    </div>
                                                </div>

                                                <div className="flex items-center gap-4">
                                                    <div className="flex-1">
                                                        <div className="h-3 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                                                            <div className={`h-full rounded-full transition-all duration-500 ${fillPct >= 90 ? 'bg-gradient-to-r from-emerald-400 to-green-500' : fillPct >= 70 ? 'bg-gradient-to-r from-amber-400 to-orange-500' : 'bg-gradient-to-r from-rose-400 to-red-500'}`} style={{ width: `${Math.min(fillPct, 100)}%` }}></div>
                                                        </div>
                                                    </div>
                                                    <div className={`text-xl font-black tabular-nums ${fillPct >= 90 ? 'text-emerald-600 dark:text-emerald-400' : fillPct >= 70 ? 'text-amber-600 dark:text-amber-400' : 'text-rose-600 dark:text-rose-400'}`}>{fillPct.toFixed(1)}%</div>
                                                </div>

                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                                    <div className="p-3 bg-gray-50/50 dark:bg-gray-800/30 rounded-xl border border-gray-100 dark:border-white/5">
                                                        <div className="text-[11px] text-gray-400 font-medium mb-1">Cartons</div>
                                                        <div className="text-lg font-bold text-gray-900 dark:text-white">{orderCartons.toLocaleString()}</div>
                                                    </div>
                                                    <div className="p-3 bg-gray-50/50 dark:bg-gray-800/30 rounded-xl border border-gray-100 dark:border-white/5">
                                                        <div className="text-[11px] text-gray-400 font-medium mb-1">CBM</div>
                                                        <div className="text-lg font-bold text-gray-900 dark:text-white">{orderCBM.toFixed(2)}</div>
                                                    </div>
                                                    <div className="p-3 bg-gray-50/50 dark:bg-gray-800/30 rounded-xl border border-gray-100 dark:border-white/5">
                                                        <div className="text-[11px] text-gray-400 font-medium mb-1">Capacity</div>
                                                        <div className="text-lg font-bold text-gray-900 dark:text-white">{effCBM.toFixed(1)}</div>
                                                    </div>
                                                    <div className="p-3 bg-gray-50/50 dark:bg-gray-800/30 rounded-xl border border-gray-100 dark:border-white/5">
                                                        <div className="text-[11px] text-gray-400 font-medium mb-1">Max Units</div>
                                                        <div className="text-lg font-bold text-gray-900 dark:text-white">{maxUnits.toLocaleString()}</div>
                                                    </div>
                                                </div>

                                                {unitsToFill > 0 && fillPct < 95 && (
                                                    <div className="flex items-center gap-2 text-sm text-amber-700 dark:text-amber-300 bg-amber-50/50 dark:bg-amber-900/20 p-3 rounded-xl border border-amber-100 dark:border-amber-800/30">
                                                        <span>💡</span>
                                                        <span>Add <strong>{unitsToFill.toLocaleString()}</strong> more units to fill container completely</span>
                                                    </div>
                                                )}
                                                {fillPct >= 95 && fillPct <= 100 && (
                                                    <div className="flex items-center gap-2 text-sm text-emerald-700 dark:text-emerald-300 bg-emerald-50/50 dark:bg-emerald-900/20 p-3 rounded-xl border border-emerald-100 dark:border-emerald-800/30 font-medium">
                                                        <span>✓</span>
                                                        <span>Optimal container utilization achieved!</span>
                                                    </div>
                                                )}
                                                {fillPct > 100 && (
                                                    <div className="flex items-center gap-2 text-sm text-rose-700 dark:text-rose-300 bg-rose-50/50 dark:bg-rose-900/20 p-3 rounded-xl border border-rose-100 dark:border-rose-800/30 font-medium">
                                                        <span>⚠️</span>
                                                        <span>Requires {containersNeeded} containers ({(fillPct / containersNeeded).toFixed(1)}% each)</span>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })()}
                                </div>
                            )}
                        </div>



                        {/* iOS 26 Mobile Smart Dashboard Bar */}
                        <div className="md:hidden fixed bottom-0 left-0 right-0 z-50 pb-[env(safe-area-inset-bottom)]">
                            <div className="mx-3 mb-3 flex items-stretch bg-white/80 dark:bg-gray-900/80 backdrop-blur-3xl rounded-3xl shadow-[0_8px_40px_rgba(0,0,0,0.15)] ring-1 ring-black/5 dark:ring-white/10 border border-white/40 dark:border-white/10 overflow-hidden">
                                {/* Target Sell */}
                                {/* Target Sell - Editable Reverse Calc */}
                                <button
                                    className="flex-1 flex flex-col items-center justify-center py-3 border-r border-gray-200/50 dark:border-white/10 active:bg-gray-100 dark:active:bg-white/10 transition-colors"
                                    onClick={() => setEditingTarget(true)}
                                >
                                    <span className="text-[10px] font-medium text-gray-500 dark:text-white/50 uppercase tracking-wide">Target</span>
                                    {editingTarget ? (
                                        <input
                                            autoFocus
                                            type="number"
                                            className="w-20 text-center bg-transparent text-xl font-black text-indigo-600 dark:text-indigo-400 outline-none p-0 border-b-2 border-indigo-500"
                                            placeholder={sell > 0 ? sell.toFixed(2) : '-'}
                                            onBlur={(e) => {
                                                if (e.target.value) setS(prev => ({ ...prev, manualTarget: e.target.value }));
                                                setEditingTarget(false);
                                            }}
                                            onKeyDown={(e) => {
                                                if (e.key === 'Enter') {
                                                    if (e.currentTarget.value) setS(prev => ({ ...prev, manualTarget: e.currentTarget.value }));
                                                    setEditingTarget(false);
                                                }
                                            }}
                                        />
                                    ) : (
                                        <span className={`text-xl font-black tracking-tight ${s.manualTarget ? 'text-indigo-600 dark:text-indigo-400 underline decoration-dotted' : 'text-gray-900 dark:text-white'}`}>
                                            {sell > 0 ? money(sell) : '—'}
                                        </span>
                                    )}
                                </button>
                                {/* Margin - Tappable */}
                                <button onClick={() => setS(prev => ({ ...prev, targetMarginPct: num(prev.targetMarginPct) === 25 ? '20' : '25' }))} className="flex-1 flex flex-col items-center justify-center py-3 border-r border-gray-200/50 dark:border-white/10 active:bg-gray-100 dark:active:bg-white/10 transition-colors">
                                    <span className="text-[10px] font-medium text-gray-500 dark:text-white/50 uppercase tracking-wide">Margin</span>
                                    <span className={`text-xl font-black ${num(s.targetMarginPct) >= 25 ? 'text-emerald-600 dark:text-emerald-400' : 'text-amber-600 dark:text-amber-400'}`}>{s.targetMarginPct}%</span>
                                </button>
                                {/* Profit */}
                                <button className="flex-1 flex flex-col items-center justify-center py-3 active:scale-95 transition-transform" onClick={() => setPriceRulesOpen(true)}>
                                    <div className="flex items-center gap-1">
                                        <span className="text-[10px] font-medium text-gray-500 dark:text-white/50 uppercase tracking-wide">Profit</span>
                                        <span className="text-[9px] bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-1 rounded">Edit</span>
                                    </div>
                                    <span className="text-xl font-black text-emerald-600 dark:text-emerald-400 underline decoration-dotted underline-offset-4 decoration-emerald-300/50">{Number.isFinite(profit) ? '+' + money(profit) : '—'}</span>
                                </button>
                            </div>
                        </div>
                        {/* Price Rules Modal for Simple View */}
                        {priceRulesOpen && setPriceRules && (
                            <div className="fixed inset-0 z-[10000] flex items-end md:items-center md:justify-center">
                                <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setPriceRulesOpen(false)}></div>
                                <div className="relative w-full md:max-w-md bg-white dark:bg-gray-900 rounded-t-3xl md:rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom duration-300">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-bold text-gray-900 dark:text-white">Price Endings</h3>
                                        <button onClick={() => setPriceRulesOpen(false)} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors">✕</button>
                                    </div>
                                    <div className="space-y-3">
                                        <label className="flex items-center gap-2 text-sm font-medium"><input type="checkbox" checked={priceRules.enabled} onChange={(e) => setPriceRules(prev => ({ ...prev, enabled: e.target.checked }))} className="rounded" /> Enable globally</label>
                                        <div><div className="text-xs text-gray-600 dark:text-gray-400 mb-1">Endings (e.g. 0.99)</div><input className="glass-input w-full rounded-lg px-3 py-2 text-sm" value={priceRules.endingsText} onChange={(e) => setPriceRules(prev => ({ ...prev, endingsText: e.target.value }))} /></div>
                                        <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={priceRules.allowDown} onChange={(e) => setPriceRules(prev => ({ ...prev, allowDown: e.target.checked }))} className="rounded" /> Allow rounding down</label>
                                        <div><div className="text-xs text-gray-600 dark:text-gray-400 mb-1">Tolerance (%)</div><input className="glass-input w-full rounded-lg px-3 py-2 text-sm" value={priceRules.tolerancePct} onChange={(e) => setPriceRules(prev => ({ ...prev, tolerancePct: e.target.value }))} /></div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div >

                    {/* iOS 25 Style Sticky Target Sell - DESKTOP ONLY */}
                    < div className={`hidden md:block fixed top-6 left-1/2 -translate-x-1/2 z-40 max-w-[calc(100%-2rem)] transition-all duration-700 ease-[cubic-bezier(0.32,0.72,0,1)] ${stickyVisible ? 'translate-y-0 opacity-100' : '-translate-y-32 opacity-0 pointer-events-none'}`
                    }>
                        <div className="flex items-center gap-4 px-6 py-3 bg-white/60 dark:bg-gray-900/60 backdrop-blur-2xl rounded-full border border-white/40 dark:border-white/10 shadow-[0_8px_32px_rgba(0,0,0,0.12)] ring-1 ring-black/5 dark:ring-white/5 transition-transform hover:scale-105 cursor-default">
                            <div className="flex flex-col items-center leading-none">
                                <span className="text-[9px] font-bold uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-0.5">Target Sell</span>
                            </div>
                            <div className="w-px h-6 bg-gray-300 dark:bg-gray-700/50"></div>
                            <span className="text-xl font-black bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 dark:from-white dark:via-gray-100 dark:to-white bg-clip-text text-transparent filter drop-shadow-sm">
                                {sell > 0 ? money(sell) : '—'}
                            </span>
                            {Number.isFinite(profit) && (
                                <>
                                    <div className="w-px h-6 bg-gray-300 dark:bg-gray-700/50"></div>
                                    <span className="text-xs font-bold text-emerald-600 dark:text-emerald-400">
                                        +{money(profit)}
                                    </span>
                                </>
                            )}
                        </div>
                    </div >

                    {/* iOS-style fixed floating action pill - matches Shipping Settings button */}
                    {
                        active && (
                            <div className="hidden md:flex fixed bottom-8 left-8 btn px-4 py-3 rounded-full bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border border-gray-200/50 dark:border-gray-700/50 shadow-2xl hover:scale-105 hover:bg-white dark:hover:bg-gray-800 transition-all items-center gap-2 z-50">
                                <button onClick={() => setS({ unitUSD: '2.50', unitsPerCarton: '4', knowUnits: false, unitsPer40HQ: '', L: '40', W: '30', H: '25', L2: '', W2: '', H2: '', hasCarton2: false, targetMarginPct: '25', manualTarget: '', ppCostGBP: '', commissionPct: '15.3', vatPct: '20', weightKg: '5', weight2: '', ppSurcharge: '0.50', ppChargedGBP: '0', orderQty: '50', orderMode: 'cartons' })} className="flex items-center gap-2 px-3 py-1.5 text-sm font-bold text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-full transition-all active:scale-95">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                    Example
                                </button>
                                <div className="w-px h-5 bg-gray-200 dark:bg-gray-700"></div>
                                <button onClick={() => setS({ unitUSD: '', unitsPerCarton: '', knowUnits: false, unitsPer40HQ: '', L: '', W: '', H: '', L2: '', W2: '', H2: '', hasCarton2: false, targetMarginPct: '25', manualTarget: '', ppCostGBP: '', commissionPct: '15.3', vatPct: '20', weightKg: '', weight2: '', ppSurcharge: '0.50', ppChargedGBP: '0' })} className="flex items-center gap-2 px-3 py-1.5 text-sm font-bold text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700/50 rounded-full transition-all active:scale-95">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                    Reset
                                </button>
                            </div>
                        )
                    }
                </>
            );
        }

        function BulkView({ g, priceRules, active }) {
            const [rows, setRows] = useState([]);
            const cont = CONTAINER_CBM[g.containerType] || 76;
            const effCBM = cont * (num(g.utilisationPct) / 100);
            const fx = num(g.fxGbpToUsd);
            const sea = num(g.seaFreightGBP);

            const parseDelimited = (raw) => {
                const lines = raw.replace(/\r\n/g, "\n").split("\n").filter(l => l.trim());
                if (!lines.length) return { headers: [], rows: [] };
                const delim = lines[0].includes("\t") ? "\t" : ",";
                const headers = lines[0].split(delim).map(h => h.trim());
                const rows = lines.slice(1).map(l => {
                    const parts = l.split(delim).map(c => c.trim());
                    while (parts.length < headers.length) parts.push("");
                    return parts;
                });
                return { headers, rows };
            };

            const guessMap = (hs) => {
                const lower = hs.map(h => h.trim().toLowerCase());
                const pick = (names) => { for (const n of names) { const i = lower.findIndex(h => h === n || h.includes(n)); if (i !== -1) return hs[i]; } return ''; };
                return {
                    sku: pick(['sku', 'item number', 'item code', 'name', 'title']),
                    unitUSD: pick(['unit usd', 'usd', 'price usd', 'unit price usd', 'fob price']),
                    pack: pick(['units per pack', 'units/pack', 'pack size', 'pack']),
                    unitsPer40HQ: pick(['units per 40hq', 'units/40hq', 'gfq', 'loadability']),
                    L: pick(['l (cm)', 'length', 'l', 'length cm', 'l*w*h']),
                    W: pick(['w (cm)', 'width', 'w', 'width cm']),
                    H: pick(['h (cm)', 'height', 'h', 'height cm']),
                    ppCostGBP: pick(['p&p cost', 'outbound', 'shipping cost', 'pp (gbp)']),
                    marginPct: pick(['target margin', 'margin %'])
                };
            };

            const onFile = (f) => {
                const r = new FileReader();
                r.onload = (e) => {
                    const { headers, rows } = parseDelimited(e.target.result);
                    const map = guessMap(headers);
                    const idx = (k) => headers.indexOf(map[k]);
                    const safe = (r, i) => i >= 0 && i < r.length ? r[i] : '';

                    setRows(rows.map(r => {
                        let L = safe(r, idx('L')), W = safe(r, idx('W')), H = safe(r, idx('H'));
                        if (L && !W && !H && L.match(/[*x\s]/)) {
                            const parts = L.split(/[*x\s]+/).filter(Boolean);
                            if (parts.length >= 3) { L = parts[0]; W = parts[1]; H = parts[2]; }
                        }
                        return {
                            sku: safe(r, idx('sku')),
                            unitUSD: safe(r, idx('unitUSD')),
                            pack: safe(r, idx('pack')) || '1',
                            unitsPer40HQ: safe(r, idx('unitsPer40HQ')),
                            L, W, H,
                            ppCostGBP: safe(r, idx('ppCostGBP')) || '2.70',
                            marginPct: safe(r, idx('marginPct')) || '25'
                        };
                    }));
                };
                r.readAsText(f);
            };

            const computeRow = (r) => {
                const L = num(r.L), W = num(r.W), H = num(r.H);
                const vol = cbm(L, W, H);
                const pack = Math.max(1, num(r.pack));
                let units = num(r.unitsPer40HQ);
                if (units <= 0 && vol > 0) {
                    const cartons = Math.floor(effCBM / vol);
                    units = cartons * pack;
                }
                const unitGBP = fx > 0 ? num(r.unitUSD) / fx : 0;
                const freight = units > 0 ? sea / units : 0;
                const landed = unitGBP + freight;
                const sell = requiredSellForMargin(num(r.marginPct), landed * (pack > 1 ? pack : 1), 15.3, num(r.ppCostGBP), 0);
                return { units, landed, sell, pack };
            };

            return (
                <div className={`space-y-4 ${active ? '' : 'hidden'}`}>
                    <div className="glass-card p-6">
                        <div className="flex items-center gap-4">
                            <label className="btn px-4 py-2 bg-indigo-600 text-white rounded-xl cursor-pointer shadow-lg hover:bg-indigo-700">
                                Upload CSV
                                <input type="file" className="hidden" accept=".csv" onChange={(e) => onFile(e.target.files[0])} />
                            </label>
                            <div className="text-sm text-gray-500 dark:text-gray-400">Supports: SKU, Unit USD, L/W/H, Pack, Units/40HQ</div>
                        </div>
                    </div>
                    {rows.length > 0 && (
                        <div className="glass-card rounded-2xl p-0 overflow-hidden mt-5">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-gray-50 dark:bg-gray-800 text-xs uppercase font-semibold text-gray-500 dark:text-gray-400">
                                        <tr>
                                            <th className="px-4 py-3">SKU</th>
                                            <th className="px-4 py-3">Unit USD</th>
                                            <th className="px-4 py-3">Pack</th>
                                            <th className="px-4 py-3">L×W×H</th>
                                            <th className="px-4 py-3">Landed £</th>
                                            <th className="px-4 py-3">Sell £ (Inc VAT)</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100 dark:divide-gray-700">
                                        {rows.map((r, i) => {
                                            const c = computeRow(r);
                                            return (
                                                <tr key={i} className="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                                                    <td className="px-4 py-3 font-medium">{r.sku}</td>
                                                    <td className="px-4 py-3">${r.unitUSD}</td>
                                                    <td className="px-4 py-3">{r.pack}</td>
                                                    <td className="px-4 py-3 text-gray-500 dark:text-gray-400">{r.L}×{r.W}×{r.H}</td>
                                                    <td className="px-4 py-3 font-semibold">£{fmt(c.landed)}</td>
                                                    <td className="px-4 py-3 font-bold text-indigo-600 dark:text-blue-300">£{fmt(c.sell)}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Helper to calculate row data standalone (for export)
        const calculateRow = (row, g, unused, courierRules, priceRules) => {
            // row is array [price, L, W, H, SKU, Pack, ...]
            const priceUSD = parseFloat(row[0]) || 0;
            const L = parseFloat(row[1]) || 0;
            const W = parseFloat(row[2]) || 0;
            const H = parseFloat(row[3]) || 0;
            const sku = row[4] || '';
            const pack = parseFloat(row[5]) || 1;

            const fx = parseFloat(g?.fxGbpToUsd) || 1.30;
            const sea = parseFloat(g?.seaFreightGBP) || 2800;
            const containerType = g?.containerType || '40HQ';
            const utilisationPct = parseFloat(g?.utilisationPct) || 89.5;
            const cont = 76; // Simplified for now (or import CONTAINER_CBM)
            const effCBM = cont * (utilisationPct / 100);

            const vol = (L / 100) * (W / 100) * (H / 100);
            const cartons = vol > 0 ? Math.floor(effCBM / vol) : 0;
            const units = cartons * pack;

            const unitGBP = fx > 0 ? priceUSD / fx : 0;
            const freight = units > 0 ? sea / units : 0;
            const landedUnit = (unitGBP + freight);
            const landedPack = (landedUnit * pack);
            const purchaseInc = pack > 1 ? landedPack : landedUnit;

            const vatRate = 0.20; // Default
            const ppCharged = 0;
            // Settings hardcoded for export if not passed (BulkQuickView uses local settings)
            const margin = 25;
            const commission = 15.3;
            const ppCost = 2.70;

            // Logic from requiredSellForMargin
            // sell - comm - pp - vat - purchase = margin * sell
            // sell * (1 - margin - comm - vatOnFees?) -> simplified
            // Simplified Reverse Calc:
            // Cost = purchase + ppCost;
            // Revenue = Sell / (1 + vatRate); -> If VAT registered on sales?
            // Let's match the implemented logic in rows map:
            // requiredSellForMargin(margin, purchaseInc, commission, ppCost, ppCharged, vatRate)

            // WE IGNORE COMPLEXITY HERE TO AVOID DEPENDENCIES
            // Just use a simple multiplier for now or try to replicate perfectly?
            // Replicate:
            const targetMarginDec = margin / 100; // 0.25
            const commDec = commission / 100; // 0.153

            // Sell - (Sell * Comm) - PP - Purchase = Sell * Margin
            // Sell * (1 - Comm - Margin) = Purchase + PP
            // Sell = (Purchase + PP) / (1 - Comm - Margin)

            let userSellPrice = (purchaseInc + ppCost) / (1 - commDec - targetMarginDec);
            if (priceRules && priceRules.enabled) {
                // Simple rounding logic if needed
            }

            const profit = (userSellPrice * (1 - commDec)) - ppCost - purchaseInc;

            return {
                landedCost: landedPack.toFixed(2),
                margin: margin,
                profit: profit.toFixed(2),
                userSellPrice: userSellPrice.toFixed(2)
            };
        };

        function BulkQuickView({ g, priceRules, courierRules, active, priceRulesState, setPriceRulesState }) {
            const [pricesText, setPricesText] = useState('');
            const [dimsText, setDimsText] = useState('');
            const [skusText, setSkusText] = useState('');
            const [showAdvanced, setShowAdvanced] = useState(false);
            const [packText, setPackText] = useState('');
            const [weightText, setWeightText] = useState('');
            // Use local settings for margin/comm, but global for defaults if needed. Keeping local for now as per previous design.
            const [settings, setSettings] = useState({ margin: 25, commission: 15.3, ppCost: 2.70 });
            const [expandedRow, setExpandedRow] = useState(null);
            const [copied, setCopied] = useState(false);
            const [sortBy, setSortBy] = useState('order');
            const [starred, setStarred] = useState(new Set());
            const [uploading, setUploading] = useState(false);
            const fileInputRef = React.useRef(null);
            const [priceEnding, setPriceEnding] = useState(null);
            const [priceRulesOpen, setPriceRulesOpen] = useState(false);
            // AI Upload States
            const [aiModalOpen, setAiModalOpen] = useState(false);
            const [aiAnalyzing, setAiAnalyzing] = useState(false);
            const [aiMapping, setAiMapping] = useState(null);
            const [aiProducts, setAiProducts] = useState([]);
            const [aiError, setAiError] = useState(false);
            const [originalSheet, setOriginalSheet] = useState(null);
            const [aiTableFullscreen, setAiTableFullscreen] = useState(false);
            const AI_ENDPOINT = "https://analyzequotesheetv2-f3lqrbycya-uc.a.run.app";

            const cleanNum = (str) => {
                if (typeof str === 'number') return str;
                if (!str) return 0;
                return parseFloat(str.replace(/[^0-9.-]/g, '')) || 0;
            };

            // Currency conversion function
            const convertCurrency = async (amount, fromCurrency = 'USD', toCurrency = 'GBP') => {
                if (!currencyConversion.enabled || !amount) return null;
                
                try {
                    // Check if we have cached rates (valid for 1 hour)
                    const cacheKey = `${fromCurrency}_${toCurrency}`;
                    const cachedRate = currencyConversion.rates[cacheKey];
                    const now = Date.now();
                    
                    if (cachedRate && (now - cachedRate.timestamp) < 3600000) { // 1 hour cache
                        return (amount * cachedRate.rate).toFixed(2);
                    }
                    
                    // Fetch new rate from free API
                    const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${fromCurrency}`);
                    const data = await response.json();
                    
                    if (data.rates && data.rates[toCurrency]) {
                        const rate = data.rates[toCurrency];
                        
                        // Cache the rate
                        setCurrencyConversion(prev => ({
                            ...prev,
                            rates: {
                                ...prev.rates,
                                [cacheKey]: { rate, timestamp: now }
                            }
                        }));
                        
                        return (amount * rate).toFixed(2);
                    }
                } catch (error) {
                    console.error('Currency conversion failed:', error);
                }
                return null;
            };

            const toggleStar = (i) => {
                setStarred(prev => {
                    const next = new Set(prev);
                    if (next.has(i)) next.delete(i);
                    else next.add(i);
                    return next;
                });
            };

            const clearAll = () => {
                setPricesText('');
                setDimsText('');
                setSkusText('');
                setPackText('');
                setWeightText('');
                setStarred(new Set());
                setPriceEnding(null);
            };

            const applyEnding = (ending) => setPriceEnding(ending);

            const getEndedPrice = (price, ending) => {
                if (!ending) return price;
                if (ending === 'round') return Math.round(price);
                if (ending === '.99') return Math.floor(price) + 0.99;
                if (ending === '.95') return Math.floor(price) + 0.95;
                if (ending === '.49') return Math.floor(price) + 0.49;
                return price;
            };

            const rows = useMemo(() => {
                const prices = pricesText.split('\n').map(l => l.trim()).filter(Boolean);
                const dims = dimsText.split('\n').map(l => l.trim());
                const skus = skusText.split('\n').map(l => l.trim());
                const packs = packText.split('\n').map(l => l.trim());
                const weights = weightText.split('\n').map(l => l.trim());

                return prices.map((priceLine, i) => {
                    const priceParts = priceLine.split(/[,\s]+/);
                    const unitUSD = cleanNum(priceParts[0]);
                    const pack = parseInt(priceParts[1] || packs[i]) || 1;
                    const dimLine = dims[i] || '';
                    const dimParts = dimLine.split(/[x,\s-]+/).map(d => parseFloat(d)).filter(d => !isNaN(d));
                    const [L = 0, W = 0, H = 0] = dimParts;
                    const weight = parseFloat(weights[i]) || 0;
                    const sku = skus[i] || '';

                    if (unitUSD <= 0) return null;

                    const fx = num(g?.fxGbpToUsd) || 1.30;
                    const sea = num(g?.seaFreightGBP) || 2800;
                    const containerType = g?.containerType || '40HQ';
                    const utilisationPct = num(g?.utilisationPct) || 89.5;
                    const cont = CONTAINER_CBM[containerType] || 76;
                    const effCBM = cont * (utilisationPct / 100);

                    const vol = (L / 100) * (W / 100) * (H / 100);
                    const cartons = vol > 0 ? Math.floor(effCBM / vol) : 0;
                    const units = cartons * pack;

                    const unitGBP = fx > 0 ? unitUSD / fx : 0;
                    const freight = units > 0 ? sea / units : 0;
                    const landedUnit = round2(unitGBP + freight);
                    const landedPack = round2(landedUnit * pack);
                    const purchaseInc = pack > 1 ? landedPack : landedUnit;

                    const vatRate = VAT_RATE;
                    const ppCharged = 0;

                    const rawSell = requiredSellForMargin(settings.margin, purchaseInc, settings.commission, settings.ppCost, ppCharged, vatRate);
                    const sell = getEndedPrice(rawSell, priceEnding);
                    const profit = sell > 0 ? computeProfit(sell, purchaseInc, settings.commission, settings.ppCost, ppCharged, vatRate) : 0;
                    const marginPct = sell > 0 ? (profit / sell) * 100 : 0;
                    const courier = L > 0 && W > 0 && H > 0 ? chooseCourier(L, W, H, weight, courierRules) : null;
                    const status = marginPct >= settings.margin ? 'good' : marginPct >= 15 ? 'review' : 'low';

                    return { i: i + 1, sku, unitUSD, pack, L, W, H, weight, vol, units, cartons, landedUnit, landedPack, sell, rawSell, profit, marginPct, courier, status, dims: `${L}x${W}x${H}` };
                }).filter(Boolean);
            }, [pricesText, dimsText, skusText, packText, weightText, settings, courierRules, priceEnding, g]);

            const sortedRows = useMemo(() => {
                let sorted = [...rows];
                if (sortBy === 'starred') sorted = sorted.filter(r => starred.has(r.i));
                else if (sortBy === 'margin-asc') sorted.sort((a, b) => a.marginPct - b.marginPct);
                else if (sortBy === 'margin-desc') sorted.sort((a, b) => b.marginPct - a.marginPct);
                else if (sortBy === 'price') sorted.sort((a, b) => b.sell - a.sell);
                return sorted;
            }, [rows, sortBy, starred]);

            const stats = useMemo(() => ({
                total: rows.length,
                good: rows.filter(r => r.status === 'good').length,
                review: rows.filter(r => r.status === 'review').length,
                low: rows.filter(r => r.status === 'low').length,
                starred: starred.size,
                avgMargin: rows.length ? (rows.reduce((s, r) => s + r.marginPct, 0) / rows.length) : 0,
                totalProfit: rows.reduce((s, r) => s + r.profit, 0),
                totalRevenue: rows.reduce((s, r) => s + r.sell, 0)
            }), [rows, starred]);

            const copyAllPrices = () => {
                const prices = rows.map(r => r.sell.toFixed(2)).join('\n');
                navigator.clipboard.writeText(prices);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };



            const exportToCSV = () => {
                const headers = [
                    'ID', 'SKU', 'Starred',
                    'Unit Cost (USD)', 'Pack Size', 'Dims (cm)', 'Vol (m3)',
                    'FOB (GBP)', 'Sea Freight', 'Landed Cost (GBP)',
                    'Rec. Sell (GBP)', 'Net Profit (GBP)', 'Net Margin (%)', 'ROI (%)',
                    'Courier', 'Courier Cost', 'Capacity (Units/40HQ)'
                ];

                const csvRows = sortedRows.map(r => {
                    // Re-derive components for breakdown
                    // Note: These match the hardcoded values in rows calculation
                    const fx = num(g?.fxGbpToUsd) || 1.30;
                    const unitGBP = r.unitUSD / fx;
                    const freight = r.landedUnit - unitGBP;
                    const totalCost = r.sell - r.profit;
                    const roi = totalCost > 0 ? (r.profit / totalCost) * 100 : 0;

                    return [
                        r.i,
                        r.sku,
                        starred.has(r.i) ? 'Yes' : 'No',
                        r.unitUSD.toFixed(2),
                        r.pack,
                        r.dims,
                        r.vol.toFixed(4),
                        unitGBP.toFixed(2),
                        freight.toFixed(2),
                        r.landedUnit.toFixed(2),
                        r.sell.toFixed(2),
                        r.profit.toFixed(2),
                        r.marginPct.toFixed(1) + '%',
                        roi.toFixed(1) + '%',
                        r.courier?.carrier || '-',
                        r.courier?.cost?.toFixed(2) || '-',
                        r.units
                    ];
                });

                // Create formatted CSV with bold headers (using Excel-compatible formatting)
                let csv = '\uFEFF'; // UTF-8 BOM for Excel
                csv += headers.join(',') + '\n';
                csv += csvRows.map(r => r.join(',')).join('\n');

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Meticulous_Pricing_' + new Date().toISOString().split('T')[0] + '.csv';
                a.click();
                URL.revokeObjectURL(url);
            };

            const loadSampleData = () => {
                setPricesText('5.20\n8.50\n12.30, 2');
                setDimsText('50x40x30\n60x45x35\n70x50x40');
                setSkusText('PROD-001\nWIDGET-BLUE\nGADGET-XL');
            };

            // AI-Powered CSV Upload
            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setUploading(true);
                try {
                    const text = await file.text();

                    // Try simple pattern matching first
                    const simpleResult = parseCSVSimple(text);
                    if (simpleResult.success) {
                        populateFromData(simpleResult.data);
                        showNotification('✓ File imported successfully', 'success');
                        setUploading(false);
                        return;
                    }

                    // Fallback to AI parsing
                    const aiResult = await parseWithAI(text);
                    populateFromData(aiResult);
                    showNotification('✓ File imported with AI', 'success');
                } catch (error) {
                    showNotification('✗ Import failed: ' + error.message, 'error');
                } finally {
                    setUploading(false);
                }
            };

            const parseCSVSimple = (text) => {
                try {
                    const lines = text.split('\n').filter(l => l.trim());
                    if (lines.length < 2) return { success: false };

                    // Detect delimiter (Tab for Excel, Comma for CSV)
                    const delim = lines[0].includes('\t') ? '\t' : ',';

                    const headers = lines[0].toLowerCase().split(delim).map(h => h.trim());
                    const findCol = (variations) => {
                        for (const v of variations) {
                            const idx = headers.findIndex(h => h.includes(v));
                            if (idx >= 0) return idx;
                        }
                        return -1;
                    };

                    const cols = {
                        sku: findCol(['sku', 'item', 'product', 'code']),
                        price: findCol(['price', 'unit', 'fob', 'cost', 'usd']),
                        l: findCol(['length', 'l', 'l(cm)']),
                        w: findCol(['width', 'w', 'w(cm)']),
                        h: findCol(['height', 'h', 'h(cm)']),
                        pack: findCol(['pack', 'qty', 'quantity'])
                    };

                    if (cols.price < 0 || cols.l < 0) return { success: false };

                    const data = lines.slice(1).map(line => {
                        const vals = line.split(delim).map(v => v.trim());
                        return {
                            sku: cols.sku >= 0 ? vals[cols.sku] : '',
                            unitUSD: cleanNum(vals[cols.price]),
                            L: parseFloat(vals[cols.l]) || 0,
                            W: cols.w >= 0 ? parseFloat(vals[cols.w]) : 0,
                            H: cols.h >= 0 ? parseFloat(vals[cols.h]) : 0,
                            pack: cols.pack >= 0 ? parseInt(vals[cols.pack]) : 1
                        };
                    }).filter(d => d.unitUSD > 0);

                    return { success: true, data };
                } catch (e) {
                    return { success: false };
                }
            };

            const parseSmartData = (text) => {
                // Robust Local "AI" - Heuristic Parser
                const lines = text.split(/\r?\n/).filter(l => l.trim());
                if (lines.length === 0) return [];
                const data = [];

                // Detect delimiter
                const firstLine = lines[0];
                const delim = firstLine.includes('\t') ? '\t' : firstLine.includes(',') ? ',' : ' ';

                // Strategy 1: Column Headers
                const headers = lines[0].toLowerCase().split(delim).map(h => h.trim());
                const colMap = {
                    sku: headers.findIndex(h => /sku|item|product|code|name/.test(h)),
                    price: headers.findIndex(h => /price|cost|usd|unit|fob/.test(h)),
                    l: headers.findIndex(h => /length|l\b|len/.test(h)),
                    w: headers.findIndex(h => /width|w\b|wid/.test(h)),
                    h: headers.findIndex(h => /height|h\b|hei/.test(h)),
                    pack: headers.findIndex(h => /pack|qty|quantity/.test(h))
                };

                const hasHeaders = colMap.price >= 0 || (colMap.l >= 0 && colMap.w >= 0);

                if (hasHeaders) {
                    // Use header mapping
                    for (let i = 1; i < lines.length; i++) {
                        const vals = lines[i].split(delim).map(v => v.trim());
                        if (vals.length < 2) continue;
                        const p = parseFloat(cleanNum(vals[colMap.price]));
                        if (p > 0) {
                            data.push({
                                sku: colMap.sku >= 0 ? vals[colMap.sku] : '',
                                unitUSD: p,
                                L: colMap.l >= 0 ? parseFloat(vals[colMap.l]) || 0 : 0,
                                W: colMap.w >= 0 ? parseFloat(vals[colMap.w]) || 0 : 0,
                                H: colMap.h >= 0 ? parseFloat(vals[colMap.h]) || 0 : 0,
                                pack: colMap.pack >= 0 ? parseInt(vals[colMap.pack]) || 1 : 1
                            });
                        }
                    }
                } else {
                    // Strategy 2: Pattern Matching (No headers)
                    // Look for patterns: SKU (text), Price (currency/decimal), Dims (3 numbers)
                    for (const line of lines) {
                        const parts = line.split(delim).map(s => s.trim()).filter(Boolean);
                        const nums = parts.map(p => parseFloat(cleanNum(p))).filter(n => !isNaN(n));

                        if (nums.length >= 1) {
                            // Guess fields based on value magnitude and count
                            const price = nums.find(n => n < 1000 && n > 0.1) || 0; // Assume price is reasonable
                            const dims = nums.filter(n => n > 5 && n !== price).slice(0, 3); // Dims usually > 5cm
                            const sku = parts.find(p => isNaN(parseFloat(p))) || ''; // First non-number

                            if (price > 0) {
                                data.push({
                                    sku: sku,
                                    unitUSD: price,
                                    L: dims[0] || 0,
                                    W: dims[1] || 0,
                                    H: dims[2] || 0,
                                    pack: nums.find(n => Number.isInteger(n) && n >= 1 && n <= 1000 && n !== price && !dims.includes(n)) || 1
                                });
                            }
                        }
                    }
                }
                return data;
            };

            const loadExample = () => {
                const samplePrices = "12.50\n8.99\n45.00\n120.00\n5.50\n18.90";
                const sampleDims = "40x30x20\n20x15x10\n100x50x50\n60x40x40\n10x10x5\n30x20x15";
                const sampleSkus = "SKU-001\nSKU-002\nSKU-003\nSKU-004\nSKU-005\nSKU-006";
                const samplePacks = "10\n24\n1\n2\n50\n12";
                const sampleWeights = "5\n0.5\n15\n8\n0.2\n2";

                // Update React State
                setPricesText(samplePrices);
                setDimsText(sampleDims);
                setSkusText(sampleSkus);
                setPackText(samplePacks);
                setWeightText(sampleWeights);

                // Force Jspreadsheet Update (use setTimeout to ensure DOM is ready)
                setTimeout(() => {
                    const container = document.getElementById('jspreadsheet-container');
                    if (container && container.jspreadsheet) {
                        const data = [
                            ['12.50', '40', '30', '20', 'SKU-001', '10', '5'],
                            ['8.99', '20', '15', '10', 'SKU-002', '24', '0.5'],
                            ['45.00', '100', '50', '50', 'SKU-003', '1', '15'],
                            ['120.00', '60', '40', '40', 'SKU-004', '2', '8'],
                            ['5.50', '10', '10', '5', 'SKU-005', '50', '0.2'],
                            ['18.90', '30', '20', '15', 'SKU-006', '12', '2']
                        ];
                        while (data.length < 25) data.push(['', '', '', '', '', '', '']);
                        container.jspreadsheet.setData(data);
                    }
                }, 100);
                showNotification('Example data loaded', 'success');
            };

            const handleClearAll = () => {
                setPricesText('');
                setDimsText('');
                setSkusText('');
                setPackText('');
                setWeightText('');
                setStarred(new Set());
                setOriginalSheet(null);

                setTimeout(() => {
                    const container = document.getElementById('jspreadsheet-container');
                    if (container && container.jspreadsheet) {
                        const emptyData = Array(25).fill(null).map(() => ['', '', '', '', '', '', '']);
                        container.jspreadsheet.setData(emptyData);
                    }
                }, 100);
                showNotification('Data cleared', 'success');
            };

            // AI-Powered XLSX Upload Handler
            const handleAIUpload = async (file) => {
                if (!file) return;

                const isXLSX = file.name.match(/\.(xlsx|xls)$/i);
                if (!isXLSX) {
                    // Fallback to simple CSV parsing
                    const text = await file.text();
                    const data = parseSmartData(text);
                    if (data.length > 0) {
                        populateFromData(data);
                        showNotification(`✓ Imported ${data.length} items`, 'success');
                    } else {
                        showNotification('Could not parse file', 'error');
                    }
                    return;
                }

                setAiAnalyzing(true);
                setAiModalOpen(true);
                setAiProducts([]);
                setAiMapping(null);
                setPricesText(''); // Clear manual input

                try {
                    // 1. Read File with ExcelJS to get Images & Data
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(arrayBuffer);
                    const worksheet = workbook.worksheets[0];

                    // Enhanced Image Extraction
                    const images = {}; // row -> {url, metadata}
                    const imageMetadata = [];
                    
                    console.log("🖼️ Extracting images from Excel file...");
                    worksheet.getImages().forEach((img, index) => {
                        try {
                            // ExcelJS Image linkage with enhanced metadata
                            const rowIdx = Math.floor(img.range.tl.nativeRow); // 0-based row
                            const colIdx = Math.floor(img.range.tl.nativeCol); // 0-based column
                            const imageId = img.imageId;
                            const imgData = workbook.getImage(imageId);
                            
                            // Create blob with proper MIME type
                            const mimeType = imgData.extension === 'png' ? 'image/png' : 
                                           imgData.extension === 'jpg' || imgData.extension === 'jpeg' ? 'image/jpeg' :
                                           imgData.extension === 'gif' ? 'image/gif' : 'image/png';
                            
                            const blob = new Blob([imgData.buffer], { type: mimeType });
                            const imageUrl = URL.createObjectURL(blob);
                            
                            // Store with enhanced metadata
                            const imageInfo = {
                                url: imageUrl,
                                row: rowIdx,
                                col: colIdx,
                                extension: imgData.extension,
                                size: imgData.buffer.length,
                                width: img.range.br.nativeCol - img.range.tl.nativeCol,
                                height: img.range.br.nativeRow - img.range.tl.nativeRow
                            };
                            
                            images[rowIdx] = imageInfo;
                            imageMetadata.push(imageInfo);
                            
                            console.log(`📸 Image ${index + 1}: Row ${rowIdx}, Col ${colIdx}, Size: ${(imgData.buffer.length / 1024).toFixed(1)}KB`);
                        } catch (error) {
                            console.error(`❌ Failed to extract image ${index + 1}:`, error);
                        }
                    });
                    
                    console.log(`✅ Extracted ${imageMetadata.length} images from Excel file`);

                    // Convert to JSON for AI (Simple text map)
                    // We stick to simple text for the AI prompt to keep payload small
                    // But we keep 'worksheet' index reference to map images back.
                    const jsonData = [];
                    worksheet.eachRow((row, rowNumber) => {
                        const rowObj = {};
                        row.eachCell((cell, colNumber) => {
                            // Simple text extraction
                            rowObj[colNumber] = cell.value; // Store by Column Index for simplicity
                        });
                        jsonData.push(rowObj);
                    });

                    // Prepare for AI
                    // We need a simple array of arrays for the current prompt structure
                    // Or array of objects? The current prompt expects 2D array for table generation.
                    const simpleRows = [];
                    worksheet.eachRow((row, rowNumber) => {
                        const vals = [];
                        row.eachCell((cell) => vals.push(cell.text || cell.value));
                        simpleRows.push(vals);
                    });

                    // 2. Call AI
                    // Convert simpleRows to CSV-like or just JSON for the prompt builder
                    // Existing logic uses 'xlsx' util which makes array of arrays. 
                    // Let's emulate that structure:
                    const aiPayloadBase64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });

                    // Call Cloud Function using Lightweight JSON mode (Definitive 503 fix)
                    const response = await fetch(AI_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            rows: simpleRows.slice(0, 1000),
                            preview: true
                        })
                    });

                    if (!response.ok) {
                        const body = await response.text();
                        throw new Error(`AI Service Error ${response.status}: ${body || response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        setAiMapping(result.mapping);

                        // 3. Full Semantic Extraction
                        const fullResponse = await fetch(AI_ENDPOINT, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                rows: simpleRows.slice(0, 1000),
                                preview: false
                            })
                        });
                        const fullResult = await fullResponse.json();

                        if (fullResult.products) {
                            // UNIVERSAL MAPPING & FILTERING
                            const universalProducts = fullResult.products.map(p => {
                                // Match Image (AI doesn't know row numbers perfectly, assuming 1:1 seq or smart match)
                                // If AI returns index/row, we use it. 
                                // Current AI returns just the list.
                                // We'll try to match by Order if we trust the AI kept the sequence. 
                                // "It assumes rows align perfectly 1:1 with extracted products" - comment from before.
                                // Let's try to pass the 'row' index if AI provided it, otherwise use sequence.
                                return p;
                            });

                            // Strict but Safe Filtering
                            const cleanProducts = universalProducts.filter(p => {
                                const sku = (p.sku || '').toString().toLowerCase();
                                // REMOVED strict Price Check -> Now allowing Price=0 if SKU exists
                                // 1. Remove Garbage
                                if (sku.includes('total') || sku.includes('subtotal') || sku.includes('grand total')) return false;
                                if (sku === 'flyer' || sku === 'catalog') return false;
                                return true;
                            });

                            // Inject Images (Stateful Hack: Add image property to product)
                            // We need to know which row came from which Excel row.
                            // The AI prompt usually skips header.
                            // Header Row = fullResult.originalData.headerRow
                            const headerRowIdx = fullResult.originalData?.headerRow || 0;

                            const finalProducts = cleanProducts.map((p, i) => {
                                // Enhanced Image Association Logic
                                const estExcelRow = headerRowIdx + 1 + i; // Estimated row in Excel (0-based)
                                
                                // Smart image matching with multiple strategies
                                let imageInfo = null;
                                
                                // Strategy 1: Exact row match
                                if (images[estExcelRow]) {
                                    imageInfo = images[estExcelRow];
                                    console.log(`📸 Exact match: Product ${i} -> Row ${estExcelRow}`);
                                }
                                // Strategy 2: Adjacent row search (±2 rows)
                                else {
                                    for (let offset = -2; offset <= 2; offset++) {
                                        const checkRow = estExcelRow + offset;
                                        if (images[checkRow]) {
                                            imageInfo = images[checkRow];
                                            console.log(`📸 Adjacent match: Product ${i} -> Row ${checkRow} (offset: ${offset})`);
                                            break;
                                        }
                                    }
                                }
                                
                                // Strategy 3: SKU-based matching (if image filename contains SKU)
                                if (!imageInfo && p.sku) {
                                    const matchingImage = imageMetadata.find(img => {
                                        // Check if any cell in the image's row contains the SKU
                                        const rowData = simpleRows[img.row] || [];
                                        return rowData.some(cell => 
                                            String(cell).toLowerCase().includes(p.sku.toLowerCase())
                                        );
                                    });
                                    if (matchingImage) {
                                        imageInfo = matchingImage;
                                        console.log(`📸 SKU match: Product ${p.sku} -> Row ${matchingImage.row}`);
                                    }
                                }
                                
                                return { 
                                    ...p, 
                                    image: imageInfo?.url || null,
                                    imageMetadata: imageInfo ? {
                                        row: imageInfo.row,
                                        col: imageInfo.col,
                                        size: imageInfo.size,
                                        extension: imageInfo.extension
                                    } : null
                                };
                            });

                            setAiProducts(finalProducts);

                            setOriginalSheet(prev => ({
                                ...prev,
                                aiData: {
                                    headerRow: headerRowIdx,
                                    mapping: fullResult.mapping,
                                    products: finalProducts
                                }
                            }));
                        }
                    } else {
                        throw new Error(result.error || 'AI analysis failed');
                    }

                } catch (error) {
                    console.error('AI Analysis Error:', error);
                    // DIAGNOSTIC ALERT: Show the exact error to the user
                    alert("⚠️ SYSTEM ERROR: " + error.message + "\n\nThis is a diagnostic message. Please tell me what this says.");

                    // Fallback to local parsing
                    setAiAnalyzing(false);
                    setAiError(true);
                    showNotification('AI failed, using local parser...', 'warning');

                    // FALLBACK: Local Parsing with XLSX (SheetJS)
                    try {
                        const buffer = await file.arrayBuffer();
                        const workbook = XLSX.read(buffer, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet);

                        // Smart local extraction
                        const products = json.map(row => {
                            const keys = Object.keys(row);
                            const findKey = (patterns) => keys.find(k => patterns.some(p => k.toLowerCase().includes(p)));

                            const priceKey = findKey(['price', 'fob', 'usd', 'cost', 'unit']);
                            const skuKey = findKey(['sku', 'item', 'code', 'product', 'name']);
                            const lKey = findKey(['length', ' l', 'l(cm)']);
                            const wKey = findKey(['width', ' w', 'w(cm)']);
                            const hKey = findKey(['height', ' h', 'h(cm)']);
                            const packKey = findKey(['pack', 'qty', 'quantity', 'carton', 'packing']);

                            // Handle combined dimensions
                            let L = 0, W = 0, H = 0;
                            const dimKey = findKey(['size', 'dimension', 'carton size', 'meas']);
                            if (dimKey && row[dimKey]) {
                                const dims = String(row[dimKey]).match(/[\d.]+/g);
                                if (dims && dims.length >= 3) {
                                    L = parseFloat(dims[0]) || 0;
                                    W = parseFloat(dims[1]) || 0;
                                    H = parseFloat(dims[2]) || 0;
                                }
                            } else {
                                L = lKey ? parseFloat(String(row[lKey]).replace(/[^0-9.-]/g, '')) || 0 : 0;
                                W = wKey ? parseFloat(String(row[wKey]).replace(/[^0-9.-]/g, '')) || 0 : 0;
                                H = hKey ? parseFloat(String(row[hKey]).replace(/[^0-9.-]/g, '')) || 0 : 0;
                            }

                            // APPLY SAME FIXES AS AI PATH
                            // 1. MM Sanitizer
                            if (L > 400) L = L / 10;
                            if (W > 400) W = W / 10;
                            if (H > 400) H = H / 10;

                            // 2. Pack Regex Parser
                            let packQty = 1;
                            if (packKey && row[packKey]) {
                                const packRaw = String(row[packKey]).toUpperCase();
                                // If "1PC" or "1 SET", force to 1
                                if (packRaw.includes('1PC') || packRaw.includes('1 PC') || packRaw.includes('1 SET') || packRaw.includes('1SET')) {
                                    packQty = 1;
                                }
                                // Otherwise try regex
                                else {
                                    const match = packRaw.match(/(\d+)\s*(PC|SET|PCS)/);
                                    if (match && match[1]) {
                                        packQty = parseInt(match[1]);
                                    } else {
                                        // Fallback to simple number extraction
                                        packQty = parseInt(String(row[packKey]).replace(/[^0-9]/g, '')) || 1;
                                    }
                                }
                            }

                            return {
                                sku: skuKey ? String(row[skuKey] || '') : '',
                                unitPrice: priceKey ? parseFloat(String(row[priceKey]).replace(/[^0-9.-]/g, '')) || 0 : 0,
                                length: L,
                                width: W,
                                height: H,
                                pack: packQty
                            };
                        }).filter(p => p.unitPrice > 0 || p.sku);

                        if (products.length > 0) {
                            setAiProducts(products);
                            setAiMapping({ note: 'Local parsing (AI unavailable)' });
                        } else {
                            throw new Error('No valid products found locally');
                        }
                    } catch (localError) {
                        showNotification('Failed to parse file: ' + error.message, 'error');
                        setAiModalOpen(false);
                    }
                } finally {
                    setAiAnalyzing(false);
                }
            };

            const applyAIProducts = () => {
                console.log('=== DEBUG: applyAIProducts START ===');
                console.log('aiProducts count:', aiProducts.length);
                console.log('First product raw:', JSON.stringify(aiProducts[0], null, 2));

                const data = aiProducts.map(p => {
                    console.log('Processing product:', p.sku, 'carton:', p.cartonLength, 'local:', p.length);

                    // Extract BOTH dimension sets (AI uses cartonLength, Local uses length)
                    let productL = parseFloat(p.productLength) || 0;
                    let productW = parseFloat(p.productWidth) || 0;
                    let productH = parseFloat(p.productHeight) || 0;

                    // PRIORITIZE AI CARTON DIMS, FALLBACK TO LOCAL DIMS (p.length)
                    // Local parser uses: length, width, height, cbm
                    let cartonL = parseFloat(p.cartonLength) || parseFloat(p.length) || 0;
                    let cartonW = parseFloat(p.cartonWidth) || parseFloat(p.width) || 0;
                    let cartonH = parseFloat(p.cartonHeight) || parseFloat(p.height) || 0;

                    // If we only have product dims and no carton/local dims, use product dims as carton dims
                    if (cartonL === 0 && productL > 0) {
                        cartonL = productL;
                        cartonW = productW;
                        cartonH = productH;
                    }

                    // Supplier's CBM (if provided)
                    const supplierCBM = parseFloat(p.supplierCBM) || parseFloat(p.cbm) || null;

                    // --- INTELLIGENT PROCESSING ---

                    // 1. If no carton dims but we have product dims, use product as fallback (with warning flag)
                    let usingProductDims = false;
                    if ((cartonL === 0 || cartonW === 0 || cartonH === 0) && (productL > 0 || productW > 0 || productH > 0)) {
                        cartonL = productL;
                        cartonW = productW;
                        cartonH = productH;
                        usingProductDims = true;
                    }

                    // 2. Dims Text Fallback (if both sets missing)
                    if ((cartonL === 0 || cartonW === 0 || cartonH === 0) && p.dims_text) {
                        const match = p.dims_text.match(/(\d+[.]?\d*)\s*[x*X]\s*(\d+[.]?\d*)\s*[x*X]\s*(\d+[.]?\d*)/);
                        if (match && match.length >= 4) {
                            cartonL = parseFloat(match[1]);
                            cartonW = parseFloat(match[2]);
                            cartonH = parseFloat(match[3]);
                        }
                    }

                    // 3. MM Sanitizer (apply to BOTH sets)
                    if (productL > 400) productL = productL / 10;
                    if (productW > 400) productW = productW / 10;
                    if (productH > 400) productH = productH / 10;

                    if (cartonL > 400) cartonL = cartonL / 10;
                    if (cartonW > 400) cartonW = cartonW / 10;
                    if (cartonH > 400) cartonH = cartonH / 10;

                    // 4. Pack Regex Parser
                    let packQty = parseFloat(p.pack) || 1;
                    const packRaw = (p.pack_text || '').toString().toUpperCase();

                    if (packRaw.includes('1PC') || packRaw.includes('1 PC') || packRaw.includes('1 SET') || packRaw.includes('1SET')) {
                        packQty = 1;
                    }
                    else {
                        const match = packRaw.match(/(\d+)\s*(PC|SET|PCS)/);
                        if (match && match[1]) {
                            packQty = parseInt(match[1]);
                        }
                    }

                    // 5. Calculate OUR CBM from CARTON dimensions
                    const ourCBM = (cartonL * cartonW * cartonH) / 1000000;

                    // 6. CBM Fact-Check
                    let cbmDiscrepancy = null;
                    if (supplierCBM && ourCBM > 0) {
                        const diff = Math.abs(supplierCBM - ourCBM);
                        const pctDiff = (diff / supplierCBM) * 100;
                        if (pctDiff > 10) {
                            cbmDiscrepancy = {
                                supplier: supplierCBM,
                                ours: ourCBM,
                                pctDiff: pctDiff.toFixed(1)
                            };
                        }
                    }

                    // 7. Handle Split Packing (use supplier CBM if significantly larger)
                    let freightL = cartonL;
                    let freightW = cartonW;
                    let freightH = cartonH;
                    let usedVirtualCube = false;

                    if (supplierCBM && supplierCBM > (ourCBM * 1.2)) {
                        // Multi-carton detected, use virtual cube from supplier CBM
                        const side = Math.round(Math.pow(supplierCBM * 1000000, 1 / 3));
                        freightL = side;
                        freightW = side;
                        freightH = side;
                        usedVirtualCube = true;
                    }

                    return {
                        sku: p.sku || '',
                        unitUSD: parseFloat(p.unitPrice || 0).toFixed(2),
                        // Store both dimension sets
                        productL: productL,
                        productW: productW,
                        productH: productH,
                        // Use CARTON dims for freight
                        L: freightL,
                        W: freightW,
                        H: freightH,
                        pack: packQty,
                        // Weight & CBM
                        weight: parseFloat(p.grossWeight || 0).toFixed(2),
                        supplierCBM: supplierCBM ? parseFloat(supplierCBM).toFixed(2) : null,
                        ourCBM: parseFloat(ourCBM.toFixed(4)),
                        cbmDiscrepancy: cbmDiscrepancy,
                        // Flags
                        usingProductDims: usingProductDims,
                        usedVirtualCube: usedVirtualCube,
                        image: p.image || null
                    };
                });
                // Helper to populate grid
                populateFromData(data);

                // Map weight to a hidden column if possible or just keep it in state?
                // Current grid doesn't show weight per item. We'll skip for grid but keep in aiData for export.

                // Update jspreadsheet
                setTimeout(() => {
                    const container = document.getElementById('jspreadsheet-container');
                    if (container && container.jspreadsheet) {
                        const spreadsheetData = data.map(d => [
                            d.image || '', // Image Col
                            String(d.unitUSD || ''),
                            String(d.L || ''),
                            String(d.W || ''),
                            String(d.H || ''),
                            d.sku || '',
                            String(d.pack > 1 ? d.pack : ''),
                            '' // Weight (Notes/Hidden)
                        ]);
                        while (spreadsheetData.length < 25) spreadsheetData.push(['', '', '', '', '', '', '', '']); // 8 cols
                        container.jspreadsheet.setData(spreadsheetData);
                    }
                }, 100);

                setAiModalOpen(false);
                showNotification(`✓ Imported ${aiProducts.length} products via AI`, 'success');
            };

            const exportToExcel = async () => {
                const container = document.getElementById('jspreadsheet-container');
                if (!container || !container.jspreadsheet) return;

                const data = container.jspreadsheet.getData();
                // Filter empty rows
                const activeRows = data.filter(r => (r[0] && r[0] !== '') || (r[4] && r[4] !== ''));

                if (activeRows.length === 0) {
                    showNotification('No data to export', 'error');
                    return;
                }

                const wb = new ExcelJS.Workbook();
                let ws;

                // Check if we have an original Linked Sheet to append to
                if (originalSheet && originalSheet.buffer && originalSheet.aiData) {
                    try {
                        // Load original workbook
                        await wb.xlsx.load(originalSheet.buffer);
                        ws = wb.getWorksheet(originalSheet.sheetName) || wb.worksheets[0];

                        // Determine insertion point
                        // If AI detected a header row, we append new columns to the RIGHT of existing data
                        // We assume rows align perfectly 1:1 with extracted products
                        // If user deleted/moved rows, alignment might be off. 
                        // We'll trust the order for now (MVP).

                        const headerRowIdx = originalSheet.aiData.headerRow + 1; // 1-based for ExcelJS
                        const startColIdx = originalSheet.rawData[0].length + 1; // Append after last col
                        const dataStartRow = headerRowIdx + 1;

                        // Add Headers for new analysis columns
                        const headers = ['Weight (KG)', 'Vol (CBM)', 'Landed Cost', 'Margin %', 'Profit', 'Target Sell'];
                        headers.forEach((h, i) => {
                            const cell = ws.getCell(headerRowIdx, startColIdx + i);
                            cell.value = h;
                            cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF6366F1' } };
                            cell.border = { bottom: { style: 'thin' } };
                        });

                        // Write Data
                        activeRows.forEach((row, i) => {
                            // row context
                            const priceUSD = parseFloat(row[0]) || 0;
                            // Note: dimensions here are already the "Virtual Cube" if applied in applyAIProducts
                            const L = parseFloat(row[1]) || 0;
                            const W = parseFloat(row[2]) || 0;
                            const H = parseFloat(row[3]) || 0;
                            const sku = (row[4] || '').toString();
                            const pack = parseFloat(row[5]) || 1;

                            // Re-match with AI product to get Weight/CBM if available
                            // Simplistic matching by SKU, or index if perfect alignment
                            // For strict 1:1, we can rely on index 'i' if we haven't filtered differently
                            // But cleaner to lookup:
                            const aiProd = originalSheet.aiData.products.find(p => (p.sku || '').toString() === sku);
                            const weight = aiProd ? (aiProd.weight || 0) : 0;
                            const cbm = aiProd ? (aiProd.cbm || 0) : 0;

                            // Calculate result for this row
                            // Pass weight to calculateRow if we ever use it there
                            const { landedCost, profit, margin, userSellPrice } = calculateRow(row, g, 0, courierRules, priceRules.enabled ? priceRules : null);

                            const rowIdx = dataStartRow + i;

                            // Write calculated values
                            ws.getCell(rowIdx, startColIdx).value = weight || '-';
                            ws.getCell(rowIdx, startColIdx + 1).value = cbm || '-';
                            ws.getCell(rowIdx, startColIdx + 2).value = landedCost;
                            ws.getCell(rowIdx, startColIdx + 3).value = (margin / 100);
                            ws.getCell(rowIdx, startColIdx + 3).numFmt = '0.0%';
                            ws.getCell(rowIdx, startColIdx + 4).value = profit;
                            ws.getCell(rowIdx, startColIdx + 5).value = userSellPrice;

                            // Optional styling
                            [2, 4, 5].forEach(off => {
                                ws.getCell(rowIdx, startColIdx + off).numFmt = '£#,##0.00';
                            });
                        });

                        showNotification('Exporting Linked Sheet (Preserving Original)...', 'success');
                    } catch (e) {
                        console.error("Export Linked Error", e);
                        showNotification('Failed to modify original. Exporting fresh.', 'error');
                        // Fallback to fresh export below
                        ws = wb.addWorksheet('Landed Cost');
                        setupFreshExport(ws, activeRows);
                    }
                } else {
                    // Fresh Export (Standard)
                    ws = wb.addWorksheet('Landed Cost');
                    setupFreshExport(ws, activeRows);
                }

                // Save
                const buffer = await wb.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = originalSheet ? `Landed_${originalSheet.filename}` : 'Landed_Cost_Export.xlsx';
                a.click();
                window.URL.revokeObjectURL(url);
            };

            // Helper for fresh export (no linked sheet)
            const setupFreshExport = (ws, rows) => {
                ws.columns = [
                    { header: 'Unit Price (USD)', key: 'price', width: 15 },
                    { header: 'L (cm)', key: 'l', width: 10 },
                    { header: 'W (cm)', key: 'w', width: 10 },
                    { header: 'H (cm)', key: 'h', width: 10 },
                    { header: 'SKU', key: 'sku', width: 15 },
                    { header: 'Pack', key: 'pack', width: 8 },
                    { header: 'Landed (GBP)', key: 'landed', width: 15 },
                    { header: 'Margin %', key: 'margin', width: 12 },
                    { header: 'Profit (GBP)', key: 'profit', width: 15 },
                    { header: 'Target Sell', key: 'sell', width: 15 }
                ];

                // Add Header Style
                ws.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
                ws.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4F46E5' } };

                rows.forEach(row => {
                    const { landedCost, profit, margin, userSellPrice } = calculateRow(row, g, 0, courierRules, priceRules.enabled ? priceRules : null);
                    ws.addRow({
                        price: parseFloat(row[0]) || 0,
                        l: parseFloat(row[1]) || 0,
                        w: parseFloat(row[2]) || 0,
                        h: parseFloat(row[3]) || 0,
                        sku: row[4],
                        pack: row[5],
                        landed: landedCost,
                        margin: margin / 100,
                        profit: profit,
                        sell: userSellPrice
                    });
                });

                ws.getColumn('margin').numFmt = '0.0%';
                ws.getColumn('landed').numFmt = '£#,##0.00';
                ws.getColumn('profit').numFmt = '£#,##0.00';
                ws.getColumn('sell').numFmt = '£#,##0.00';
            };


            // Smart Paste Handler - More Permissive
            const handleSmartPaste = (e) => {
                const text = e.clipboardData.getData('text');
                if (!text || !text.trim()) return;

                const lines = text.split(/\r?\n/).filter(l => l.trim());
                if (lines.length === 0) return;

                // If single line without tabs, allow normal paste behavior
                if (lines.length === 1 && !text.includes('\t')) return;

                e.preventDefault();

                // Try to detect format - tabs first (Excel), then commas, then spaces
                const hasTabs = text.includes('\t');
                const hasCommas = text.includes(',') && !hasTabs;
                const delim = hasTabs ? '\t' : hasCommas ? ',' : /\s+/;

                // Parse into rows of cells
                const tableData = lines.map(line => {
                    if (typeof delim === 'string') {
                        return line.split(delim).map(c => c.trim());
                    } else {
                        return line.split(delim).map(c => c.trim()).filter(Boolean);
                    }
                });

                // Determine column count
                const maxCols = Math.max(...tableData.map(r => r.length));

                // If just 1 column, paste as prices (most common case)
                if (maxCols === 1) {
                    setPricesText(tableData.map(r => r[0] || '').join('\n'));
                    showNotification(`✓ Pasted ${tableData.length} prices`, 'success');
                    return;
                }

                // Multiple columns: try to be smart about mapping
                // Common patterns: SKU, Price, Dims OR Price, Dims, Pack
                // We'll use a simple heuristic: first numeric-looking column is price

                const priceCol = [];
                const dimCol = [];
                const skuCol = [];
                const packCol = [];
                const weightCol = [];

                for (const row of tableData) {
                    let foundPrice = false;
                    let foundDims = false;

                    for (let i = 0; i < row.length; i++) {
                        const cell = row[i];
                        const numVal = parseFloat(cell.replace(/[^0-9.-]/g, ''));

                        // Check if it looks like dimensions (contains x or - with multiple numbers)
                        if (!foundDims && /^\d+[\sx\-,]+\d+[\sx\-,]+\d+$/i.test(cell)) {
                            dimCol.push(cell);
                            foundDims = true;
                            continue;
                        }

                        // Check for numeric price (decimal number between 0.01 and 9999)
                        if (!foundPrice && !isNaN(numVal) && numVal > 0 && numVal < 10000) {
                            priceCol.push(numVal.toString());
                            foundPrice = true;
                            continue;
                        }

                        // Check for small integer (pack qty 1-100)
                        if (row.length > 2 && !isNaN(numVal) && Number.isInteger(numVal) && numVal >= 1 && numVal <= 100) {
                            packCol.push(numVal.toString());
                            continue;
                        }

                        // If text, treat as SKU
                        if (isNaN(numVal) && cell.length > 0 && skuCol.length < tableData.length) {
                            skuCol.push(cell);
                        }
                    }

                    // Fill missing columns with empty
                    if (priceCol.length < dimCol.length) priceCol.push('');
                    if (dimCol.length < priceCol.length) dimCol.push('');
                    if (skuCol.length < priceCol.length) skuCol.push('');
                }

                // Apply to fields
                if (priceCol.length > 0) setPricesText(priceCol.join('\n'));
                if (dimCol.length > 0) setDimsText(dimCol.join('\n'));
                if (skuCol.length > 0) setSkusText(skuCol.join('\n'));
                if (packCol.length > 0) setPackText(packCol.join('\n'));

                const count = Math.max(priceCol.length, dimCol.length, skuCol.length);
                showNotification(`✓ Pasted ${count} rows successfully`, 'success');
            };

            const populateFromData = (items) => {
                setPricesText(items.map(i => `${i.unitUSD}${i.pack > 1 ? ', ' + i.pack : ''}`).join('\n'));
                setDimsText(items.map(i => `${i.L}x${i.W}x${i.H}`).join('\n'));
                setSkusText(items.map(i => i.sku || '').join('\n'));
                // Optional fields
                setPackText(items.map(i => i.pack > 1 ? i.pack : '').join('\n'));
                setWeightText(items.map(i => '').join('\n')); // Reset or map if available
            };

            const showNotification = (message, type) => {
                const div = document.createElement('div');
                div.textContent = message;
                div.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white font-semibold z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 3000);
            };

            const money = (n) => Number.isFinite(n) ? `\u00a3${n.toFixed(2)}` : '\u2014';
            const statusColors = {
                good: { border: 'border-l-emerald-500', bg: 'bg-gradient-to-r from-emerald-50/80 to-transparent dark:from-emerald-900/20', text: 'text-emerald-600' },
                review: { border: 'border-l-amber-500', bg: 'bg-gradient-to-r from-amber-50/80 to-transparent dark:from-amber-900/20', text: 'text-amber-600' },
                low: { border: 'border-l-rose-500', bg: 'bg-gradient-to-r from-rose-50/80 to-transparent dark:from-rose-900/20', text: 'text-rose-600' }
            };

            if (!active) return null;

            return (
                <div className="space-y-6">
                    {/* Minimal Background - Clean Apple/Google Style */}
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute top-20 right-10 w-96 h-96 bg-gradient-to-br from-indigo-500/3 to-transparent rounded-full blur-3xl"></div>
                        <div className="absolute bottom-20 left-10 w-96 h-96 bg-gradient-to-tr from-purple-500/3 to-transparent rounded-full blur-3xl"></div>
                    </div>

                    {/* COMMAND BAR - Premium Apple Glass Style */}
                    <div className="col-span-1 lg:col-span-12 rounded-2xl px-6 py-4 bg-gradient-to-r from-white/95 via-white/90 to-white/95 dark:from-gray-800/95 dark:via-gray-900/90 dark:to-gray-800/95 border border-gray-200/60 dark:border-gray-700/60 shadow-xl backdrop-blur-2xl sticky top-0 z-30 ring-1 ring-black/5 dark:ring-white/5">
                        {rows.length === 0 ? (
                            /* EMPTY STATE: Focus on Upload */
                            <div className="flex items-center justify-between gap-4">
                                <div className="flex items-center gap-3">
                                    {/* Vibrant Calculator Icon with Gradient */}
                                    <div className="relative">
                                        <div className="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg blur opacity-20"></div>
                                        <svg className="relative w-5 h-5" viewBox="0 0 24 24">
                                            <defs>
                                                <linearGradient id="calcGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                                    <stop offset="0%" style={{ stopColor: '#6366f1' }} />
                                                    <stop offset="100%" style={{ stopColor: '#a855f7' }} />
                                                </linearGradient>
                                            </defs>
                                            <path fill="url(#calcGrad)" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z" />
                                            <path fill="url(#calcGrad)" d="M7 7h10v2H7zm0 4h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2zm-8 4h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <div className="text-sm font-semibold text-gray-900 dark:text-gray-100">Bulk Calculator</div>
                                        <div className="text-xs text-gray-500 dark:text-gray-400">Paste data or upload CSV</div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    {/* AI Upload Button */}
                                    <label className="relative cursor-pointer group">
                                        <input
                                            type="file"
                                            accept=".xlsx,.xls,.csv"
                                            onChange={(e) => handleAIUpload(e.target.files[0])}
                                            className="hidden"
                                        />
                                        <div className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-violet-500 to-indigo-600 hover:from-violet-600 hover:to-indigo-700 text-white text-sm font-bold rounded-lg shadow-lg shadow-indigo-500/30 transition-all duration-200 group-hover:scale-105 group-hover:shadow-xl group-hover:shadow-indigo-500/40 group-active:scale-95 border border-indigo-400/20">
                                            <div className="w-4 h-4 rounded-full bg-white/20 flex items-center justify-center group-hover:bg-white/30 transition-colors">
                                                <svg className="w-2.5 h-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={3}><path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                            </div>
                                            <span className="relative">
                                                AI Upload
                                                <div className="absolute -inset-1 bg-white/10 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 -z-10"></div>
                                            </span>
                                        </div>
                                    </label>
                                    <input type="file" ref={fileInputRef} accept=".csv,.xlsx,.txt" onChange={handleFileUpload} className="hidden" />
                                    <button onClick={() => fileInputRef.current?.click()} disabled={uploading} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white text-sm font-medium rounded-lg transition-all shadow-sm hover:shadow-md">
                                        {uploading ? (
                                            <><svg className="animate-spin w-3.5 h-3.5" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Uploading...</>
                                        ) : (
                                            <><svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg> Upload CSV</>
                                        )}
                                    </button>
                                </div>
                            </div>
                        ) : (
                            /* WITH DATA: Show All Controls */
                            <div className="flex items-center justify-between gap-6">
                                <div className="flex items-center gap-3 flex-shrink-0">
                                    <svg className="w-5 h-5 text-indigo-400 dark:text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}><path strokeLinecap="round" strokeLinejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                                    <div className="text-sm font-bold text-gray-800 dark:text-gray-100">Bulk Calculator</div>
                                </div>

                                <div className="flex items-center gap-4 flex-1 justify-center">
                                    <div className="flex items-center gap-2">
                                        <span className="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Target</span>
                                        <div className="flex bg-gray-100/50 dark:bg-white/5 rounded-lg p-1 shadow-inner backdrop-blur-sm">
                                            {[20, 25, 30].map(m => (
                                                <button key={m} onClick={() => setSettings(s => ({ ...s, margin: m }))} className={`px-3 py-1.5 text-[11px] font-bold rounded-md transition-all ${settings.margin === m ? 'bg-white dark:bg-white/10 text-indigo-600 dark:text-indigo-300 shadow-sm ring-1 ring-black/5 dark:ring-white/5' : 'text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'}`}>{m}%</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="h-6 w-px bg-gray-200 dark:bg-gray-700"></div>
                                    <div className="flex items-center gap-3">
                                        <div className="flex items-center gap-2">
                                            <span className="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Fee</span>
                                            <div className="relative">
                                                <input type="number" value={settings.commission} onChange={e => setSettings(s => ({ ...s, commission: parseFloat(e.target.value) || 0 }))} className="w-20 bg-gray-100 dark:bg-gray-800 rounded-lg pl-3 pr-6 py-1.5 text-xs font-bold text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500/30 outline-none shadow-inner" />
                                                <span className="absolute right-2 top-1.5 text-[10px] font-bold text-gray-400">%</span>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">P&P</span>
                                            <div className="relative">
                                                <span className="absolute left-3 top-1.5 text-[10px] font-bold text-gray-400">£</span>
                                                <input type="number" step="0.01" value={settings.ppCost} onChange={e => setSettings(s => ({ ...s, ppCost: parseFloat(e.target.value) || 0 }))} className="w-20 bg-gray-100 dark:bg-gray-800 rounded-lg pl-6 pr-3 py-1.5 text-xs font-bold text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500/30 outline-none shadow-inner" />
                                            </div>
                                        </div>
                                        <div className="h-6 w-px bg-gray-200 dark:bg-gray-700"></div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Currency</span>
                                            <label className="relative inline-flex items-center cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    checked={currencyConversion.enabled} 
                                                    onChange={(e) => setCurrencyConversion(prev => ({ ...prev, enabled: e.target.checked }))}
                                                    className="sr-only peer" 
                                                />
                                                <div className="w-8 h-4 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[1px] after:left-[1px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                            </label>
                                            {currencyConversion.enabled && (
                                                <select 
                                                    value={currencyConversion.targetCurrency} 
                                                    onChange={(e) => setCurrencyConversion(prev => ({ ...prev, targetCurrency: e.target.value }))}
                                                    className="bg-gray-100 dark:bg-gray-800 rounded-lg px-2 py-1.5 text-xs font-bold text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500/30 outline-none shadow-inner"
                                                >
                                                    <option value="GBP">GBP</option>
                                                    <option value="EUR">EUR</option>
                                                    <option value="CAD">CAD</option>
                                                    <option value="AUD">AUD</option>
                                                </select>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div className="flex items-center gap-2 flex-shrink-0">
                                    <button onClick={handleClearAll} className="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 hover:bg-rose-50 hover:text-rose-600 dark:hover:bg-rose-900/20 transition-all" title="Clear all data">
                                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                    <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="bg-gray-100 dark:bg-gray-800 text-xs font-bold text-gray-700 dark:text-gray-300 border-none py-2 pl-3 pr-8 rounded-lg cursor-pointer focus:ring-0 shadow-inner hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                                        <option value="order">Original Order</option>
                                        <option value="margin-asc">Margin ↑</option>
                                        <option value="margin-desc">Margin ↓</option>
                                        <option value="price">Price ↓</option>
                                    </select>
                                    <button onClick={() => { exportToExcel(); showNotification('Exported to Excel', 'success'); }} className="flex items-center gap-2 px-3 py-2 rounded-lg bg-green-50 text-green-700 hover:bg-green-100 dark:bg-green-900/30 dark:text-green-400 dark:hover:bg-green-900/50 transition-all shadow-sm font-medium text-xs" title="Export to Excel">
                                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                        Export XLS
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* INPUT SIDE */}
                    <div className="lg:col-span-12 grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div className="lg:col-span-5 space-y-4">
                            {/* PREMIUM SPREADSHEET - Clean Design */}
                            <div className="relative overflow-hidden" style={{ borderRadius: '20px' }}>
                                {/* Glass Container */}
                                <div className="bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl border border-gray-200/50 dark:border-gray-700/50 shadow-2xl ring-1 ring-black/5 dark:ring-white/5" style={{ borderRadius: '20px' }}>

                                    {/* Header Bar - Matching Simple Section Style */}
                                    <div className="flex items-center justify-between px-5 py-4 border-b border-gray-100 dark:border-gray-800 bg-gradient-to-r from-gray-50/80 via-white to-gray-50/80 dark:from-gray-800/80 dark:via-gray-900 dark:to-gray-800/80">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-indigo-600 dark:from-transparent dark:to-transparent dark:bg-black shadow-lg shadow-indigo-500/30 dark:shadow-none ring-1 ring-white/20 dark:ring-white/10 flex items-center justify-center relative overflow-hidden">
                                                <div className="absolute inset-0 bg-gradient-to-br from-white/25 to-transparent"></div>
                                                <svg className="w-5 h-5 text-white dark:text-indigo-500 relative z-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
                                            </div>
                                            <div>
                                                <div className="text-base font-bold text-gray-900 dark:text-white tracking-tight">Product Data</div>
                                                <div className="text-xs text-gray-400">Paste from Excel • Smart L×W×H auto-split</div>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            {/* AI Upload Button - Enhanced */}
                                            <label className="relative cursor-pointer group">
                                                <input
                                                    type="file"
                                                    accept=".xlsx,.xls,.csv"
                                                    onChange={(e) => handleAIUpload(e.target.files[0])}
                                                    className="hidden"
                                                />
                                                <div className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-violet-500 to-indigo-600 hover:from-violet-600 hover:to-indigo-700 text-white text-sm font-bold rounded-lg shadow-lg shadow-indigo-500/30 transition-all duration-200 group-hover:scale-105 group-hover:shadow-xl group-hover:shadow-indigo-500/40 group-active:scale-95 border border-indigo-400/20">
                                                    <div className="w-4 h-4 rounded-full bg-white/20 flex items-center justify-center group-hover:bg-white/30 transition-colors">
                                                        <svg className="w-2.5 h-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={3}><path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                                    </div>
                                                    <span className="relative">
                                                        AI Upload
                                                        <div className="absolute -inset-1 bg-white/10 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 -z-10"></div>
                                                    </span>
                                                </div>
                                            </label>
                                            <div className="px-3 py-1.5 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 text-xs font-bold rounded-lg">
                                                {rows.length || 0} items
                                            </div>
                                            {originalSheet && (
                                                <div className="px-2 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 text-[10px] font-bold rounded flex items-center gap-1" title="Original sheet preserved for export">
                                                    <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                                                    Linked
                                                </div>
                                            )}
                                            <button
                                                onClick={handleClearAll}
                                                className="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-red-50 dark:hover:bg-red-900/30 text-gray-400 hover:text-red-500 transition-all"
                                                title="Clear all"
                                            >
                                                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                            </button>
                                        </div>
                                    </div>

                                    <div
                                        id="spreadsheet-wrapper"
                                        className="relative border border-gray-200 dark:border-gray-700 shadow-2xl ring-1 ring-black/5 dark:ring-white/5 bg-white dark:bg-gray-900"
                                        style={{ height: '500px', minHeight: '300px', borderRadius: '0 0 20px 20px', overflow: 'hidden' }}
                                    >
                                        <div
                                            id="jspreadsheet-container"
                                            ref={(el) => {
                                                if (el && !el.jspreadsheet) {
                                                    // Parse existing dims into L/W/H
                                                    const parseDim = (dimStr) => {
                                                        if (!dimStr) return ['', '', ''];
                                                        const cleaned = String(dimStr).replace(/\s*(cm|mm|in|inch|inches)\s*$/i, '');
                                                        const parts = cleaned.split(/[x×*\-\s,]+/).map(p => p.trim()).filter(Boolean);
                                                        return [parts[0] || '', parts[1] || '', parts[2] || ''];
                                                    };

                                                    const initialData = [];
                                                    const priceArr = pricesText.split('\n');
                                                    const dimsArr = dimsText.split('\n');
                                                    const skuArr = skusText.split('\n');
                                                    const packArr = packText.split('\n');
                                                    const weightArr = weightText.split('\n');
                                                    const maxRows = Math.max(priceArr.length, dimsArr.length, skuArr.length, 25);

                                                    for (let i = 0; i < maxRows; i++) {
                                                        const [l, w, h] = parseDim(dimsArr[i]);
                                                        initialData.push([
                                                            '', // Image
                                                            priceArr[i] || '',
                                                            l, w, h,
                                                            skuArr[i] || '',
                                                            packArr[i] || '',
                                                            weightArr[i] || ''
                                                        ]);
                                                    }

                                                    el.jspreadsheet = jspreadsheet(el, {
                                                        data: initialData,
                                                        columns: [
                                                            { type: 'image', title: 'Image', width: 80, align: 'center' },
                                                            { type: 'text', title: 'Price $', width: 80, align: 'right' },
                                                            { type: 'text', title: 'L', width: 50, align: 'center' },
                                                            { type: 'text', title: 'W', width: 50, align: 'center' },
                                                            { type: 'text', title: 'H', width: 50, align: 'center' },
                                                            { type: 'text', title: 'SKU', width: 95 },
                                                            { type: 'text', title: 'Pack', width: 50, align: 'center' },
                                                            { type: 'text', title: 'Wt kg', width: 55, align: 'center' }
                                                        ],
                                                        minDimensions: [8, 50],
                                                        tableOverflow: false, // Let container scroll
                                                        tableWidth: '100%',
                                                        columnSorting: false,
                                                        allowInsertRow: true,
                                                        allowDeleteRow: true,
                                                        allowInsertColumn: false,
                                                        allowDeleteColumn: false,
                                                        allowRenameColumn: false,
                                                        copyCompatibility: true,
                                                        autoIncrement: false,
                                                        defaultColWidth: 60,
                                                        onchange: (instance, cell, x, y, value) => {
                                                            // Price is now x=1. L=2, W=3, H=4.
                                                            // Check if L (x=2) changed and has units
                                                            if (x == 2 && value) {
                                                                const cleaned = String(value).replace(/\s*(cm|mm|in|inch|inches)\s*$/i, '');
                                                                const parts = cleaned.split(/[x×*\-\s,]+/).map(p => p.trim()).filter(Boolean);
                                                                if (parts.length >= 3) {
                                                                    instance.jspreadsheet.setValueFromCoords(2, y, parts[0], true);
                                                                    instance.jspreadsheet.setValueFromCoords(3, y, parts[1], true);
                                                                    instance.jspreadsheet.setValueFromCoords(4, y, parts[2], true);
                                                                }
                                                            }
                                                            const data = instance.jspreadsheet.getData();
                                                            // Map data back to state texts (Shifted indices)
                                                            // 0=Img, 1=Price, 2=L, 3=W, 4=H, 5=SKU, 6=Pack, 7=Weight
                                                            setPricesText(data.map(r => r[1] || '').join('\n'));
                                                            setDimsText(data.map(r => {
                                                                const l = r[2] || ''; const w = r[3] || ''; const h = r[4] || '';
                                                                if (l || w || h) return `${l}x${w}x${h}`; return '';
                                                            }).join('\n'));
                                                            setSkusText(data.map(r => r[5] || '').join('\n'));
                                                            setPackText(data.map(r => r[6] || '').join('\n'));
                                                            setWeightText(data.map(r => r[7] || '').join('\n'));
                                                        },
                                                        onpaste: (instance, pastedData) => {
                                                            setTimeout(() => {
                                                                const tableData = instance.jspreadsheet.getData();
                                                                tableData.forEach((row, y) => {
                                                                    const lVal = row[2]; // L is now index 2
                                                                    if (lVal && typeof lVal === 'string') {
                                                                        const cleaned = lVal.replace(/\s*(cm|mm|in|inch|inches)\s*$/i, '');
                                                                        const parts = cleaned.split(/[x×*\-\s,]+/).map(p => p.trim()).filter(Boolean);
                                                                        if (parts.length >= 3) {
                                                                            instance.jspreadsheet.setValueFromCoords(2, y, parts[0], true);
                                                                            instance.jspreadsheet.setValueFromCoords(3, y, parts[1], true);
                                                                            instance.jspreadsheet.setValueFromCoords(4, y, parts[2], true);
                                                                        }
                                                                    }
                                                                });
                                                                const finalData = instance.jspreadsheet.getData();
                                                                setPricesText(finalData.map(r => r[1] || '').join('\n'));
                                                                setDimsText(finalData.map(r => {
                                                                    const l = r[2] || ''; const w = r[3] || ''; const h = r[4] || '';
                                                                    if (l || w || h) return `${l}x${w}x${h}`; return '';
                                                                }).join('\n'));
                                                                setSkusText(finalData.map(r => r[5] || '').join('\n'));
                                                                setPackText(finalData.map(r => r[6] || '').join('\n'));
                                                                setWeightText(finalData.map(r => r[7] || '').join('\n'));
                                                            }, 50);
                                                        },
                                                        contextMenu: function (obj, x, y, e) {
                                                            return [
                                                                { title: 'Insert row above', onclick: function () { obj.insertRow(1, y, 1); } },
                                                                { title: 'Insert row below', onclick: function () { obj.insertRow(1, parseInt(y) + 1, 0); } },
                                                                { title: 'Delete row', onclick: function () { obj.deleteRow(y, 1); } },
                                                                null,
                                                                { title: 'Copy', onclick: function () { obj.copy(); } },
                                                                { title: 'Paste', onclick: function () { obj.paste(); } },
                                                                null,
                                                                { title: 'Clear cell', onclick: function () { obj.setValueFromCoords(x, y, ''); } }
                                                            ];
                                                        }
                                                    });

                                                    try {
                                                        const observer = new ResizeObserver(() => {
                                                            if (el.jspreadsheet) {
                                                                const table = el.querySelector('tbody');
                                                                if (table && el.clientHeight > table.clientHeight + 40) {
                                                                    const diff = el.clientHeight - table.clientHeight;
                                                                    const r = Math.ceil(diff / 30);
                                                                    if (r > 0) el.jspreadsheet.insertRow(r);
                                                                }
                                                            }
                                                        });
                                                        observer.observe(el);
                                                    } catch (e) { }
                                                }
                                            }}
                                            className="jexcel-custom jexcel-custom-scroll w-full h-full relative"
                                            style={{ overflow: 'auto', paddingBottom: '40px' }}
                                        />

                                        {/* Fixed Resize Handle Overlay - Easier to hit */}
                                        <div
                                            className="absolute bottom-1 right-1 w-12 h-12 z-[100] cursor-nwse-resize flex items-end justify-end p-3 opacity-60 hover:opacity-100 transition-opacity"
                                            title="Drag to resize"
                                            onMouseDown={(e) => {
                                                e.preventDefault();
                                                const wrapper = document.getElementById('spreadsheet-wrapper');
                                                if (!wrapper) return;
                                                const startY = e.clientY;
                                                const startH = wrapper.offsetHeight;
                                                const onMouseMove = (ev) => {
                                                    const newH = startH + (ev.clientY - startY);
                                                    if (newH > 300) wrapper.style.height = newH + 'px';
                                                };
                                                const onMouseUp = () => {
                                                    document.removeEventListener('mousemove', onMouseMove);
                                                    document.removeEventListener('mouseup', onMouseUp);
                                                };
                                                document.addEventListener('mousemove', onMouseMove);
                                                document.addEventListener('mouseup', onMouseUp);
                                            }}
                                        >
                                            <svg className="w-5 h-5 text-gray-400 dark:text-gray-500" viewBox="0 0 24 24" fill="currentColor"><path d="M22 22H20V20H22V22ZM22 18H20V16H22V18ZM18 22H16V20H18V22ZM22 14H20V12H22V14ZM14 22H12V20H14V22Z" /></svg>
                                        </div>
                                    </div>
                                </div>

                                {/* Simple Tips */}
                                <div className="text-[11px] text-gray-400 mt-2 px-2 flex items-center justify-between">
                                    <div className="flex items-center gap-4">
                                        <span>Paste: Ctrl+V</span>
                                        <span>Fill: Drag corner</span>
                                        <span>Dims: Auto-splits 40x30x20</span>
                                        <span className="text-indigo-400 font-medium">Drag bottom-right dots to add rows</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* OUTPUT SIDE */}
                        <div className="lg:col-span-7 space-y-5">
                            {/* Settings Moved to Top Command Bar */}

                            {rows.length > 0 ? (
                                <>
                                    {/* Price Endings + Profit Summary */}
                                    <div className="glass-card rounded-2xl p-4 border border-gray-100 dark:border-gray-800">
                                        <div className="flex flex-wrap items-center justify-between gap-4">
                                            <div className="flex items-center gap-3">
                                                <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Endings</span>
                                                <div className="flex gap-1 bg-gray-100 dark:bg-gray-800 rounded-xl p-1">
                                                    {[null, 'round', '.99', '.95', '.49'].map(e => (
                                                        <button key={e || 'auto'} onClick={() => applyEnding(e)} className={`px-2.5 py-1 text-[10px] font-bold rounded-lg transition-all ${priceEnding === e ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-500 hover:text-gray-700 hover:bg-white dark:hover:bg-gray-700'}`}>
                                                            {e === null ? 'Auto' : e === 'round' ? 'Round' : e}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-6">
                                                <div className="text-right">
                                                    <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Total Profit</div>
                                                    <div className="text-xl font-black bg-gradient-to-r from-emerald-600 to-teal-500 bg-clip-text text-transparent">{money(stats.totalProfit)}</div>
                                                </div>
                                                <div className="w-px h-10 bg-gradient-to-b from-transparent via-gray-200 dark:via-gray-700 to-transparent"></div>
                                                <div className="text-right">
                                                    <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Avg Margin</div>
                                                    <div className="text-xl font-black text-gray-700 dark:text-gray-200">{stats.avgMargin.toFixed(1)}%</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Removed redundant Export Button here since it's in the Control Deck */}

                                    {/* Results Cards */}
                                    <div className="space-y-3 max-h-[50vh] overflow-y-auto pr-1 apple-scrollbar">
                                        {sortedRows.map(r => (
                                            <div key={r.i} className={`glass-card rounded-2xl overflow-hidden transition-all duration-300 hover:shadow-xl hover:scale-[1.01] border-l-4 ${statusColors[r.status].border} ${statusColors[r.status].bg} border border-gray-100 dark:border-gray-800`}>
                                                <div className="p-4 flex items-center gap-4">
                                                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 flex items-center justify-center text-sm font-black text-gray-500 shadow-inner">{r.i}</div>
                                                    <div className="flex-1 min-w-0 cursor-pointer" onClick={() => setExpandedRow(expandedRow === r.i ? null : r.i)}>
                                                        {r.sku && <div className="text-xs font-medium text-gray-500 truncate mb-0.5">{r.sku}</div>}
                                                        <div className="text-3xl font-black text-gray-900 dark:text-white tracking-tight">{money(r.sell)}</div>
                                                        {r.pack > 1 && <div className="text-[10px] font-bold text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded-full inline-block mt-1">Pack of {r.pack}</div>}
                                                    </div>
                                                    <div className="text-right">
                                                        <div className={`text-2xl font-black ${statusColors[r.status].text}`}>{r.marginPct.toFixed(1)}%</div>
                                                    </div>
                                                    <div className="text-right px-4 border-l border-gray-200 dark:border-gray-700">
                                                        <div className="text-[10px] text-gray-400 uppercase font-bold">Profit</div>
                                                        <div className={`text-lg font-black ${statusColors[r.status].text}`}>{money(r.profit)}</div>
                                                    </div>
                                                    <div onClick={() => setExpandedRow(expandedRow === r.i ? null : r.i)} className={`w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition-all ${expandedRow === r.i ? 'rotate-180' : ''}`}>
                                                        <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                                    </div>
                                                </div>
                                                <div className={`overflow-hidden transition-all duration-300 ${expandedRow === r.i ? 'max-h-44 opacity-100' : 'max-h-0 opacity-0'}`}>
                                                    <div className="px-5 pb-5 pt-3 border-t border-gray-200/50 dark:border-gray-700/50 bg-gray-50/50 dark:bg-gray-800/30 grid grid-cols-2 md:grid-cols-4 gap-4 text-xs">
                                                        <div className="bg-white dark:bg-gray-900 rounded-xl p-3 shadow-sm"><span className="text-gray-400 block text-[10px] uppercase font-bold mb-1">Buy (USD)</span><span className="font-black text-gray-900 dark:text-white">${r.unitUSD.toFixed(2)}</span></div>
                                                        <div className="bg-white dark:bg-gray-900 rounded-xl p-3 shadow-sm"><span className="text-gray-400 block text-[10px] uppercase font-bold mb-1">Landed</span><span className="font-black text-gray-900 dark:text-white">{money(r.landedUnit)}</span></div>
                                                        <div className="bg-white dark:bg-gray-900 rounded-xl p-3 shadow-sm"><span className="text-gray-400 block text-[10px] uppercase font-bold mb-1">Dims</span><span className="font-black text-gray-900 dark:text-white">{r.dims}cm</span></div>
                                                        <div className="bg-white dark:bg-gray-900 rounded-xl p-3 shadow-sm"><span className="text-gray-400 block text-[10px] uppercase font-bold mb-1">Courier</span><span className="font-black text-gray-900 dark:text-white">{r.courier ? r.courier.carrier : '\u2014'}</span></div>
                                                        <div className="bg-white dark:bg-gray-900 rounded-xl p-3 shadow-sm"><span className="text-gray-400 block text-[10px] uppercase font-bold mb-1">Units/40HQ</span><span className="font-black text-gray-900 dark:text-white">{r.units.toLocaleString()}</span></div>
                                                        <div className="bg-white dark:bg-gray-900 rounded-xl p-3 shadow-sm"><span className="text-gray-400 block text-[10px] uppercase font-bold mb-1">Cartons</span><span className="font-black text-gray-900 dark:text-white">{r.cartons.toLocaleString()}</span></div>
                                                        <div className="bg-white dark:bg-gray-900 rounded-xl p-3 shadow-sm"><span className="text-gray-400 block text-[10px] uppercase font-bold mb-1">CBM</span><span className="font-black text-gray-900 dark:text-white">{r.vol.toFixed(3)}</span></div>
                                                        {r.courier && <div className="bg-white dark:bg-gray-900 rounded-xl p-3 shadow-sm"><span className="text-gray-400 block text-[10px] uppercase font-bold mb-1">Ship Cost</span><span className="font-black text-gray-900 dark:text-white">{money(r.courier.cost)}</span></div>}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            ) : (
                                /* PREMIUM EMPTY STATE - Apple/Google/Stripe Inspired */
                                <div className="relative glass-card rounded-3xl p-16 text-center overflow-hidden bg-white/60 dark:bg-gray-900/60 backdrop-blur-sm border border-gray-200/50 dark:border-gray-700/50">
                                    {/* Subtle background gradient */}
                                    <div className="absolute inset-0 bg-gradient-to-br from-indigo-50/30 via-purple-50/20 to-pink-50/10 dark:from-indigo-950/20 dark:via-purple-950/10 dark:to-pink-950/5"></div>

                                    <div className="relative max-w-md mx-auto">
                                        {/* Clean icon - Apple/Google style */}
                                        <div className="w-14 h-14 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 flex items-center justify-center shadow-md">
                                            <svg className="w-7 h-7 text-indigo-600 dark:text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                                        </div>

                                        {/* Professional headline */}
                                        <h3 className="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-3">Bulk Pricing Calculator</h3>

                                        {/* Direct description */}
                                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-8 leading-relaxed">Calculate target sell prices, profit margins, and shipping costs for multiple products simultaneously.</p>

                                        {/* Benefits list */}
                                        <div className="space-y-2 mb-8 text-left">
                                            <div className="flex items-center gap-3 text-sm text-gray-700 dark:text-gray-300">
                                                <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 flex-shrink-0"></div>
                                                <span>Target sell prices for each item</span>
                                            </div>
                                            <div className="flex items-center gap-3 text-sm text-gray-700 dark:text-gray-300">
                                                <div className="w-1.5 h-1.5 rounded-full bg-indigo-500 flex-shrink-0"></div>
                                                <span>Profit margins and landed costs</span>
                                            </div>
                                            <div className="flex items-center gap-3 text-sm text-gray-700 dark:text-gray-300">
                                                <div className="w-1.5 h-1.5 rounded-full bg-purple-500 flex-shrink-0"></div>
                                                <span>Shipping recommendations</span>
                                            </div>
                                        </div>

                                        {/* Professional CTA */}
                                        <button onClick={loadExample} className="px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white text-sm font-bold rounded-xl shadow-lg hover:shadow-xl transition-all">
                                            Load Example
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Mobile Sticky */}
                    {
                        rows.length > 0 && (
                            <div className="lg:hidden fixed bottom-0 left-0 right-0 z-[9990] bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl border-t border-gray-200/50 dark:border-gray-700/50 px-4 py-3 safe-area-bottom">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2"><span className="text-2xl font-black text-gray-900 dark:text-white">{stats.total}</span><span className="text-xs text-gray-500">products</span></div>
                                    <button
                                        className="text-center active:scale-95 transition-transform flex flex-col items-center"
                                        onClick={(e) => { e.stopPropagation(); setPriceRulesOpen(true); }}
                                    >
                                        <div className="text-[10px] text-gray-400 uppercase font-bold">Target Profit <span className="text-indigo-500 ml-1">Edit</span></div>
                                        <div className="text-lg font-black text-emerald-600 underline decoration-dotted underline-offset-4 decoration-emerald-300">{money(stats.totalProfit)}</div>
                                    </button>
                                    <button onClick={exportToExcel} className="px-4 py-2 rounded-xl text-xs font-bold bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">Export</button>
                                </div>
                                {/* Mobile Price Rules Panel */}
                                {priceRulesOpen && setPriceRulesState && (
                                    <div className="fixed inset-0 z-[10000] flex items-end md:items-center md:justify-center">
                                        <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setPriceRulesOpen(false)}></div>
                                        <div className="relative w-full md:max-w-md bg-white dark:bg-gray-900 rounded-t-3xl md:rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom duration-300">
                                            <div className="flex items-center justify-between mb-4">
                                                <h3 className="text-lg font-bold text-gray-900 dark:text-white">Price Endings</h3>
                                                <button onClick={() => setPriceRulesOpen(false)} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors">✕</button>
                                            </div>
                                            <div className="space-y-3">
                                                <label className="flex items-center gap-2 text-sm font-medium"><input type="checkbox" checked={priceRulesState.enabled} onChange={(e) => setPriceRulesState(prev => ({ ...prev, enabled: e.target.checked }))} className="rounded" /> Enable globally</label>
                                                <div><div className="text-xs text-gray-600 dark:text-gray-400 mb-1">Endings (e.g. 0.99)</div><input className="glass-input w-full rounded-lg px-3 py-2 text-sm" value={priceRulesState.endingsText} onChange={(e) => setPriceRulesState(prev => ({ ...prev, endingsText: e.target.value }))} /></div>
                                                <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={priceRulesState.allowDown} onChange={(e) => setPriceRulesState(prev => ({ ...prev, allowDown: e.target.checked }))} className="rounded" /> Allow rounding down</label>
                                                <div><div className="text-xs text-gray-600 dark:text-gray-400 mb-1">Tolerance (%)</div><input className="glass-input w-full rounded-lg px-3 py-2 text-sm" value={priceRulesState.tolerancePct} onChange={(e) => setPriceRulesState(prev => ({ ...prev, tolerancePct: e.target.value }))} /></div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )
                    }


                    {/* AI Analysis Modal */}
                    {
                        aiModalOpen && (
                            <div className="fixed inset-0 z-[10000] flex items-center justify-center p-4">
                                <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={() => !aiAnalyzing && setAiModalOpen(false)}></div>
                                <div className="relative w-full max-w-2xl bg-white dark:bg-gray-900 rounded-3xl shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200">
                                    {/* Header */}
                                    <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-violet-500 to-indigo-600">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                                                <svg className="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                            </div>
                                            <div>
                                                <h2 className="text-lg font-bold text-white">AI Quote Analyzer</h2>
                                                <p className="text-xs text-white/70">Powered by Eli's Brain</p>
                                            </div>
                                        </div>
                                        {!aiAnalyzing && (
                                            <button onClick={() => setAiModalOpen(false)} className="p-2 hover:bg-white/10 rounded-full transition-colors">
                                                <svg className="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                            </button>
                                        )}
                                    </div>

                                    {/* Content */}
                                    <div className="p-6 max-h-[60vh] overflow-y-auto">
                                        {aiAnalyzing ? (
                                            <div className="text-center py-12">
                                                <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-r from-violet-500 to-indigo-600 flex items-center justify-center animate-pulse shadow-lg shadow-violet-500/30">
                                                    <svg className="w-10 h-10 text-white animate-spin" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                                </div>
                                                <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-3">Eli's Brain is Analyzing...</h3>
                                                <div className="space-y-3 max-w-md mx-auto">
                                                    <div className="flex items-center justify-between text-sm">
                                                        <span className="text-gray-600 dark:text-gray-400">🧠 Pattern Recognition</span>
                                                        <div className="w-3 h-3 bg-violet-500 rounded-full animate-pulse"></div>
                                                    </div>
                                                    <div className="flex items-center justify-between text-sm">
                                                        <span className="text-gray-600 dark:text-gray-400">🔍 SKU Detection (PSP/COMP/CC)</span>
                                                        <div className="w-3 h-3 bg-indigo-500 rounded-full animate-pulse" style={{animationDelay: '0.2s'}}></div>
                                                    </div>
                                                    <div className="flex items-center justify-between text-sm">
                                                        <span className="text-gray-600 dark:text-gray-400">💰 Price Extraction</span>
                                                        <div className="w-3 h-3 bg-purple-500 rounded-full animate-pulse" style={{animationDelay: '0.4s'}}></div>
                                                    </div>
                                                    <div className="flex items-center justify-between text-sm">
                                                        <span className="text-gray-600 dark:text-gray-400">📦 Dimension Mapping</span>
                                                        <div className="w-3 h-3 bg-pink-500 rounded-full animate-pulse" style={{animationDelay: '0.6s'}}></div>
                                                    </div>
                                                    <div className="flex items-center justify-between text-sm">
                                                        <span className="text-gray-600 dark:text-gray-400">🖼️ Image Extraction</span>
                                                        <div className="w-3 h-3 bg-blue-500 rounded-full animate-pulse" style={{animationDelay: '0.8s'}}></div>
                                                    </div>
                                                </div>
                                                <p className="text-xs text-gray-500 mt-6 italic">This may take 30-60 seconds for complex spreadsheets...</p>
                                            </div>
                                        ) : aiProducts.length > 0 ? (
                                            <>
                                                {/* Mapping Summary */}
                                                {aiMapping && (
                                                    <div className="mb-4 p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-200 dark:border-emerald-800">
                                                        <div className="flex items-center gap-2 mb-2">
                                                            <svg className="w-5 h-5 text-emerald-600 dark:text-emerald-400" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                                                            <span className="font-bold text-emerald-800 dark:text-emerald-300">AI Analysis Complete</span>
                                                        </div>
                                                        <p className="text-sm text-emerald-700 dark:text-emerald-400">
                                                            Found <strong>{aiProducts.length}</strong> products with pricing data
                                                            {aiMapping.note && <span className="block text-xs mt-1 opacity-75">{aiMapping.note}</span>}
                                                        </p>
                                                    </div>
                                                )}

                                                {/* Products Preview Table */}
                                                <div className="border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden">
                                                    <div className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                                                        <div className="flex items-center gap-2">
                                                            <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h2a2 2 0 002-2z" /></svg>
                                                            <span className="text-sm font-bold text-gray-700 dark:text-gray-300">Product Data ({aiProducts.length})</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <button 
                                                                onClick={() => {
                                                                    // Export to Excel
                                                                    const ws = XLSX.utils.json_to_sheet(aiProducts.map((p, i) => ({
                                                                        '#': i + 1,
                                                                        'SKU': p.sku || '',
                                                                        'Title': p.title || '',
                                                                        'Price USD': p.unitPrice || 0,
                                                                        'GBP': currencyConversion.enabled ? '=D' + (i + 2) + '/1.27' : '',
                                                                        'Length': p.cartonLength || p.productLength || 0,
                                                                        'Width': p.cartonWidth || p.productWidth || 0,
                                                                        'Height': p.cartonHeight || p.productHeight || 0,
                                                                        'Pack': p.pack || 1,
                                                                        'Weight': p.grossWeight || 0
                                                                    })));
                                                                    const wb = XLSX.utils.book_new();
                                                                    XLSX.utils.book_append_sheet(wb, ws, "AI Analysis");
                                                                    XLSX.writeFile(wb, "ai-analysis-results.xlsx");
                                                                }}
                                                                className="p-1.5 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors" 
                                                                title="Export to Excel"
                                                            >
                                                                <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                                            </button>
                                                            <button 
                                                                onClick={() => setAiTableFullscreen(true)}
                                                                className="p-1.5 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors" 
                                                                title="Fullscreen View"
                                                            >
                                                                <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div className="overflow-x-auto max-h-64">
                                                        <table className="w-full text-sm">
                                                            <thead className="bg-gray-50 dark:bg-gray-800 sticky top-0">
                                                                <tr>
                                                                    <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase w-12">#</th>
                                                                    <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase min-w-[120px]">SKU</th>
                                                                    <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase min-w-[200px]">Title</th>
                                                                    <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase min-w-[80px]">Price</th>
                                                                    <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase min-w-[70px]">GBP</th>
                                                                    <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase min-w-[120px]">L×W×H</th>
                                                                    <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase min-w-[60px]">Pack</th>
                                                                    <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase min-w-[80px]">Weight</th>
                                                                    <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase min-w-[70px]">CBM</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody className="divide-y divide-gray-100 dark:divide-gray-800">
                                                                {aiProducts.slice(0, 10).map((p, i) => (
                                                                    <ProductRow key={i} product={p} index={i} currencyConversion={currencyConversion} convertCurrency={convertCurrency} />
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    {aiProducts.length > 10 && (
                                                        <div className="px-3 py-2 bg-gray-50 dark:bg-gray-800 text-xs text-gray-500 text-center">
                                                            +{aiProducts.length - 10} more products
                                                        </div>
                                                    )}
                                                </div>
                                            </>
                                        ) : (
                                            <div className="text-center py-8 text-gray-500">
                                                <p className="font-bold text-red-500 mb-2">No products detected.</p>
                                                <p className="text-xs text-gray-400 mb-4">Diagnostics:</p>
                                                <pre className="text-[10px] text-left bg-gray-100 p-2 rounded overflow-auto max-h-40 mx-auto max-w-lg">
                                                    {JSON.stringify({
                                                        headerRow: aiMapping?.headerRow,
                                                        mapping: aiMapping?.mapping,
                                                        firstRow: originalSheet?.aiData?.products?.[0] || "No data"
                                                    }, null, 2)}
                                                </pre>
                                            </div>
                                        )}
                                    </div>

                                    {/* Footer */}
                                    {!aiAnalyzing && aiProducts.length > 0 && (
                                        <div className="flex items-center justify-between px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
                                            <button
                                                onClick={() => { setAiModalOpen(false); setAiProducts([]); setAiMapping(null); }}
                                                className="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                                            >
                                                Cancel
                                            </button>
                                            <button
                                                onClick={applyAIProducts}
                                                className="flex items-center gap-2 px-6 py-2.5 bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-700 hover:to-indigo-700 text-white text-sm font-bold rounded-xl shadow-lg hover:shadow-xl transition-all"
                                            >
                                                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                                                Import {aiProducts.length} Products
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )
                    }

                    {/* Fullscreen AI Table Modal */}
                    {aiTableFullscreen && (
                        <div className="fixed inset-0 z-[10001] bg-white dark:bg-gray-900">
                            <div className="h-full flex flex-col">
                                {/* Header */}
                                <div className="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-violet-500 to-indigo-600">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-lg bg-white/20 flex items-center justify-center">
                                            <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h2a2 2 0 002-2z" /></svg>
                                        </div>
                                        <div>
                                            <h2 className="text-lg font-bold text-white">AI Analysis Results</h2>
                                            <p className="text-xs text-white/70">{aiProducts.length} products extracted</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button 
                                            onClick={() => {
                                                // Export to Excel
                                                const ws = XLSX.utils.json_to_sheet(aiProducts.map((p, i) => ({
                                                    '#': i + 1,
                                                    'SKU': p.sku || '',
                                                    'Title': p.title || '',
                                                    'Price USD': p.unitPrice || 0,
                                                    'GBP': currencyConversion.enabled ? '=D' + (i + 2) + '/1.27' : '',
                                                    'Length': p.cartonLength || p.productLength || 0,
                                                    'Width': p.cartonWidth || p.productWidth || 0,
                                                    'Height': p.cartonHeight || p.productHeight || 0,
                                                    'Pack': p.pack || 1,
                                                    'Weight': p.grossWeight || 0
                                                })));
                                                const wb = XLSX.utils.book_new();
                                                XLSX.utils.book_append_sheet(wb, ws, "AI Analysis");
                                                XLSX.writeFile(wb, "ai-analysis-results.xlsx");
                                            }}
                                            className="p-2 hover:bg-white/10 rounded-lg transition-colors text-white" 
                                            title="Export to Excel"
                                        >
                                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                        </button>
                                        <button 
                                            onClick={() => setAiTableFullscreen(false)}
                                            className="p-2 hover:bg-white/10 rounded-lg transition-colors text-white"
                                        >
                                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Table */}
                                <div className="flex-1 overflow-auto p-4">
                                    <div className="border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden">
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-50 dark:bg-gray-800 sticky top-0">
                                                <tr>
                                                    <th className="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-16">#</th>
                                                    <th className="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-32">SKU</th>
                                                    <th className="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase min-w-[300px]">Title</th>
                                                    <th className="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-24">Price</th>
                                                    {currencyConversion.enabled && <th className="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-24">GBP</th>}
                                                    <th className="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-32">Dimensions</th>
                                                    <th className="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-20">Pack</th>
                                                    <th className="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-24">Weight</th>
                                                    <th className="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-24">CBM</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100 dark:divide-gray-800">
                                                {aiProducts.map((p, i) => (
                                                    <ProductRow key={i} product={p} index={i} currencyConversion={currencyConversion} convertCurrency={convertCurrency} />
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                {/* Footer */}
                                <div className="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
                                    <div className="flex items-center justify-between">
                                        <div className="text-sm text-gray-600 dark:text-gray-400">
                                            {aiProducts.length} products • Ready for import
                                        </div>
                                        <button
                                            onClick={() => {
                                                handleImportAIProducts();
                                                setAiTableFullscreen(false);
                                            }}
                                            className="flex items-center gap-2 px-6 py-2 bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white font-bold rounded-lg shadow-lg transition-all hover:scale-105"
                                        >
                                            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                                            Import All Products
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function Calculator() {
            const [tab, setTab] = useState('simple');
            const [g, setG] = useState({ containerType: '40HQ', utilisationPct: '89.5', fxGbpToUsd: '1.30', seaFreightGBP: '2800' });
            const [courierRules, setCourierRules] = useState(DEFAULT_COURIER_RULES);
            const [priceRules, setPriceRules] = useState({ enabled: false, endingsText: '0.49,0.99', allowDown: true, tolerancePct: '1' });
            const [currencyConversion, setCurrencyConversion] = useState({ enabled: false, targetCurrency: 'GBP', rates: {} });
            const [settingsOpen, setSettingsOpen] = useState(false);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [mobileHeaderVisible, setMobileHeaderVisible] = useState(true);
            const { theme, toggle } = useTheme();
            const setGField = useStableSetter(setG);

            // Scroll-hide header logic (mobile only)
            useEffect(() => {
                let lastScrollY = window.scrollY;
                const handleScroll = () => {
                    const currentScrollY = window.scrollY;
                    if (currentScrollY > lastScrollY && currentScrollY > 80) {
                        setMobileHeaderVisible(false); // scrolling down
                    } else {
                        setMobileHeaderVisible(true); // scrolling up
                    }
                    lastScrollY = currentScrollY;
                };
                window.addEventListener('scroll', handleScroll, { passive: true });
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            // Click Outside to Close Menus
            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (settingsOpen && !e.target.closest('.settings-panel') && !e.target.closest('.settings-trigger')) {
                        setSettingsOpen(false);
                    }
                    if (mobileMenuOpen && !e.target.closest('.mobile-menu-container') && !e.target.closest('.mobile-menu-trigger')) {
                        setMobileMenuOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                document.addEventListener('touchstart', handleClickOutside);
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                    document.removeEventListener('touchstart', handleClickOutside);
                };
            }, [settingsOpen, mobileMenuOpen]);

            return (
                <div className="min-h-screen pt-24 md:pt-0 pb-36 md:pb-20 px-4 md:px-6 lg:px-8 max-w-7xl mx-auto">
                    {/* Mobile Floating Capsule Header - iOS 26 Style */}
                    <div className={`md:hidden fixed top-3 left-3 right-3 z-[100] h-16 bg-white/85 dark:bg-gray-900/80 backdrop-blur-3xl rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.06)] dark:shadow-[0_8px_32px_rgba(0,0,0,0.3)] ring-1 ring-black/5 dark:ring-white/10 flex items-center justify-center px-2 transition-all duration-500 ease-out ${mobileHeaderVisible ? 'translate-y-0 opacity-100' : '-translate-y-24 opacity-0'}`}>
                        {/* Branding - Positioned Left */}
                        <div className="absolute left-3 flex items-center gap-3">
                            <div className="w-11 h-11 rounded-2xl bg-indigo-600 dark:bg-black flex items-center justify-center text-white shadow-lg shadow-indigo-500/30 dark:shadow-[0_0_20px_rgba(79,70,229,0.5)] ring-1 ring-white/20 dark:ring-white/10 relative overflow-hidden group">
                                <div className="absolute inset-0 bg-gradient-to-tr from-white/30 to-transparent opacity-100 pointer-events-none"></div>
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" className="relative z-10 dark:text-indigo-400 drop-shadow-md"><path strokeLinecap="round" strokeLinejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" /></svg>
                            </div>
                            <div className="flex flex-col justify-center hidden sm:flex">
                                <span className="text-sm font-black text-gray-900 dark:text-white tracking-tight leading-none">Landed</span>
                                <span className="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider leading-none">Calc</span>
                            </div>
                        </div>

                        {/* Dynamic Island Toggle - CENTERED */}
                        <div className="bg-black/95 dark:bg-black p-1 rounded-full shadow-xl ring-1 ring-white/10 flex items-center">
                            {['simple', 'bulkQuick'].map(id => (
                                <button
                                    key={id}
                                    onClick={() => setTab(id)}
                                    className={`relative z-10 px-3 py-1.5 rounded-full text-[11px] font-bold transition-all duration-300 ${tab === id ? 'text-black bg-white shadow-[0_0_15px_rgba(255,255,255,0.3)] scale-105' : 'text-gray-400 hover:text-white'}`}
                                >
                                    {id === 'bulkQuick' ? 'Bulk' : 'Simple'}
                                </button>
                            ))}
                        </div>

                        {/* Menu - Positioned Right */}
                        <div className="absolute right-2 z-50">
                            <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="w-9 h-9 rounded-full flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1.5" /><circle cx="12" cy="6" r="1.5" /><circle cx="12" cy="18" r="1.5" /></svg>
                            </button>

                            {/* Mobile Polished Dropdown - Morph Glass */}
                            {mobileMenuOpen && (
                                <>
                                    <div className="fixed inset-x-0 top-20 bottom-0 z-40 bg-black/10 backdrop-blur-[3px]" onClick={() => setMobileMenuOpen(false)}></div>
                                    <div className="mobile-menu-container absolute right-0 top-full mt-3 w-56 bg-white/90 dark:bg-gray-900/90 backdrop-blur-3xl rounded-3xl shadow-[0_20px_60px_-10px_rgba(0,0,0,0.25)] ring-1 ring-black/5 dark:ring-white/10 p-2 z-50 animate-in fade-in zoom-in-95 slide-in-from-top-2 duration-300 origin-top-right">
                                        <button onClick={() => { toggle(); setMobileMenuOpen(false); }} className="w-full flex items-center gap-3 px-4 py-3.5 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-xl transition-all group">
                                            <div className="w-8 h-8 rounded-lg bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-500 group-hover:scale-110 transition-transform">
                                                {theme === 'light' ?
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg> :
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>}
                                            </div>
                                            <span>{theme === 'light' ? 'Dark Mode' : 'Light Mode'}</span>
                                        </button>
                                        <div className="h-px bg-gray-100 dark:bg-gray-800 my-1 mx-2"></div>
                                        <button
                                            onClick={(e) => { e.stopPropagation(); setSettingsOpen(true); setMobileMenuOpen(false); }}
                                            className="settings-trigger w-full flex items-center gap-3 px-4 py-3.5 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-xl transition-all group"
                                        >
                                            <div className="w-8 h-8 rounded-lg bg-gray-50 dark:bg-gray-800 flex items-center justify-center text-gray-500 group-hover:scale-110 transition-transform">
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                            </div>
                                            <span>Settings</span>
                                        </button>
                                        <button onClick={() => {
                                            // Reset logic here if needed, or keeping it short as per user request
                                            setS({ unitUSD: '', unitsPerCarton: '', knowUnits: false, unitsPer40HQ: '', L: '', W: '', H: '', L2: '', W2: '', H2: '', hasCarton2: false, targetMarginPct: '25', manualTarget: '', ppCostGBP: '', commissionPct: '15', weightKg: '', weight2: '', ppSurcharge: '0.50', ppChargedGBP: '0' });
                                            setMobileMenuOpen(false);
                                        }} className="w-full flex items-center gap-3 px-4 py-3.5 text-sm font-medium text-rose-600 dark:text-rose-400 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-xl transition-all group">
                                            <div className="w-8 h-8 rounded-lg bg-rose-50 dark:bg-rose-900/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                            </div>
                                            <span>Reset All</span>
                                        </button>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>

                    {/* Desktop Header */}
                    <div className="hidden md:flex glass-card rounded-2xl p-5 mb-8 mt-6 justify-between items-center gap-4 relative z-50">
                        <div className="flex items-center gap-4">
                            <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-600 via-blue-600 to-indigo-600 dark:from-gray-900 dark:to-black flex items-center justify-center text-white dark:text-indigo-400 shadow-2xl shadow-indigo-500/20 dark:shadow-black/50 ring-1 ring-black/5 dark:ring-white/10 relative overflow-hidden group">
                                <div className="absolute inset-0 bg-gradient-to-br from-white/25 to-transparent opacity-100 pointer-events-none"></div>
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="relative z-10 drop-shadow-md"><path strokeLinecap="round" strokeLinejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" /></svg>
                            </div>
                            <div>
                                <h1 className="text-3xl font-black tracking-tight text-gray-900 dark:text-white leading-none mb-1">Landed Cost</h1>
                                <p className="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-widest pl-0.5">Pro Calculator</p>
                            </div>
                        </div>
                        <div className="inline-flex p-1.5 bg-gradient-to-br from-white/80 to-gray-100/90 dark:from-gray-800/90 dark:to-gray-900/80 backdrop-blur-xl rounded-2xl border border-white/60 dark:border-gray-600/40 shadow-lg shadow-gray-200/50 dark:shadow-black/30">
                            {['simple', 'bulkQuick'].map(id => <button key={id} onClick={() => setTab(id)} className={`relative px-8 py-3 rounded-xl text-sm font-bold transition-all ${tab === id ? 'bg-gradient-to-br from-white to-gray-50 dark:from-gray-700 dark:to-gray-800 text-gray-900 dark:text-white shadow-lg ring-2 ring-indigo-500/30 dark:ring-indigo-400/40' : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-white/50 dark:hover:bg-gray-700/50'}`}>{id === 'bulkQuick' ? 'Bulk' : 'Simple'}</button>)}
                        </div>
                        <div className="flex items-center gap-2">
                            <PriceRulesPanel rules={priceRules} setRules={setPriceRules} />
                            <button onClick={toggle} className="btn p-2.5 rounded-full text-xl">{theme === 'light' ? '🌙' : '☀️'}</button>
                        </div>
                    </div>

                    <SimpleView g={g} setG={setG} priceRules={priceRules} setPriceRules={setPriceRules} courierRules={courierRules} active={tab === 'simple'} setSettingsOpen={setSettingsOpen} />
                    <BulkQuickView g={g} priceRules={priceRules} courierRules={courierRules} active={tab === 'bulkQuick'} priceRulesState={priceRules} setPriceRulesState={setPriceRules} />

                    <button onClick={() => setSettingsOpen(true)} className="hidden md:flex fixed bottom-8 right-8 z-[60] btn px-5 py-3 rounded-full bg-gradient-to-br from-white/90 to-gray-100/80 dark:from-gray-800/90 dark:to-gray-900/80 backdrop-blur-2xl border border-white/60 dark:border-gray-600/40 text-indigo-600 dark:text-white shadow-[0_8px_32px_rgba(0,0,0,0.08),inset_0_1px_1px_rgba(255,255,255,0.8)] dark:shadow-[0_8px_32px_rgba(0,0,0,0.4),inset_0_1px_1px_rgba(255,255,255,0.05)] hover:scale-105 hover:shadow-[0_12px_40px_rgba(99,102,241,0.15),inset_0_1px_1px_rgba(255,255,255,0.8)] dark:hover:shadow-[0_12px_40px_rgba(99,102,241,0.25),inset_0_1px_1px_rgba(255,255,255,0.08)] transition-all items-center gap-3 group">
                        <span className="w-8 h-8 rounded-full bg-indigo-50 dark:bg-indigo-900/50 flex items-center justify-center group-hover:rotate-90 transition-transform duration-500">
                            <svg className="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </span>
                        <span className="font-bold text-sm tracking-wide">Shipping Settings</span>
                    </button>


                    {
                        settingsOpen && (
                            <div className="fixed inset-0 z-[9999] flex justify-end">
                                <div className="absolute inset-0 bg-black/40 backdrop-blur-md" onClick={() => setSettingsOpen(false)}></div>
                                <div className="settings-panel relative w-full max-w-md glass-card h-full p-6 animate-in slide-in-from-right overflow-y-auto">
                                    <div className="flex items-center justify-between mb-6">
                                        <h2 className="text-xl font-bold">Shipping & Container Settings</h2>
                                        <button onClick={() => setSettingsOpen(false)} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">✕</button>
                                    </div>
                                    <div className="space-y-5">
                                        <div>
                                            <label className="block text-sm font-medium mb-1.5">Container Type</label>
                                            <select value={g.containerType} onChange={(e) => setG(prev => ({ ...prev, containerType: e.target.value }))} className="glass-input w-full rounded-xl placeholder:text-gray-400 dark:placeholder:text-gray-500 px-4 py-2.5">
                                                <option value="40HQ">40HQ</option>
                                                <option value="40GP">40GP</option>
                                                <option value="20GP">20GP</option>
                                            </select>
                                        </div>
                                        <div><label className="block text-sm font-medium mb-1.5">Container Fill %</label><StableInput value={g.utilisationPct} onValue={setGField('utilisationPct')} /></div>
                                        <div><label className="block text-sm font-medium mb-1.5">GBP → USD (FX Rate)</label><StableInput value={g.fxGbpToUsd} onValue={setGField('fxGbpToUsd')} /></div>
                                        <div><label className="block text-sm font-medium mb-1.5">Sea Freight per Container (£)</label><StableInput value={g.seaFreightGBP} onValue={setGField('seaFreightGBP')} /></div>
                                        <div className="pt-4 border-t border-gray-200 dark:border-gray-700 text-sm text-gray-600 dark:text-gray-400">
                                            <div>Preset CBM: {fmt(CONTAINER_CBM[g.containerType] || 76, 2)} m³</div>
                                            <div>Effective CBM: {fmt((CONTAINER_CBM[g.containerType] || 76) * (num(g.utilisationPct) / 100), 2)} m³</div>
                                        </div>



                                        <div className="pt-6 border-t border-gray-200 dark:border-gray-700">
                                            <h3 className="font-bold text-lg mb-4">Courier / Shipping Parameters</h3>
                                            <div className="space-y-3">
                                                {courierRules.map((r, i) => (
                                                    <details key={r.id} className="group bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden open:ring-1 open:ring-blue-500/20">
                                                        <summary className="flex items-center gap-3 p-3 cursor-pointer hover:bg-gray-100/50 dark:hover:bg-gray-700/30 transition-colors list-none">
                                                            {r.logo && <div className="w-8 h-8 bg-white rounded-lg flex items-center justify-center p-1 shadow-sm border border-gray-100"><img src={r.logo} className="w-full h-full object-contain" /></div>}
                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex items-center gap-2">
                                                                    <span className="font-bold text-sm truncate">{r.name}</span>
                                                                    {r.type && <span className="px-1.5 py-0.5 text-[9px] bg-gray-200 dark:bg-gray-700 rounded text-gray-500 uppercase font-bold tracking-wider">{r.type}</span>}
                                                                </div>
                                                                <div className="text-xs text-gray-500 font-medium mt-0.5">Base: £{fmt(r.price, 2)}</div>
                                                            </div>
                                                            <div className="text-gray-400 group-open:rotate-180 transition-transform duration-200">
                                                                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                                            </div>
                                                        </summary>

                                                        <div className="px-4 pb-4 pt-1 space-y-4 border-t border-gray-200 dark:border-gray-700/50">
                                                            {/* Primary Costs */}
                                                            <div className="grid grid-cols-2 gap-3 mt-3">
                                                                <div>
                                                                    <label className="text-[10px] uppercase text-gray-500 font-bold mb-1 block">Base Price £</label>
                                                                    <input
                                                                        className="glass-input w-full px-2 py-1.5 text-xs font-bold rounded-lg"
                                                                        type="number"
                                                                        step="0.01"
                                                                        value={r.price || ''}
                                                                        onChange={(e) => { const val = parseFloat(e.target.value); setCourierRules(prev => prev.map((pr, pi) => pi === i ? { ...pr, price: val } : pr)); }}
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label className={`text-[10px] uppercase font-bold mb-1 block ${r.extraPerParcel ? 'text-indigo-600 dark:text-indigo-400' : 'text-gray-400'}`}>Extra / Parcel £</label>
                                                                    <input
                                                                        className={`glass-input w-full px-2 py-1.5 text-xs font-bold rounded-lg ${!r.extraPerParcel && 'opacity-50 bg-gray-200/50 dark:bg-gray-800/50 text-gray-400'}`}
                                                                        type="number"
                                                                        step="0.01"
                                                                        placeholder="-"
                                                                        value={r.extraPerParcel || ''}
                                                                        onChange={(e) => { const val = parseFloat(e.target.value); setCourierRules(prev => prev.map((pr, pi) => pi === i ? { ...pr, extraPerParcel: val } : pr)); }}
                                                                    />
                                                                </div>
                                                            </div>

                                                            {/* Constraints */}
                                                            <div className="p-3 bg-white dark:bg-gray-900/40 rounded-lg border border-gray-100 dark:border-gray-800/50">
                                                                <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                                                                    <span>Max Constraints</span>
                                                                    <div className="h-px flex-1 bg-gray-100 dark:bg-gray-800"></div>
                                                                </div>
                                                                <div className="grid grid-cols-3 gap-2">
                                                                    <div>
                                                                        <label className="text-[9px] uppercase text-gray-400 font-semibold mb-1 block">Weight (kg)</label>
                                                                        <input className="glass-input w-full px-2 py-1.5 text-xs rounded-md" type="number" value={r.maxWeight || ''} onChange={(e) => { const val = parseFloat(e.target.value); setCourierRules(prev => prev.map((pr, pi) => pi === i ? { ...pr, maxWeight: val } : pr)); }} />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[9px] uppercase text-gray-400 font-semibold mb-1 block">Length (cm)</label>
                                                                        <input className="glass-input w-full px-2 py-1.5 text-xs rounded-md" type="number" value={r.maxL || ''} onChange={(e) => { const val = parseFloat(e.target.value); setCourierRules(prev => prev.map((pr, pi) => pi === i ? { ...pr, maxL: val } : pr)); }} />
                                                                    </div>
                                                                    <div>
                                                                        <label className={`text-[9px] uppercase font-semibold mb-1 block ${r.maxGirth ? 'text-gray-500' : 'text-gray-300'}`}>Girth</label>
                                                                        <input className={`glass-input w-full px-2 py-1.5 text-xs rounded-md ${!r.maxGirth && 'opacity-40 bg-gray-100 dark:bg-gray-800'}`} type="number" placeholder="-" value={r.maxGirth || ''} onChange={(e) => { const val = parseFloat(e.target.value); setCourierRules(prev => prev.map((pr, pi) => pi === i ? { ...pr, maxGirth: val } : pr)); }} />
                                                                    </div>
                                                                </div>
                                                                <div className="grid grid-cols-2 gap-2 mt-2 pt-2 border-t border-dashed border-gray-200 dark:border-gray-800">
                                                                    <div>
                                                                        <label className={`text-[9px] uppercase font-semibold mb-1 block ${r.maxVol ? 'text-gray-400' : 'text-gray-300'}`}>Max Vol</label>
                                                                        <input className={`glass-input w-full px-2 py-1.5 text-xs rounded-md ${!r.maxVol && 'opacity-40 bg-gray-100 dark:bg-gray-800'}`} type="number" placeholder="-" value={r.maxVol || ''} onChange={(e) => { const val = parseFloat(e.target.value); setCourierRules(prev => prev.map((pr, pi) => pi === i ? { ...pr, maxVol: val } : pr)); }} />
                                                                    </div>
                                                                    <div>
                                                                        <label className={`text-[9px] uppercase font-semibold mb-1 block ${r.minVol ? 'text-gray-400' : 'text-gray-300'}`}>Min Vol</label>
                                                                        <input className={`glass-input w-full px-2 py-1.5 text-xs rounded-md ${!r.minVol && 'opacity-40 bg-gray-100 dark:bg-gray-800'}`} type="number" placeholder="-" value={r.minVol || ''} onChange={(e) => { const val = parseFloat(e.target.value); setCourierRules(prev => prev.map((pr, pi) => pi === i ? { ...pr, minVol: val } : pr)); }} />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </details>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Collapsible Shipping Logic Summary */}
                                        <details className="pt-4 border-t border-gray-200 dark:border-gray-700">
                                            <summary className="text-sm font-medium text-gray-500 cursor-pointer hover:text-gray-700 dark:hover:text-gray-300">How shipping is calculated</summary>
                                            <div className="mt-3 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                                <p>Weight: 2kg, 15kg, 17kg, 30kg limits</p>
                                                <p>Girth: L+2W+2H (max 225-380cm)</p>
                                                <p>Length: 90-200cm per courier</p>
                                                <p>Vol weight: 1kg = 5000cm</p>
                                            </div>
                                        </details>
                                    </div>
                                </div>
                            </div>
                        )
                    }
                </div >
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ThemeProvider><Calculator /></ThemeProvider>);
    </script>
</head>

<body>
    <div id="root"></div>
</body>

</html>